<!doctype html><html lang="zh-CN"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><title>VTT 地图查看器</title><script type="module">import{Fragment as e,computed as t,createApp as a,createCommentVNode as n,createElementBlock as l,createElementVNode as o,createTextVNode as i,createVNode as s,defineComponent as r,onMounted as u,onUnmounted as d,openBlock as c,ref as p,renderList as v,toDisplayString as f,vModelText as m,watch as g,withDirectives as h}from'https://testingcf.jsdelivr.net/npm/vue/+esm';import{gsap as b}from'https://testingcf.jsdelivr.net/npm/gsap/+esm';import{Application as k,Assets as w,Container as y,Graphics as x,Sprite as C,Text as T}from'https://testingcf.jsdelivr.net/npm/pixi.js/+esm';import{default as D}from'https://testingcf.jsdelivr.net/npm/lodash/+esm';import{z as S}from'https://testingcf.jsdelivr.net/npm/zod/+esm';var V={42:(e,t)=>{t.A=(e,t)=>{const a=e.__vccOpts||e;for(const[e,n]of t)a[e]=n;return a}}},M={};const E={class:'map-controls'},O={key:0,class:'token-info'},j=r({__name:'MapCanvas',props:{mapData:{},tokens:{}},emits:['tokenMove','tokenSelect'],setup(e,{emit:t}){const a=e,i=t,s=p(),r=p(),v=p(!0),m=p(a.mapData.fogOfWar.enabled),h=p(!a.mapData.globalLight),D=p(!0),S=p(null);let V=null,M=null,j=null,U=null,I=null,A=null,N=null,L=null;const J=p({x:0,y:0,scale:1}),{isLineBlocked:R,calculateFOVShadowCasting:W}=function(){function e(e,a,n,l,o){for(const i of o){if(0===i.sense)continue;if(i.door>0&&1===i.ds)continue;const[o,s,r,u]=i.c;if(t(e,a,n,l,o,s,r,u))return!0}return!1}function t(e,t,a,n,l,o,i,s){const r=(s-o)*(a-e)-(i-l)*(n-t);if(Math.abs(r)<1e-10)return!1;const u=((i-l)*(t-o)-(s-o)*(e-l))/r,d=((a-e)*(t-o)-(n-t)*(e-l))/r;return u>=0&&u<=1&&d>=0&&d<=1}function a(e,t,l,o,i,s,r,u,d,c,p,v,f){if(i<s)return;let m=i;for(let g=o;g<=l;g++){let o=!1;for(let h=-g;h<=0;h++){const b=-g,k=(h-.5)/(b+.5),w=(h+.5)/(b-.5);if(i<w)continue;if(s>k)break;const y=e+h*r+b*u,x=t+h*d+b*c;if(Math.abs(y-e)+Math.abs(x-t)<=l&&f.add(`${y},${x}`),o){if(n(y,x,p,v)){m=w;continue}o=!1,i=m}else n(y,x,p,v)&&g<l&&(o=!0,a(e,t,l,g+1,i,k,r,u,d,c,p,v,f),m=w)}if(o)break}}function n(e,t,a,n){const l=e*n+n/2,o=t*n+n/2;for(const e of a){if(0===e.sense)continue;if(e.door>0&&1===e.ds)continue;const[t,a,n,i]=e.c,s=Math.min(t,n),r=Math.max(t,n),u=Math.min(a,i),d=Math.max(a,i);if(l>=s&&l<=r&&o>=u&&o<=d)return!0}return!1}return{isLineBlocked:e,calculateVisibleArea:function(t,a,n){const l=[],o=t.x,i=t.y,s=t.vision*n;if(s<=0)return l;const r=2*Math.PI/360;for(let t=0;t<360;t++){const u=t*r,d=Math.cos(u),c=Math.sin(u);for(let t=0;t<=s;t+=n/2){const s=o+d*t,r=i+c*t;if(e(o,i,s,r,a))break;const u=Math.floor(s/n),p=Math.floor(r/n);l.some(e=>e.x===u&&e.y===p)||l.push({x:u,y:p})}}return l},calculateFOVShadowCasting:function(e,t,n,l,o){const i=new Set,s=Math.floor(e/o),r=Math.floor(t/o);i.add(`${s},${r}`);const u=[[1,0],[1,1],[0,1],[-1,1],[-1,0],[-1,-1],[0,-1],[1,-1]];for(const[e,t]of u)a(s,r,n,1,1,0,e,t,0,0,l,o,i);return i}}}();function Y(){if(!U)return;if(U.clear(),!v.value)return;const{width:e,height:t,grid:n,gridColor:l,gridAlpha:o}=a.mapData;U.lineStyle(1,parseInt(l.replace('#','0x')),o);for(let a=0;a<=e;a+=n)U.moveTo(a,0),U.lineTo(a,t);for(let a=0;a<=t;a+=n)U.moveTo(0,a),U.lineTo(e,a);U.stroke()}function B(){if(A&&(A.removeChildren(),h.value))for(const e of a.mapData.lights){const t=new x,n=e.dim*a.mapData.grid,l=e.bright*a.mapData.grid,o=parseInt(e.tintColor.replace('#','0x'));n>0&&(t.circle(e.x,e.y,n),t.fill({color:o,alpha:.2*e.tintAlpha})),l>0&&(t.circle(e.x,e.y,l),t.fill({color:o,alpha:.5*e.tintAlpha})),t.circle(e.x,e.y,5),t.fill({color:16776960,alpha:.8}),A.addChild(t),b.to(t,{alpha:.7,duration:1+Math.random(),repeat:-1,yoyo:!0,ease:'power1.inOut'})}}function F(){if(!N)return;N.removeChildren();const e=a.tokens||a.mapData.tokens||[];for(const t of e){const e=new x,n=t.width*a.mapData.grid,l=t.x,o=t.y;e.circle(l,o,n/2),e.fill({color:65280,alpha:.6}),e.stroke({width:2,color:16777215});const s=new T({text:t.name,style:{fontSize:12,fill:16777215,stroke:{color:0,width:2}}});s.anchor.set(.5),s.x=l,s.y=o+n/2+10,e.addChild(s),e.eventMode='static',e.cursor='pointer';let r=!1,u=null;e.on('pointerdown',e=>{r=!0;const a=e.global;u={x:a.x-l,y:a.y-o},S.value=t,i('tokenSelect',t)}),e.on('pointerup',()=>{r=!1,u=null}),e.on('pointermove',a=>{if(r&&u){const n=a.global,s=n.x-u.x,r=n.y-u.y;e.x=s-l,e.y=r-o,i('tokenMove',t,s,r)}}),N.addChild(e)}}function X(){if(!L)return;if(L.clear(),!m.value)return;L.rect(0,0,a.mapData.width,a.mapData.height),L.fill({color:0,alpha:.8});const e=a.tokens||a.mapData.tokens||[];for(const t of e){if(t.vision<=0)continue;const e=W(t.x,t.y,t.vision,a.mapData.walls,a.mapData.grid);for(const t of e){const[e,n]=t.split(',').map(Number),l=e*a.mapData.grid,o=n*a.mapData.grid;L.rect(l,o,a.mapData.grid,a.mapData.grid),L.fill({color:0,alpha:-1})}}}function P(){J.value.scale*=1.2,b.to(V.stage.scale,{x:J.value.scale,y:J.value.scale,duration:.3})}function H(){J.value.scale*=.8,b.to(V.stage.scale,{x:J.value.scale,y:J.value.scale,duration:.3})}function G(){J.value={x:0,y:0,scale:1},b.to(V.stage,{x:0,y:0,duration:.5}),b.to(V.stage.scale,{x:1,y:1,duration:.5})}function q(){v.value=!v.value,Y()}function K(){m.value=!m.value,X()}function Q(){h.value=!h.value,B()}function Z(){D.value=!D.value,j&&(j.visible=D.value)}return u(async()=>{if(!s.value||!r.value)return;V=new k,await V.init({canvas:r.value,width:s.value.clientWidth,height:s.value.clientHeight,backgroundColor:a.mapData.backgroundColor||'#000000',antialias:!0});const e=new y,t=new y,n=new y;A=new y,N=new y;const l=new y,o=new y;if(V.stage.addChild(e),V.stage.addChild(t),V.stage.addChild(n),V.stage.addChild(A),V.stage.addChild(N),V.stage.addChild(l),V.stage.addChild(o),a.mapData.img){const t=await w.load(a.mapData.img);M=new C(t),M.width=a.mapData.width,M.height=a.mapData.height,e.addChild(M)}if(a.mapData.foreground){const e=await w.load(a.mapData.foreground);j=new C(e),j.width=a.mapData.width,j.height=a.mapData.height,l.addChild(j),toastr.info('已加载前景层 (遮挡物)')}U=new x,t.addChild(U),Y(),I=new x,n.addChild(I),function(){if(!I)return;I.clear();for(const e of a.mapData.walls){const[t,a,n,l]=e.c;let o=16777215,i=.8,s=3;1===e.door?(o=9127187,s=1===e.ds?2:4):2===e.door&&(o=9662683,i=.5),0===e.sense&&(o=4286945,i=.4),I.lineStyle(s,o,i),I.moveTo(t,a),I.lineTo(n,l)}I.stroke()}(),B(),F(),L=new x,o.addChild(L),m.value&&X(),function(){if(!V)return;let e=!1,t={x:0,y:0};V.stage.eventMode='static',V.stage.on('pointerdown',a=>{a.target===V?.stage&&(e=!0,t={x:a.globalX,y:a.globalY})}),V.stage.on('pointerup',()=>{e=!1}),V.stage.on('pointermove',a=>{if(e){const e=a.globalX-t.x,n=a.globalY-t.y;V.stage.x+=e,V.stage.y+=n,t={x:a.globalX,y:a.globalY}}}),r.value?.addEventListener('wheel',e=>{e.preventDefault();const t=e.deltaY>0?.9:1.1,a=J.value.scale*t;a>=.1&&a<=5&&(J.value.scale=a,b.to(V.stage.scale,{x:a,y:a,duration:.2,ease:'power2.out'}))})}();const i=new ResizeObserver(()=>{V&&s.value&&V.renderer.resize(s.value.clientWidth,s.value.clientHeight)});i.observe(s.value),d(()=>{i.disconnect()})}),g(()=>a.tokens,()=>{F(),m.value&&X()},{deep:!0}),d(()=>{V?.destroy(!0)}),(e,t)=>(c(),l('div',{class:'map-canvas-container',ref_key:'containerRef',ref:s},[o('canvas',{ref_key:'canvasRef',ref:r},null,512),n(' 控制面板 '),o('div',E,[o('button',{onClick:P,title:'放大'},[...t[1]||(t[1]=[o('span',null,'🔍+',-1)])]),o('button',{onClick:H,title:'缩小'},[...t[2]||(t[2]=[o('span',null,'🔍-',-1)])]),o('button',{onClick:G,title:'重置视图'},[...t[3]||(t[3]=[o('span',null,'🏠',-1)])]),o('button',{onClick:q,title:'显示/隐藏网格'},[o('span',null,f(v.value?'⊞':'⊟'),1)]),o('button',{onClick:K,title:'战争迷雾'},[o('span',null,f(m.value?'🌫️':'☀️'),1)]),o('button',{onClick:Q,title:'光照系统'},[o('span',null,f(h.value?'💡':'🔦'),1)]),a.mapData.foreground?(c(),l('button',{key:0,onClick:Z,title:'显示/隐藏前景层'},[o('span',null,f(D.value?'🏠':'🏚️'),1)])):n('v-if',!0)]),n(' Token 信息面板 '),S.value?(c(),l('div',O,[o('h3',null,f(S.value.name),1),o('p',null,'位置: ('+f(Math.floor(S.value.x))+', '+f(Math.floor(S.value.y))+')',1),o('p',null,'视野: '+f(S.value.vision)+' 格',1),o('button',{onClick:t[0]||(t[0]=e=>S.value=null)},'关闭')])):n('v-if',!0)],512))}});var U=function e(t){var a=M[t];if(void 0!==a)return a.exports;var n=M[t]={exports:{}};return V[t](n,n.exports,e),n.exports}(42);const I=(0,U.A)(j,[['__scopeId','data-v-6d3eac8c']]),A=S.object({x:S.number(),y:S.number(),dim:S.number().default(0),bright:S.number().default(0),tintColor:S.string().default('#ffffff'),tintAlpha:S.number().min(0).max(1).default(.5),animation:S.object({type:S.string().optional(),speed:S.number().optional(),intensity:S.number().optional()}).optional()}),N=S.object({c:S.tuple([S.number(),S.number(),S.number(),S.number()]),move:S.union([S.literal(0),S.literal(1)]).default(1),sense:S.union([S.literal(0),S.literal(1)]).default(1),sound:S.union([S.literal(0),S.literal(1)]).default(1),door:S.union([S.literal(0),S.literal(1),S.literal(2)]).default(0),ds:S.union([S.literal(0),S.literal(1)]).optional()}),L=S.object({id:S.string(),name:S.string().default('未命名'),x:S.number(),y:S.number(),width:S.number().default(1),height:S.number().default(1),img:S.string().optional(),vision:S.number().default(0),dimVision:S.number().default(0),rotation:S.number().default(0),hidden:S.boolean().default(!1),elevation:S.number().default(0)}),J=S.object({name:S.string().default('未命名地图'),width:S.number().positive(),height:S.number().positive(),grid:S.number().positive().default(100),shiftX:S.number().default(0),shiftY:S.number().default(0),gridDistance:S.number().positive().default(5),gridUnits:S.string().default('ft'),padding:S.number().default(0),gridColor:S.string().default('#000000'),gridAlpha:S.number().min(0).max(1).default(.2),globalLight:S.boolean().default(!0),darkness:S.number().min(0).max(1).default(0),backgroundColor:S.string().default('#000000'),img:S.string().nullable().optional(),foreground:S.string().nullable().optional(),lights:S.array(A).default([]),walls:S.array(N).default([]),tokens:S.array(L).default([]),fogOfWar:S.object({enabled:S.boolean().default(!1),explored:S.array(S.array(S.boolean())).optional()}).default({enabled:!1})}),R=S.object({mapId:S.string(),tokens:S.array(L),fogExplored:S.array(S.array(S.boolean())).optional(),viewport:S.object({x:S.number().default(0),y:S.number().default(0),scale:S.number().default(1)}).default({})});function W(e){const t=t=>{try{const a=`vtt_map_${e}`,n=D.cloneDeep(t);replaceVariables({[a]:n},{type:'chat'})}catch(e){console.error('保存地图状态失败:',e)}},a=p((()=>{try{const t=getVariables({type:'chat'}),a=`vtt_map_${e}`;if(t[a])return R.parse(t[a])}catch(e){console.warn('加载地图状态失败:',e)}return{mapId:e,tokens:[],viewport:{x:0,y:0,scale:1}}})()),n=D.debounce(e=>{t(e)},1e3);g(a,e=>{n(e)},{deep:!0});return{state:a,updateTokenPosition:(e,t,n)=>{const l=a.value.tokens.find(t=>t.id===e);l&&(l.x=t,l.y=n)},addToken:e=>{a.value.tokens.find(t=>t.id===e.id)||a.value.tokens.push(e)},removeToken:e=>{const t=a.value.tokens.findIndex(t=>t.id===e);-1!==t&&a.value.tokens.splice(t,1)},updateViewport:(e,t,n)=>{a.value.viewport={x:e,y:t,scale:n}},markExplored:(e,t)=>{a.value.fogExplored||(a.value.fogExplored=[]),a.value.fogExplored[t]||(a.value.fogExplored[t]=[]),a.value.fogExplored[t][e]=!0},isExplored:(e,t)=>a.value.fogExplored?.[t]?.[e]??!1,saveState:()=>t(a.value)}}const Y={class:'vtt-viewer'},B={key:0,class:'loading'},F={key:1,class:'error'},X={class:'error-actions'},P={key:2,class:'upload-dialog'},H={class:'upload-content'},G={class:'upload-actions'},q={class:'toolbar'},K={class:'toolbar-actions'},Q={class:'map-wrapper'},Z={key:0,class:'side-panel token-manager'},ee={class:'panel-header'},te={class:'panel-content'},ae={class:'token-header'},ne=['onClick'],le={class:'token-details'},oe=['onUpdate:modelValue'],ie=['onUpdate:modelValue'],se=['onUpdate:modelValue'],re=['onUpdate:modelValue'],ue=['onUpdate:modelValue'],de={key:1,class:'side-panel map-info'},ce={class:'panel-header'},pe={class:'panel-content'},ve={class:'info-item'},fe={class:'info-item'},me={class:'info-item'},ge={class:'info-item'},he={class:'info-item'},be={class:'info-item'},ke={class:'info-item'},we=r({__name:'App',setup(a){const r=p(!0),d=p(null),g=p(null),b=p(!1),k=p(!1),w=p(!1),y=p(''),x=p(null),C=t(()=>x.value?x.value.state.value.tokens:g.value?.tokens||[]);function T(){const e={name:'示例地图',width:3e3,height:2e3,grid:100,gridDistance:5,gridUnits:'ft',backgroundColor:'#1a1a1a',globalLight:!1,darkness:.5,img:null,foreground:null,lights:[{x:500,y:500,dim:8,bright:4,tintColor:'#ffaa00',tintAlpha:.5},{x:1500,y:1e3,dim:10,bright:5,tintColor:'#ffffff',tintAlpha:.8}],walls:[{c:[0,0,3e3,0],move:1,sense:1,sound:1,door:0},{c:[3e3,0,3e3,2e3],move:1,sense:1,sound:1,door:0},{c:[3e3,2e3,0,2e3],move:1,sense:1,sound:1,door:0},{c:[0,2e3,0,0],move:1,sense:1,sound:1,door:0}],tokens:[{id:'token1',name:'玩家',x:500,y:500,width:1,vision:12}],fogOfWar:{enabled:!1}};try{const t=J.parse(e);g.value=t,x.value=W(t.name),0===x.value.state.value.tokens.length&&t.tokens.length>0&&t.tokens.forEach(e=>x.value?.addToken(e)),d.value=null,r.value=!1,w.value=!1,toastr.success('示例地图加载成功')}catch(e){d.value=e instanceof Error?e.message:String(e),toastr.error('示例地图加载失败: '+d.value)}}function D(e){const t=e.target.files?.[0];if(!t)return;const a=new FileReader;a.onload=e=>{y.value=e.target?.result},a.readAsText(t)}function S(){try{const e=JSON.parse(y.value),t=J.parse(e);g.value=t,x.value=W(t.name),0===x.value.state.value.tokens.length&&t.tokens.length>0&&t.tokens.forEach(e=>x.value?.addToken(e));const a=getVariables({type:'script',script_id:getScriptId()});a.vtt_map_data=t,replaceVariables(a,{type:'script',script_id:getScriptId()}),d.value=null,r.value=!1,w.value=!1,y.value='',toastr.success(`地图 "${t.name}" 加载成功`)}catch(e){toastr.error('JSON 解析失败: '+(e instanceof Error?e.message:String(e)))}}async function V(){r.value=!0,d.value=null;try{const e=getVariables({type:'script',script_id:getScriptId()});if(!e.vtt_map_url&&!e.vtt_map_data)throw new Error('未配置地图数据。请在脚本变量中设置 vtt_map_url 或 vtt_map_data');let t;if(e.vtt_map_url){const a=await fetch(e.vtt_map_url);t=await a.json()}else t=e.vtt_map_data;const a=J.parse(t);g.value=a,x.value=W(a.name),0===x.value.state.value.tokens.length&&a.tokens.length>0&&a.tokens.forEach(e=>{x.value?.addToken(e)}),toastr.success(`地图 "${a.name}" 加载成功`)}catch(e){d.value=e instanceof Error?e.message:String(e),toastr.error('地图加载失败: '+d.value)}finally{r.value=!1}}function M(e,t,a){x.value?.updateTokenPosition(e.id,t,a)}function E(e){console.log('选中 Token:',e)}function O(){if(!x.value||!g.value)return;const e=L.parse({id:`token_${Date.now()}`,name:`Token ${C.value.length+1}`,x:g.value.width/2,y:g.value.height/2,width:1,height:1,vision:12});x.value.addToken(e),toastr.success(`添加了新的 Token: ${e.name}`)}function j(){if(!x.value)return;const e=x.value.state.value,t=JSON.stringify(e,null,2);navigator.clipboard.writeText(t).then(()=>{toastr.success('状态已复制到剪贴板')}).catch(()=>{const e=new Blob([t],{type:'application/json'}),a=URL.createObjectURL(e),n=document.createElement('a');n.href=a,n.download=`${g.value?.name}_state.json`,n.click(),URL.revokeObjectURL(a)})}function U(){const e=prompt('请粘贴地图状态 JSON:');if(e)try{const t=JSON.parse(e);replaceVariables({[`vtt_map_${g.value?.name}`]:t},{type:'chat'}),toastr.success('状态导入成功,正在重新加载...'),setTimeout(()=>location.reload(),1e3)}catch(e){toastr.error('导入失败: '+(e instanceof Error?e.message:String(e)))}}return u(()=>{V()}),(t,a)=>(c(),l('div',Y,[r.value?(c(),l('div',B,[...a[7]||(a[7]=[o('div',{class:'spinner'},null,-1),o('p',null,'加载地图中...',-1)])])):d.value?(c(),l('div',F,[a[8]||(a[8]=o('h2',null,'❌ 加载失败',-1)),o('pre',null,f(d.value),1),o('div',X,[o('button',{onClick:V},'重试'),o('button',{onClick:a[0]||(a[0]=e=>w.value=!0)},'📁 上传地图 JSON'),o('button',{onClick:T},'🎲 加载示例地图')])])):n('v-if',!0),n(' 上传对话框 '),w.value?(c(),l('div',P,[o('div',H,[a[9]||(a[9]=o('h3',null,'上传地图 JSON 文件',-1)),o('input',{type:'file',accept:'.json',onChange:D},null,32),a[10]||(a[10]=o('p',{class:'upload-hint'},'或粘贴 JSON 内容:',-1)),h(o('textarea',{'onUpdate:modelValue':a[1]||(a[1]=e=>y.value=e),placeholder:'粘贴 VTT 地图 JSON...',rows:'10'},null,512),[[m,y.value]]),o('div',G,[o('button',{onClick:S},'加载'),o('button',{onClick:a[2]||(a[2]=e=>w.value=!1)},'取消')])])])):g.value?(c(),l(e,{key:3},[n(' 顶部工具栏 '),o('div',q,[o('h2',null,f(g.value.name),1),o('div',K,[o('button',{onClick:a[3]||(a[3]=e=>b.value=!b.value)},'🎭 Token 管理'),o('button',{onClick:a[4]||(a[4]=e=>k.value=!k.value)},'ℹ️ 地图信息'),o('button',{onClick:j},'💾 导出状态'),o('button',{onClick:U},'📁 导入状态')])]),n(' 地图画布 '),o('div',Q,[s(I,{'map-data':g.value,tokens:C.value,onTokenMove:M,onTokenSelect:E},null,8,['map-data','tokens'])]),n(' Token 管理面板 '),b.value?(c(),l('div',Z,[o('div',ee,[a[11]||(a[11]=o('h3',null,'Token 管理',-1)),o('button',{onClick:a[5]||(a[5]=e=>b.value=!1)},'✖')]),o('div',te,[o('button',{onClick:O,class:'add-token-btn'},'➕ 添加 Token'),(c(!0),l(e,null,v(C.value,e=>(c(),l('div',{key:e.id,class:'token-item'},[o('div',ae,[o('strong',null,f(e.name),1),o('button',{onClick:t=>{return a=e.id,void(x.value&&confirm('确定要删除这个 Token 吗?')&&(x.value.removeToken(a),toastr.success('Token 已删除')));var a},class:'delete-btn'},'🗑️',8,ne)]),o('div',le,[o('label',null,[a[12]||(a[12]=i(' 名称: ',-1)),h(o('input',{'onUpdate:modelValue':t=>e.name=t,type:'text'},null,8,oe),[[m,e.name]])]),o('label',null,[a[13]||(a[13]=i(' X: ',-1)),h(o('input',{'onUpdate:modelValue':t=>e.x=t,type:'number',step:'10'},null,8,ie),[[m,e.x,void 0,{number:!0}]])]),o('label',null,[a[14]||(a[14]=i(' Y: ',-1)),h(o('input',{'onUpdate:modelValue':t=>e.y=t,type:'number',step:'10'},null,8,se),[[m,e.y,void 0,{number:!0}]])]),o('label',null,[a[15]||(a[15]=i(' 视野范围: ',-1)),h(o('input',{'onUpdate:modelValue':t=>e.vision=t,type:'number',min:'0',max:'100'},null,8,re),[[m,e.vision,void 0,{number:!0}]])]),o('label',null,[a[16]||(a[16]=i(' 尺寸: ',-1)),h(o('input',{'onUpdate:modelValue':t=>e.width=t,type:'number',min:'1',max:'10'},null,8,ue),[[m,e.width,void 0,{number:!0}]])])])]))),128))])])):n('v-if',!0),n(' 地图信息面板 '),k.value?(c(),l('div',de,[o('div',ce,[a[17]||(a[17]=o('h3',null,'地图信息',-1)),o('button',{onClick:a[6]||(a[6]=e=>k.value=!1)},'✖')]),o('div',pe,[o('div',ve,[a[18]||(a[18]=o('label',null,'地图名称:',-1)),o('span',null,f(g.value.name),1)]),o('div',fe,[a[19]||(a[19]=o('label',null,'尺寸:',-1)),o('span',null,f(g.value.width)+' × '+f(g.value.height)+' px',1)]),o('div',me,[a[20]||(a[20]=o('label',null,'网格:',-1)),o('span',null,f(g.value.grid)+' px ('+f(g.value.gridDistance)+' '+f(g.value.gridUnits)+')',1)]),o('div',ge,[a[21]||(a[21]=o('label',null,'光源数量:',-1)),o('span',null,f(g.value.lights.length),1)]),o('div',he,[a[22]||(a[22]=o('label',null,'墙壁数量:',-1)),o('span',null,f(g.value.walls.length),1)]),o('div',be,[a[23]||(a[23]=o('label',null,'全局光照:',-1)),o('span',null,f(g.value.globalLight?'是':'否'),1)]),o('div',ke,[a[24]||(a[24]=o('label',null,'黑暗等级:',-1)),o('span',null,f((100*g.value.darkness).toFixed(0))+'%',1)])])])):n('v-if',!0)],64)):n('v-if',!0)]))}}),ye=(0,U.A)(we,[['__scopeId','data-v-d2e5b7e4']]);'undefined'!=typeof window&&'function'==typeof window.getScriptId||(void 0===window.$&&(window.$=e=>('function'==typeof e&&('loading'===document.readyState?document.addEventListener('DOMContentLoaded',e):e()),{on:()=>{}}),window.$.fn={}),void 0===window.toastr&&(window.toastr={success:e=>console.log('[Success]',e),error:e=>console.error('[Error]',e),info:e=>console.info('[Info]',e),warning:e=>console.warn('[Warning]',e)}),void 0===window.getScriptId&&(window.getScriptId=()=>'standalone-vtt-viewer',window.getVariables=e=>{const t='script'===e?.type?'vtt_script_vars':'vtt_chat_vars',a=localStorage.getItem(t);return a?JSON.parse(a):{}},window.replaceVariables=(e,t)=>{const a='script'===t?.type?'vtt_script_vars':'vtt_chat_vars',n={...window.getVariables(t),...e};localStorage.setItem(a,JSON.stringify(n))}));const $=window.$,xe=window.toastr;$(()=>{a(ye).mount('#app'),xe.success('VTT 地图查看器已加载')}),$(window).on('pagehide',()=>{xe.info('VTT 地图查看器已卸载')});</script><style>.map-canvas-container[data-v-6d3eac8c]{position:relative;width:100%;height:100%;overflow:hidden;background:#1a1a1a}canvas[data-v-6d3eac8c]{display:block;width:100%;height:100%}.map-controls[data-v-6d3eac8c]{position:absolute;top:10px;right:10px;display:flex;flex-direction:column;gap:5px;z-index:10}.map-controls button[data-v-6d3eac8c]{width:40px;height:40px;border:none;background:rgba(0,0,0,0.7);color:white;border-radius:5px;cursor:pointer;font-size:18px;transition:background 0.2s}.map-controls button[data-v-6d3eac8c]:hover{background:rgba(0,0,0,0.9)}.token-info[data-v-6d3eac8c]{position:absolute;bottom:10px;left:10px;background:rgba(0,0,0,0.8);color:white;padding:15px;border-radius:8px;min-width:200px;z-index:10}.token-info h3[data-v-6d3eac8c]{margin:0 0 10px 0;font-size:16px}.token-info p[data-v-6d3eac8c]{margin:5px 0;font-size:14px}.token-info button[data-v-6d3eac8c]{margin-top:10px;padding:5px 10px;background:#4caf50;border:none;color:white;border-radius:4px;cursor:pointer}.token-info button[data-v-6d3eac8c]:hover{background:#45a049}

.vtt-viewer[data-v-d2e5b7e4]{width:100%;height:100vh;display:flex;flex-direction:column;background:#1a1a1a;color:white;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif}.loading[data-v-d2e5b7e4],.error[data-v-d2e5b7e4]{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;gap:20px}.spinner[data-v-d2e5b7e4]{width:50px;height:50px;border:4px solid rgba(255,255,255,0.3);border-top-color:white;border-radius:50%;animation:spin-d2e5b7e4 1s linear infinite}@keyframes spin-d2e5b7e4{to{transform:rotate(360deg)}}.error pre[data-v-d2e5b7e4]{background:rgba(255,0,0,0.2);padding:15px;border-radius:5px;max-width:600px}.error-actions[data-v-d2e5b7e4]{display:flex;gap:10px}.error button[data-v-d2e5b7e4]{padding:10px 20px;background:#4caf50;border:none;color:white;border-radius:5px;cursor:pointer;transition:background 0.3s}.error button[data-v-d2e5b7e4]:hover{background:#66bb6a}.upload-dialog[data-v-d2e5b7e4]{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);display:flex;align-items:center;justify-content:center;z-index:1000}.upload-content[data-v-d2e5b7e4]{background:#2a2a2a;padding:30px;border-radius:10px;max-width:600px;width:90%}.upload-content h3[data-v-d2e5b7e4]{margin-top:0}.upload-content input[type='file'][data-v-d2e5b7e4]{width:100%;padding:10px;margin:10px 0;background:#1a1a1a;border:2px dashed #666;border-radius:5px;color:white;cursor:pointer}.upload-hint[data-v-d2e5b7e4]{margin:20px 0 10px;color:#aaa}.upload-content textarea[data-v-d2e5b7e4]{width:100%;padding:10px;background:#1a1a1a;border:1px solid #666;border-radius:5px;color:white;font-family:monospace;resize:vertical}.upload-actions[data-v-d2e5b7e4]{display:flex;gap:10px;margin-top:20px;justify-content:flex-end}.upload-actions button[data-v-d2e5b7e4]{padding:10px 20px;background:#4caf50;border:none;color:white;border-radius:5px;cursor:pointer}.upload-actions button[data-v-d2e5b7e4]:last-child{background:#666}.upload-actions button[data-v-d2e5b7e4]:hover{opacity:0.8}.toolbar[data-v-d2e5b7e4]{display:flex;justify-content:space-between;align-items:center;padding:10px 20px;background:rgba(0,0,0,0.8);border-bottom:2px solid #333}.toolbar h2[data-v-d2e5b7e4]{margin:0;font-size:20px}.toolbar-actions[data-v-d2e5b7e4]{display:flex;gap:10px}.toolbar-actions button[data-v-d2e5b7e4]{padding:8px 15px;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.3);color:white;border-radius:5px;cursor:pointer;transition:background 0.2s}.toolbar-actions button[data-v-d2e5b7e4]:hover{background:rgba(255,255,255,0.2)}.map-wrapper[data-v-d2e5b7e4]{flex:1;position:relative}.side-panel[data-v-d2e5b7e4]{position:absolute;top:60px;right:10px;width:300px;max-height:calc(100vh - 80px);background:rgba(0,0,0,0.9);border:1px solid #333;border-radius:8px;overflow:hidden;display:flex;flex-direction:column;z-index:100}.panel-header[data-v-d2e5b7e4]{display:flex;justify-content:space-between;align-items:center;padding:15px;background:rgba(255,255,255,0.1);border-bottom:1px solid #333}.panel-header h3[data-v-d2e5b7e4]{margin:0;font-size:16px}.panel-header button[data-v-d2e5b7e4]{background:none;border:none;color:white;font-size:18px;cursor:pointer}.panel-content[data-v-d2e5b7e4]{flex:1;overflow-y:auto;padding:15px}.add-token-btn[data-v-d2e5b7e4]{width:100%;padding:10px;background:#4caf50;border:none;color:white;border-radius:5px;cursor:pointer;margin-bottom:15px}.token-item[data-v-d2e5b7e4]{background:rgba(255,255,255,0.05);padding:10px;border-radius:5px;margin-bottom:10px}.token-header[data-v-d2e5b7e4]{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}.delete-btn[data-v-d2e5b7e4]{background:rgba(255,0,0,0.3);border:none;color:white;padding:4px 8px;border-radius:3px;cursor:pointer}.token-details[data-v-d2e5b7e4]{display:flex;flex-direction:column;gap:8px}.token-details label[data-v-d2e5b7e4]{display:flex;justify-content:space-between;align-items:center;font-size:14px}.token-details input[data-v-d2e5b7e4]{width:120px;padding:4px 8px;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.3);color:white;border-radius:3px}.info-item[data-v-d2e5b7e4]{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid rgba(255,255,255,0.1)}.info-item label[data-v-d2e5b7e4]{font-weight:bold}

</style></head><body><div id="app"></div></body></html>