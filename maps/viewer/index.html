<!doctype html><html lang="zh-CN"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><title>VTT 地图查看器</title><script src="https://cdn.jsdelivr.net/npm/vue@3.5.13/dist/vue.global.prod.js"></script><script src="https://cdn.jsdelivr.net/npm/pixi.js@8.5.2/dist/pixi.min.js"></script><script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"></script><script src="https://cdn.jsdelivr.net/npm/zod@3.24.1/lib/index.umd.js"></script><script src="https://cdn.jsdelivr.net/npm/toastr@2.1.4/toastr.min.js"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastr@2.1.4/build/toastr.min.css"/><script type="module">import{gsap as e}from'https://testingcf.jsdelivr.net/npm/gsap/+esm';var t={42:(e,t)=>{t.A=(e,t)=>{const a=e.__vccOpts||e;for(const[e,n]of t)a[e]=n;return a}}},a={};function n(e){var o=a[e];if(void 0!==o)return o.exports;var l=a[e]={exports:{}};return t[e](l,l.exports,n),l.exports}n.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return n.d(t,{a:t}),t},n.d=(e,t)=>{for(var a in t)n.o(t,a)&&!n.o(e,a)&&Object.defineProperty(e,a,{enumerable:!0,get:t[a]})},n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t);const o=Vue,l=PIXI;const r={class:'map-controls'},i={key:0,class:'token-info'},c=(0,o.defineComponent)({__name:'MapCanvas',props:{mapData:{},tokens:{}},emits:['tokenMove','tokenSelect'],setup(t,{emit:a}){const n=t,c=a,s=(0,o.ref)(),d=(0,o.ref)(),u=(0,o.ref)(!0),m=(0,o.ref)(n.mapData.fogOfWar.enabled),p=(0,o.ref)(!n.mapData.globalLight),v=(0,o.ref)(!0),f=(0,o.ref)(null);let g=null,h=null,b=null,k=null,V=null,y=null,E=null,N=null;const w=(0,o.ref)({x:0,y:0,scale:1}),{isLineBlocked:x,calculateFOVShadowCasting:C}=function(){function e(e,a,n,o,l){for(const r of l){if(0===r.sense)continue;if(r.door>0&&1===r.ds)continue;const[l,i,c,s]=r.c;if(t(e,a,n,o,l,i,c,s))return!0}return!1}function t(e,t,a,n,o,l,r,i){const c=(i-l)*(a-e)-(r-o)*(n-t);if(Math.abs(c)<1e-10)return!1;const s=((r-o)*(t-l)-(i-l)*(e-o))/c,d=((a-e)*(t-l)-(n-t)*(e-o))/c;return s>=0&&s<=1&&d>=0&&d<=1}function a(e,t,o,l,r,i,c,s,d,u,m,p,v){if(r<i)return;let f=r;for(let g=l;g<=o;g++){let l=!1;for(let h=-g;h<=0;h++){const b=-g,k=(h-.5)/(b+.5),V=(h+.5)/(b-.5);if(r<V)continue;if(i>k)break;const y=e+h*c+b*s,E=t+h*d+b*u;if(Math.abs(y-e)+Math.abs(E-t)<=o&&v.add(`${y},${E}`),l){if(n(y,E,m,p)){f=V;continue}l=!1,r=f}else n(y,E,m,p)&&g<o&&(l=!0,a(e,t,o,g+1,r,k,c,s,d,u,m,p,v),f=V)}if(l)break}}function n(e,t,a,n){const o=e*n+n/2,l=t*n+n/2;for(const e of a){if(0===e.sense)continue;if(e.door>0&&1===e.ds)continue;const[t,a,n,r]=e.c,i=Math.min(t,n),c=Math.max(t,n),s=Math.min(a,r),d=Math.max(a,r);if(o>=i&&o<=c&&l>=s&&l<=d)return!0}return!1}return{isLineBlocked:e,calculateVisibleArea:function(t,a,n){const o=[],l=t.x,r=t.y,i=t.vision*n;if(i<=0)return o;const c=2*Math.PI/360;for(let t=0;t<360;t++){const s=t*c,d=Math.cos(s),u=Math.sin(s);for(let t=0;t<=i;t+=n/2){const i=l+d*t,c=r+u*t;if(e(l,r,i,c,a))break;const s=Math.floor(i/n),m=Math.floor(c/n);o.some(e=>e.x===s&&e.y===m)||o.push({x:s,y:m})}}return o},calculateFOVShadowCasting:function(e,t,n,o,l){const r=new Set,i=Math.floor(e/l),c=Math.floor(t/l);r.add(`${i},${c}`);const s=[[1,0],[1,1],[0,1],[-1,1],[-1,0],[-1,-1],[0,-1],[1,-1]];for(const[e,t]of s)a(i,c,n,1,1,0,e,t,0,0,o,l,r);return r}}}();function D(){if(!k)return;if(k.clear(),!u.value)return;const{width:e,height:t,grid:a,gridColor:o,gridAlpha:l}=n.mapData;k.lineStyle(1,parseInt(o.replace('#','0x')),l);for(let n=0;n<=e;n+=a)k.moveTo(n,0),k.lineTo(n,t);for(let n=0;n<=t;n+=a)k.moveTo(0,n),k.lineTo(e,n);k.stroke()}function S(){if(y&&(y.removeChildren(),p.value))for(const t of n.mapData.lights){const a=new l.Graphics,o=t.dim*n.mapData.grid,r=t.bright*n.mapData.grid,i=parseInt(t.tintColor.replace('#','0x'));o>0&&(a.circle(t.x,t.y,o),a.fill({color:i,alpha:.2*t.tintAlpha})),r>0&&(a.circle(t.x,t.y,r),a.fill({color:i,alpha:.5*t.tintAlpha})),a.circle(t.x,t.y,5),a.fill({color:16776960,alpha:.8}),y.addChild(a),e.to(a,{alpha:.7,duration:1+Math.random(),repeat:-1,yoyo:!0,ease:'power1.inOut'})}}function T(){if(!E)return;E.removeChildren();const e=n.tokens||n.mapData.tokens||[];for(const t of e){const e=new l.Graphics,a=t.width*n.mapData.grid,o=t.x,r=t.y;e.circle(o,r,a/2),e.fill({color:65280,alpha:.6}),e.stroke({width:2,color:16777215});const i=new l.Text({text:t.name,style:{fontSize:12,fill:16777215,stroke:{color:0,width:2}}});i.anchor.set(.5),i.x=o,i.y=r+a/2+10,e.addChild(i),e.eventMode='static',e.cursor='pointer';let s=!1,d=null;e.on('pointerdown',e=>{s=!0;const a=e.global;d={x:a.x-o,y:a.y-r},f.value=t,c('tokenSelect',t)}),e.on('pointerup',()=>{s=!1,d=null}),e.on('pointermove',a=>{if(s&&d){const n=a.global,l=n.x-d.x,i=n.y-d.y;e.x=l-o,e.y=i-r,c('tokenMove',t,l,i)}}),E.addChild(e)}}function M(){if(!N)return;if(N.clear(),!m.value)return;N.rect(0,0,n.mapData.width,n.mapData.height),N.fill({color:0,alpha:.8});const e=n.tokens||n.mapData.tokens||[];for(const t of e){if(t.vision<=0)continue;const e=C(t.x,t.y,t.vision,n.mapData.walls,n.mapData.grid);for(const t of e){const[e,a]=t.split(',').map(Number),o=e*n.mapData.grid,l=a*n.mapData.grid;N.rect(o,l,n.mapData.grid,n.mapData.grid),N.fill({color:0,alpha:-1})}}}function B(){w.value.scale*=1.2,e.to(g.stage.scale,{x:w.value.scale,y:w.value.scale,duration:.3})}function O(){w.value.scale*=.8,e.to(g.stage.scale,{x:w.value.scale,y:w.value.scale,duration:.3})}function U(){w.value={x:0,y:0,scale:1},e.to(g.stage,{x:0,y:0,duration:.5}),e.to(g.stage.scale,{x:1,y:1,duration:.5})}function I(){u.value=!u.value,D()}function j(){m.value=!m.value,M()}function A(){p.value=!p.value,S()}function L(){v.value=!v.value,b&&(b.visible=v.value)}return(0,o.onMounted)(async()=>{if(!s.value||!d.value)return;g=new l.Application,await g.init({canvas:d.value,width:s.value.clientWidth,height:s.value.clientHeight,backgroundColor:n.mapData.backgroundColor||'#000000',antialias:!0});const t=new l.Container,a=new l.Container,r=new l.Container;y=new l.Container,E=new l.Container;const i=new l.Container,c=new l.Container;if(g.stage.addChild(t),g.stage.addChild(a),g.stage.addChild(r),g.stage.addChild(y),g.stage.addChild(E),g.stage.addChild(i),g.stage.addChild(c),n.mapData.img){const e=await l.Assets.load(n.mapData.img);h=new l.Sprite(e),h.width=n.mapData.width,h.height=n.mapData.height,t.addChild(h)}if(n.mapData.foreground){const e=await l.Assets.load(n.mapData.foreground);b=new l.Sprite(e),b.width=n.mapData.width,b.height=n.mapData.height,i.addChild(b),toastr.info('已加载前景层 (遮挡物)')}k=new l.Graphics,a.addChild(k),D(),V=new l.Graphics,r.addChild(V),function(){if(!V)return;V.clear();for(const e of n.mapData.walls){const[t,a,n,o]=e.c;let l=16777215,r=.8,i=3;1===e.door?(l=9127187,i=1===e.ds?2:4):2===e.door&&(l=9662683,r=.5),0===e.sense&&(l=4286945,r=.4),V.lineStyle(i,l,r),V.moveTo(t,a),V.lineTo(n,o)}V.stroke()}(),S(),T(),N=new l.Graphics,c.addChild(N),m.value&&M(),function(){if(!g)return;let t=!1,a={x:0,y:0};g.stage.eventMode='static',g.stage.on('pointerdown',e=>{e.target===g?.stage&&(t=!0,a={x:e.globalX,y:e.globalY})}),g.stage.on('pointerup',()=>{t=!1}),g.stage.on('pointermove',e=>{if(t){const t=e.globalX-a.x,n=e.globalY-a.y;g.stage.x+=t,g.stage.y+=n,a={x:e.globalX,y:e.globalY}}}),d.value?.addEventListener('wheel',t=>{t.preventDefault();const a=t.deltaY>0?.9:1.1,n=w.value.scale*a;n>=.1&&n<=5&&(w.value.scale=n,e.to(g.stage.scale,{x:n,y:n,duration:.2,ease:'power2.out'}))})}();const u=new ResizeObserver(()=>{g&&s.value&&g.renderer.resize(s.value.clientWidth,s.value.clientHeight)});u.observe(s.value),(0,o.onUnmounted)(()=>{u.disconnect()})}),(0,o.watch)(()=>n.tokens,()=>{T(),m.value&&M()},{deep:!0}),(0,o.onUnmounted)(()=>{g?.destroy(!0)}),(e,t)=>((0,o.openBlock)(),(0,o.createElementBlock)('div',{class:'map-canvas-container',ref_key:'containerRef',ref:s},[(0,o.createElementVNode)('canvas',{ref_key:'canvasRef',ref:d},null,512),(0,o.createCommentVNode)(' 控制面板 '),(0,o.createElementVNode)('div',r,[(0,o.createElementVNode)('button',{onClick:B,title:'放大'},[...t[1]||(t[1]=[(0,o.createElementVNode)('span',null,'🔍+',-1)])]),(0,o.createElementVNode)('button',{onClick:O,title:'缩小'},[...t[2]||(t[2]=[(0,o.createElementVNode)('span',null,'🔍-',-1)])]),(0,o.createElementVNode)('button',{onClick:U,title:'重置视图'},[...t[3]||(t[3]=[(0,o.createElementVNode)('span',null,'🏠',-1)])]),(0,o.createElementVNode)('button',{onClick:I,title:'显示/隐藏网格'},[(0,o.createElementVNode)('span',null,(0,o.toDisplayString)(u.value?'⊞':'⊟'),1)]),(0,o.createElementVNode)('button',{onClick:j,title:'战争迷雾'},[(0,o.createElementVNode)('span',null,(0,o.toDisplayString)(m.value?'🌫️':'☀️'),1)]),(0,o.createElementVNode)('button',{onClick:A,title:'光照系统'},[(0,o.createElementVNode)('span',null,(0,o.toDisplayString)(p.value?'💡':'🔦'),1)]),n.mapData.foreground?((0,o.openBlock)(),(0,o.createElementBlock)('button',{key:0,onClick:L,title:'显示/隐藏前景层'},[(0,o.createElementVNode)('span',null,(0,o.toDisplayString)(v.value?'🏠':'🏚️'),1)])):(0,o.createCommentVNode)('v-if',!0)]),(0,o.createCommentVNode)(' Token 信息面板 '),f.value?((0,o.openBlock)(),(0,o.createElementBlock)('div',i,[(0,o.createElementVNode)('h3',null,(0,o.toDisplayString)(f.value.name),1),(0,o.createElementVNode)('p',null,'位置: ('+(0,o.toDisplayString)(Math.floor(f.value.x))+', '+(0,o.toDisplayString)(Math.floor(f.value.y))+')',1),(0,o.createElementVNode)('p',null,'视野: '+(0,o.toDisplayString)(f.value.vision)+' 格',1),(0,o.createElementVNode)('button',{onClick:t[0]||(t[0]=e=>f.value=null)},'关闭')])):(0,o.createCommentVNode)('v-if',!0)],512))}});var s=n(42);const d=(0,s.A)(c,[['__scopeId','data-v-6d3eac8c']]),u=_;var m=n.n(u);const p=z,v=p.z.object({x:p.z.number(),y:p.z.number(),dim:p.z.number().default(0),bright:p.z.number().default(0),tintColor:p.z.string().default('#ffffff'),tintAlpha:p.z.number().min(0).max(1).default(.5),animation:p.z.object({type:p.z.string().optional(),speed:p.z.number().optional(),intensity:p.z.number().optional()}).optional()}),f=p.z.object({c:p.z.tuple([p.z.number(),p.z.number(),p.z.number(),p.z.number()]),move:p.z.union([p.z.literal(0),p.z.literal(1)]).default(1),sense:p.z.union([p.z.literal(0),p.z.literal(1)]).default(1),sound:p.z.union([p.z.literal(0),p.z.literal(1)]).default(1),door:p.z.union([p.z.literal(0),p.z.literal(1),p.z.literal(2)]).default(0),ds:p.z.union([p.z.literal(0),p.z.literal(1)]).optional()}),g=p.z.object({id:p.z.string(),name:p.z.string().default('未命名'),x:p.z.number(),y:p.z.number(),width:p.z.number().default(1),height:p.z.number().default(1),img:p.z.string().optional(),vision:p.z.number().default(0),dimVision:p.z.number().default(0),rotation:p.z.number().default(0),hidden:p.z.boolean().default(!1),elevation:p.z.number().default(0)}),h=p.z.object({name:p.z.string().default('未命名地图'),width:p.z.number().positive(),height:p.z.number().positive(),grid:p.z.number().positive().default(100),shiftX:p.z.number().default(0),shiftY:p.z.number().default(0),gridDistance:p.z.number().positive().default(5),gridUnits:p.z.string().default('ft'),padding:p.z.number().default(0),gridColor:p.z.string().default('#000000'),gridAlpha:p.z.number().min(0).max(1).default(.2),globalLight:p.z.boolean().default(!0),darkness:p.z.number().min(0).max(1).default(0),backgroundColor:p.z.string().default('#000000'),img:p.z.string().nullable().optional(),foreground:p.z.string().nullable().optional(),lights:p.z.array(v).default([]),walls:p.z.array(f).default([]),tokens:p.z.array(g).default([]),fogOfWar:p.z.object({enabled:p.z.boolean().default(!1),explored:p.z.array(p.z.array(p.z.boolean())).optional()}).default({enabled:!1})}),b=p.z.object({mapId:p.z.string(),tokens:p.z.array(g),fogExplored:p.z.array(p.z.array(p.z.boolean())).optional(),viewport:p.z.object({x:p.z.number().default(0),y:p.z.number().default(0),scale:p.z.number().default(1)}).default({})});function k(e){const t=t=>{try{const a=`vtt_map_${e}`,n=m().cloneDeep(t);replaceVariables({[a]:n},{type:'chat'})}catch(e){console.error('保存地图状态失败:',e)}},a=(0,o.ref)((()=>{try{const t=getVariables({type:'chat'}),a=`vtt_map_${e}`;if(t[a])return b.parse(t[a])}catch(e){console.warn('加载地图状态失败:',e)}return{mapId:e,tokens:[],viewport:{x:0,y:0,scale:1}}})()),n=m().debounce(e=>{t(e)},1e3);(0,o.watch)(a,e=>{n(e)},{deep:!0});return{state:a,updateTokenPosition:(e,t,n)=>{const o=a.value.tokens.find(t=>t.id===e);o&&(o.x=t,o.y=n)},addToken:e=>{a.value.tokens.find(t=>t.id===e.id)||a.value.tokens.push(e)},removeToken:e=>{const t=a.value.tokens.findIndex(t=>t.id===e);-1!==t&&a.value.tokens.splice(t,1)},updateViewport:(e,t,n)=>{a.value.viewport={x:e,y:t,scale:n}},markExplored:(e,t)=>{a.value.fogExplored||(a.value.fogExplored=[]),a.value.fogExplored[t]||(a.value.fogExplored[t]=[]),a.value.fogExplored[t][e]=!0},isExplored:(e,t)=>a.value.fogExplored?.[t]?.[e]??!1,saveState:()=>t(a.value)}}const V={class:'vtt-viewer'},y={key:0,class:'loading'},E={key:1,class:'error'},N={class:'error-actions'},w={key:2,class:'upload-dialog'},x={class:'upload-content'},C={class:'upload-actions'},D={class:'toolbar'},S={class:'toolbar-actions'},T={class:'map-wrapper'},M={key:0,class:'side-panel token-manager'},B={class:'panel-header'},O={class:'panel-content'},U={class:'token-header'},I=['onClick'],j={class:'token-details'},A=['onUpdate:modelValue'],L=['onUpdate:modelValue'],J=['onUpdate:modelValue'],R=['onUpdate:modelValue'],F=['onUpdate:modelValue'],P={key:1,class:'side-panel map-info'},W={class:'panel-header'},X={class:'panel-content'},Y={class:'info-item'},G={class:'info-item'},H={class:'info-item'},q={class:'info-item'},K={class:'info-item'},Q={class:'info-item'},Z={class:'info-item'},ee=(0,o.defineComponent)({__name:'App',setup(e){const t=(0,o.ref)(!0),a=(0,o.ref)(null),n=(0,o.ref)(null),l=(0,o.ref)(!1),r=(0,o.ref)(!1),i=(0,o.ref)(!1),c=(0,o.ref)(''),s=(0,o.ref)(null),u=(0,o.computed)(()=>s.value?s.value.state.value.tokens:n.value?.tokens||[]);function m(){const e={name:'示例地图',width:3e3,height:2e3,grid:100,gridDistance:5,gridUnits:'ft',backgroundColor:'#1a1a1a',globalLight:!1,darkness:.5,img:null,foreground:null,lights:[{x:500,y:500,dim:8,bright:4,tintColor:'#ffaa00',tintAlpha:.5},{x:1500,y:1e3,dim:10,bright:5,tintColor:'#ffffff',tintAlpha:.8}],walls:[{c:[0,0,3e3,0],move:1,sense:1,sound:1,door:0},{c:[3e3,0,3e3,2e3],move:1,sense:1,sound:1,door:0},{c:[3e3,2e3,0,2e3],move:1,sense:1,sound:1,door:0},{c:[0,2e3,0,0],move:1,sense:1,sound:1,door:0}],tokens:[{id:'token1',name:'玩家',x:500,y:500,width:1,vision:12}],fogOfWar:{enabled:!1}};try{const o=h.parse(e);n.value=o,s.value=k(o.name),0===s.value.state.value.tokens.length&&o.tokens&&o.tokens.length>0&&o.tokens.forEach(e=>s.value?.addToken(e)),a.value=null,t.value=!1,i.value=!1,toastr.success('示例地图加载成功')}catch(e){a.value=e instanceof Error?e.message:String(e),toastr.error('示例地图加载失败: '+a.value)}}function p(e){const t=e.target.files?.[0];if(!t)return;const a=new FileReader;a.onload=e=>{c.value=e.target?.result},a.readAsText(t)}function v(){try{const e=JSON.parse(c.value),o=h.parse(e);n.value=o,s.value=k(o.name),0===s.value.state.value.tokens.length&&o.tokens&&o.tokens.length>0&&o.tokens.forEach(e=>s.value?.addToken(e));const l=getVariables({type:'script',script_id:getScriptId()});l.vtt_map_data=o,replaceVariables(l,{type:'script',script_id:getScriptId()}),a.value=null,t.value=!1,i.value=!1,c.value='',toastr.success(`地图 "${o.name}" 加载成功`)}catch(e){toastr.error('JSON 解析失败: '+(e instanceof Error?e.message:String(e)))}}async function f(){t.value=!0,a.value=null;try{const e=getVariables({type:'script',script_id:getScriptId()});if(!e.vtt_map_url&&!e.vtt_map_data)throw new Error('未配置地图数据。请在脚本变量中设置 vtt_map_url 或 vtt_map_data');let t;if(e.vtt_map_url){const a=await fetch(e.vtt_map_url);t=await a.json()}else t=e.vtt_map_data;const a=h.parse(t);n.value=a,s.value=k(a.name),0===s.value.state.value.tokens.length&&a.tokens&&a.tokens.length>0&&a.tokens.forEach(e=>{s.value?.addToken(e)}),toastr.success(`地图 "${a.name}" 加载成功`)}catch(e){a.value=e instanceof Error?e.message:String(e),toastr.error('地图加载失败: '+a.value)}finally{t.value=!1}}function b(e,t,a){s.value?.updateTokenPosition(e.id,t,a)}function ee(e){console.log('选中 Token:',e)}function te(){if(!s.value||!n.value)return;const e=g.parse({id:`token_${Date.now()}`,name:`Token ${u.value.length+1}`,x:n.value.width/2,y:n.value.height/2,width:1,height:1,vision:12});s.value.addToken(e),toastr.success(`添加了新的 Token: ${e.name}`)}function ae(){if(!s.value)return;const e=s.value.state.value,t=JSON.stringify(e,null,2);navigator.clipboard.writeText(t).then(()=>{toastr.success('状态已复制到剪贴板')}).catch(()=>{const e=new Blob([t],{type:'application/json'}),a=URL.createObjectURL(e),o=document.createElement('a');o.href=a,o.download=`${n.value?.name}_state.json`,o.click(),URL.revokeObjectURL(a)})}function ne(){const e=prompt('请粘贴地图状态 JSON:');if(e)try{const t=JSON.parse(e);replaceVariables({[`vtt_map_${n.value?.name}`]:t},{type:'chat'}),toastr.success('状态导入成功,正在重新加载...'),setTimeout(()=>location.reload(),1e3)}catch(e){toastr.error('导入失败: '+(e instanceof Error?e.message:String(e)))}}return(0,o.onMounted)(()=>{f()}),(e,g)=>((0,o.openBlock)(),(0,o.createElementBlock)('div',V,[t.value?((0,o.openBlock)(),(0,o.createElementBlock)('div',y,[...g[7]||(g[7]=[(0,o.createElementVNode)('div',{class:'spinner'},null,-1),(0,o.createElementVNode)('p',null,'加载地图中...',-1)])])):a.value?((0,o.openBlock)(),(0,o.createElementBlock)('div',E,[g[8]||(g[8]=(0,o.createElementVNode)('h2',null,'❌ 加载失败',-1)),(0,o.createElementVNode)('pre',null,(0,o.toDisplayString)(a.value),1),(0,o.createElementVNode)('div',N,[(0,o.createElementVNode)('button',{onClick:f},'重试'),(0,o.createElementVNode)('button',{onClick:g[0]||(g[0]=e=>i.value=!0)},'📁 上传地图 JSON'),(0,o.createElementVNode)('button',{onClick:m},'🎲 加载示例地图')])])):(0,o.createCommentVNode)('v-if',!0),(0,o.createCommentVNode)(' 上传对话框 '),i.value?((0,o.openBlock)(),(0,o.createElementBlock)('div',w,[(0,o.createElementVNode)('div',x,[g[9]||(g[9]=(0,o.createElementVNode)('h3',null,'上传地图 JSON 文件',-1)),(0,o.createElementVNode)('input',{type:'file',accept:'.json',onChange:p},null,32),g[10]||(g[10]=(0,o.createElementVNode)('p',{class:'upload-hint'},'或粘贴 JSON 内容:',-1)),(0,o.withDirectives)((0,o.createElementVNode)('textarea',{'onUpdate:modelValue':g[1]||(g[1]=e=>c.value=e),placeholder:'粘贴 VTT 地图 JSON...',rows:'10'},null,512),[[o.vModelText,c.value]]),(0,o.createElementVNode)('div',C,[(0,o.createElementVNode)('button',{onClick:v},'加载'),(0,o.createElementVNode)('button',{onClick:g[2]||(g[2]=e=>i.value=!1)},'取消')])])])):n.value?((0,o.openBlock)(),(0,o.createElementBlock)(o.Fragment,{key:3},[(0,o.createCommentVNode)(' 顶部工具栏 '),(0,o.createElementVNode)('div',D,[(0,o.createElementVNode)('h2',null,(0,o.toDisplayString)(n.value.name),1),(0,o.createElementVNode)('div',S,[(0,o.createElementVNode)('button',{onClick:g[3]||(g[3]=e=>l.value=!l.value)},'🎭 Token 管理'),(0,o.createElementVNode)('button',{onClick:g[4]||(g[4]=e=>r.value=!r.value)},'ℹ️ 地图信息'),(0,o.createElementVNode)('button',{onClick:ae},'💾 导出状态'),(0,o.createElementVNode)('button',{onClick:ne},'📁 导入状态')])]),(0,o.createCommentVNode)(' 地图画布 '),(0,o.createElementVNode)('div',T,[(0,o.createVNode)(d,{'map-data':n.value,tokens:u.value,onTokenMove:b,onTokenSelect:ee},null,8,['map-data','tokens'])]),(0,o.createCommentVNode)(' Token 管理面板 '),l.value?((0,o.openBlock)(),(0,o.createElementBlock)('div',M,[(0,o.createElementVNode)('div',B,[g[11]||(g[11]=(0,o.createElementVNode)('h3',null,'Token 管理',-1)),(0,o.createElementVNode)('button',{onClick:g[5]||(g[5]=e=>l.value=!1)},'✖')]),(0,o.createElementVNode)('div',O,[(0,o.createElementVNode)('button',{onClick:te,class:'add-token-btn'},'➕ 添加 Token'),((0,o.openBlock)(!0),(0,o.createElementBlock)(o.Fragment,null,(0,o.renderList)(u.value,e=>((0,o.openBlock)(),(0,o.createElementBlock)('div',{key:e.id,class:'token-item'},[(0,o.createElementVNode)('div',U,[(0,o.createElementVNode)('strong',null,(0,o.toDisplayString)(e.name),1),(0,o.createElementVNode)('button',{onClick:t=>{return a=e.id,void(s.value&&confirm('确定要删除这个 Token 吗?')&&(s.value.removeToken(a),toastr.success('Token 已删除')));var a},class:'delete-btn'},'🗑️',8,I)]),(0,o.createElementVNode)('div',j,[(0,o.createElementVNode)('label',null,[g[12]||(g[12]=(0,o.createTextVNode)(' 名称: ',-1)),(0,o.withDirectives)((0,o.createElementVNode)('input',{'onUpdate:modelValue':t=>e.name=t,type:'text'},null,8,A),[[o.vModelText,e.name]])]),(0,o.createElementVNode)('label',null,[g[13]||(g[13]=(0,o.createTextVNode)(' X: ',-1)),(0,o.withDirectives)((0,o.createElementVNode)('input',{'onUpdate:modelValue':t=>e.x=t,type:'number',step:'10'},null,8,L),[[o.vModelText,e.x,void 0,{number:!0}]])]),(0,o.createElementVNode)('label',null,[g[14]||(g[14]=(0,o.createTextVNode)(' Y: ',-1)),(0,o.withDirectives)((0,o.createElementVNode)('input',{'onUpdate:modelValue':t=>e.y=t,type:'number',step:'10'},null,8,J),[[o.vModelText,e.y,void 0,{number:!0}]])]),(0,o.createElementVNode)('label',null,[g[15]||(g[15]=(0,o.createTextVNode)(' 视野范围: ',-1)),(0,o.withDirectives)((0,o.createElementVNode)('input',{'onUpdate:modelValue':t=>e.vision=t,type:'number',min:'0',max:'100'},null,8,R),[[o.vModelText,e.vision,void 0,{number:!0}]])]),(0,o.createElementVNode)('label',null,[g[16]||(g[16]=(0,o.createTextVNode)(' 尺寸: ',-1)),(0,o.withDirectives)((0,o.createElementVNode)('input',{'onUpdate:modelValue':t=>e.width=t,type:'number',min:'1',max:'10'},null,8,F),[[o.vModelText,e.width,void 0,{number:!0}]])])])]))),128))])])):(0,o.createCommentVNode)('v-if',!0),(0,o.createCommentVNode)(' 地图信息面板 '),r.value?((0,o.openBlock)(),(0,o.createElementBlock)('div',P,[(0,o.createElementVNode)('div',W,[g[17]||(g[17]=(0,o.createElementVNode)('h3',null,'地图信息',-1)),(0,o.createElementVNode)('button',{onClick:g[6]||(g[6]=e=>r.value=!1)},'✖')]),(0,o.createElementVNode)('div',X,[(0,o.createElementVNode)('div',Y,[g[18]||(g[18]=(0,o.createElementVNode)('label',null,'地图名称:',-1)),(0,o.createElementVNode)('span',null,(0,o.toDisplayString)(n.value.name),1)]),(0,o.createElementVNode)('div',G,[g[19]||(g[19]=(0,o.createElementVNode)('label',null,'尺寸:',-1)),(0,o.createElementVNode)('span',null,(0,o.toDisplayString)(n.value.width)+' × '+(0,o.toDisplayString)(n.value.height)+' px',1)]),(0,o.createElementVNode)('div',H,[g[20]||(g[20]=(0,o.createElementVNode)('label',null,'网格:',-1)),(0,o.createElementVNode)('span',null,(0,o.toDisplayString)(n.value.grid)+' px ('+(0,o.toDisplayString)(n.value.gridDistance)+' '+(0,o.toDisplayString)(n.value.gridUnits)+')',1)]),(0,o.createElementVNode)('div',q,[g[21]||(g[21]=(0,o.createElementVNode)('label',null,'光源数量:',-1)),(0,o.createElementVNode)('span',null,(0,o.toDisplayString)(n.value.lights.length),1)]),(0,o.createElementVNode)('div',K,[g[22]||(g[22]=(0,o.createElementVNode)('label',null,'墙壁数量:',-1)),(0,o.createElementVNode)('span',null,(0,o.toDisplayString)(n.value.walls.length),1)]),(0,o.createElementVNode)('div',Q,[g[23]||(g[23]=(0,o.createElementVNode)('label',null,'全局光照:',-1)),(0,o.createElementVNode)('span',null,(0,o.toDisplayString)(n.value.globalLight?'是':'否'),1)]),(0,o.createElementVNode)('div',Z,[g[24]||(g[24]=(0,o.createElementVNode)('label',null,'黑暗等级:',-1)),(0,o.createElementVNode)('span',null,(0,o.toDisplayString)((100*n.value.darkness).toFixed(0))+'%',1)])])])):(0,o.createCommentVNode)('v-if',!0)],64)):(0,o.createCommentVNode)('v-if',!0)]))}}),te=(0,s.A)(ee,[['__scopeId','data-v-afc8b222']]);'undefined'!=typeof window&&'function'==typeof window.getScriptId||(void 0===window.$&&(window.$=e=>('function'==typeof e&&('loading'===document.readyState?document.addEventListener('DOMContentLoaded',e):e()),{on:()=>{}}),window.$.fn={}),void 0===window.toastr&&(window.toastr={success:e=>console.log('[Success]',e),error:e=>console.error('[Error]',e),info:e=>console.info('[Info]',e),warning:e=>console.warn('[Warning]',e)}),void 0===window.getScriptId&&(window.getScriptId=()=>'standalone-vtt-viewer',window.getVariables=e=>{const t='script'===e?.type?'vtt_script_vars':'vtt_chat_vars',a=localStorage.getItem(t);return a?JSON.parse(a):{}},window.replaceVariables=(e,t)=>{const a='script'===t?.type?'vtt_script_vars':'vtt_chat_vars',n={...window.getVariables(t),...e};localStorage.setItem(a,JSON.stringify(n))}));const $=window.$,ae=window.toastr;$(()=>{(0,o.createApp)(te).mount('#app'),ae.success('VTT 地图查看器已加载')}),$(window).on('pagehide',()=>{ae.info('VTT 地图查看器已卸载')});
//# sourceMappingURL=index.js.map</script><style>.map-canvas-container[data-v-6d3eac8c]{position:relative;width:100%;height:100%;overflow:hidden;background:#1a1a1a}canvas[data-v-6d3eac8c]{display:block;width:100%;height:100%}.map-controls[data-v-6d3eac8c]{position:absolute;top:10px;right:10px;display:flex;flex-direction:column;gap:5px;z-index:10}.map-controls button[data-v-6d3eac8c]{width:40px;height:40px;border:none;background:rgba(0,0,0,0.7);color:white;border-radius:5px;cursor:pointer;font-size:18px;transition:background 0.2s}.map-controls button[data-v-6d3eac8c]:hover{background:rgba(0,0,0,0.9)}.token-info[data-v-6d3eac8c]{position:absolute;bottom:10px;left:10px;background:rgba(0,0,0,0.8);color:white;padding:15px;border-radius:8px;min-width:200px;z-index:10}.token-info h3[data-v-6d3eac8c]{margin:0 0 10px 0;font-size:16px}.token-info p[data-v-6d3eac8c]{margin:5px 0;font-size:14px}.token-info button[data-v-6d3eac8c]{margin-top:10px;padding:5px 10px;background:#4caf50;border:none;color:white;border-radius:4px;cursor:pointer}.token-info button[data-v-6d3eac8c]:hover{background:#45a049}

.vtt-viewer[data-v-afc8b222]{width:100%;height:100vh;display:flex;flex-direction:column;background:#1a1a1a;color:white;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif}.loading[data-v-afc8b222],.error[data-v-afc8b222]{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;gap:20px}.spinner[data-v-afc8b222]{width:50px;height:50px;border:4px solid rgba(255,255,255,0.3);border-top-color:white;border-radius:50%;animation:spin-afc8b222 1s linear infinite}@keyframes spin-afc8b222{to{transform:rotate(360deg)}}.error pre[data-v-afc8b222]{background:rgba(255,0,0,0.2);padding:15px;border-radius:5px;max-width:600px}.error-actions[data-v-afc8b222]{display:flex;gap:10px}.error button[data-v-afc8b222]{padding:10px 20px;background:#4caf50;border:none;color:white;border-radius:5px;cursor:pointer;transition:background 0.3s}.error button[data-v-afc8b222]:hover{background:#66bb6a}.upload-dialog[data-v-afc8b222]{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);display:flex;align-items:center;justify-content:center;z-index:1000}.upload-content[data-v-afc8b222]{background:#2a2a2a;padding:30px;border-radius:10px;max-width:600px;width:90%}.upload-content h3[data-v-afc8b222]{margin-top:0}.upload-content input[type='file'][data-v-afc8b222]{width:100%;padding:10px;margin:10px 0;background:#1a1a1a;border:2px dashed #666;border-radius:5px;color:white;cursor:pointer}.upload-hint[data-v-afc8b222]{margin:20px 0 10px;color:#aaa}.upload-content textarea[data-v-afc8b222]{width:100%;padding:10px;background:#1a1a1a;border:1px solid #666;border-radius:5px;color:white;font-family:monospace;resize:vertical}.upload-actions[data-v-afc8b222]{display:flex;gap:10px;margin-top:20px;justify-content:flex-end}.upload-actions button[data-v-afc8b222]{padding:10px 20px;background:#4caf50;border:none;color:white;border-radius:5px;cursor:pointer}.upload-actions button[data-v-afc8b222]:last-child{background:#666}.upload-actions button[data-v-afc8b222]:hover{opacity:0.8}.toolbar[data-v-afc8b222]{display:flex;justify-content:space-between;align-items:center;padding:10px 20px;background:rgba(0,0,0,0.8);border-bottom:2px solid #333}.toolbar h2[data-v-afc8b222]{margin:0;font-size:20px}.toolbar-actions[data-v-afc8b222]{display:flex;gap:10px}.toolbar-actions button[data-v-afc8b222]{padding:8px 15px;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.3);color:white;border-radius:5px;cursor:pointer;transition:background 0.2s}.toolbar-actions button[data-v-afc8b222]:hover{background:rgba(255,255,255,0.2)}.map-wrapper[data-v-afc8b222]{flex:1;position:relative}.side-panel[data-v-afc8b222]{position:absolute;top:60px;right:10px;width:300px;max-height:calc(100vh - 80px);background:rgba(0,0,0,0.9);border:1px solid #333;border-radius:8px;overflow:hidden;display:flex;flex-direction:column;z-index:100}.panel-header[data-v-afc8b222]{display:flex;justify-content:space-between;align-items:center;padding:15px;background:rgba(255,255,255,0.1);border-bottom:1px solid #333}.panel-header h3[data-v-afc8b222]{margin:0;font-size:16px}.panel-header button[data-v-afc8b222]{background:none;border:none;color:white;font-size:18px;cursor:pointer}.panel-content[data-v-afc8b222]{flex:1;overflow-y:auto;padding:15px}.add-token-btn[data-v-afc8b222]{width:100%;padding:10px;background:#4caf50;border:none;color:white;border-radius:5px;cursor:pointer;margin-bottom:15px}.token-item[data-v-afc8b222]{background:rgba(255,255,255,0.05);padding:10px;border-radius:5px;margin-bottom:10px}.token-header[data-v-afc8b222]{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}.delete-btn[data-v-afc8b222]{background:rgba(255,0,0,0.3);border:none;color:white;padding:4px 8px;border-radius:3px;cursor:pointer}.token-details[data-v-afc8b222]{display:flex;flex-direction:column;gap:8px}.token-details label[data-v-afc8b222]{display:flex;justify-content:space-between;align-items:center;font-size:14px}.token-details input[data-v-afc8b222]{width:120px;padding:4px 8px;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.3);color:white;border-radius:3px}.info-item[data-v-afc8b222]{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid rgba(255,255,255,0.1)}.info-item label[data-v-afc8b222]{font-weight:bold}


/*# sourceMappingURL=main.css.map*/</style></head><body><div id="app"></div></body></html>