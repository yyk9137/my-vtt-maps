<!doctype html><html lang="zh-CN"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><title>VTT 地图查看器</title><script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/vue@3.5.13/dist/vue.global.prod.js"></script><script src="https://cdn.jsdelivr.net/npm/pixi.js@8.14.0/dist/pixi.min.js"></script><script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"></script><script src="https://cdn.jsdelivr.net/npm/zod@3.24.1/lib/index.umd.js"></script><script>"undefined"!=typeof Zod&&"undefined"==typeof z&&(window.z=Zod)</script><script src="https://cdn.jsdelivr.net/npm/toastr@2.1.4/toastr.min.js"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastr@2.1.4/build/toastr.min.css"/><script type="module">import{gsap as e}from'https://testingcf.jsdelivr.net/npm/gsap/+esm';var t={42:(e,t)=>{t.A=(e,t)=>{const o=e.__vccOpts||e;for(const[e,n]of t)o[e]=n;return o}}},o={};function n(e){var a=o[e];if(void 0!==a)return a.exports;var l=o[e]={exports:{}};return t[e](l,l.exports,n),l.exports}n.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return n.d(t,{a:t}),t},n.d=(e,t)=>{for(var o in t)n.o(t,o)&&!n.o(e,o)&&Object.defineProperty(e,o,{enumerable:!0,get:t[o]})},n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t);const a=Vue,l=PIXI;class r{bounds;capacity;walls=[];divided=!1;northeast;northwest;southeast;southwest;constructor(e,t=10){this.bounds=e,this.capacity=t}insert(e){if(!this.intersects(e))return!1;if(this.walls.length<this.capacity)return this.walls.push(e),!0;this.divided||this.subdivide();let t=!1;return this.northeast.insert(e)&&(t=!0),this.northwest.insert(e)&&(t=!0),this.southeast.insert(e)&&(t=!0),this.southwest.insert(e)&&(t=!0),t||this.walls.push(e),!0}query(e,t=[],o=0){const n='  '.repeat(o);if(!this.boundsIntersect(this.bounds,e))return 0===o&&(console.log(`${n}❌ 查询范围与四叉树根节点不相交!`),console.log(`${n}  四叉树边界: [${this.bounds.x}, ${this.bounds.y}, ${this.bounds.width}, ${this.bounds.height}]`),console.log(`${n}  查询范围: [${e.x}, ${e.y}, ${e.width}, ${e.height}]`)),t;for(const o of this.walls)this.wallIntersectsRange(o,e)&&t.push(o);return this.divided&&(this.northeast.query(e,t,o+1),this.northwest.query(e,t,o+1),this.southeast.query(e,t,o+1),this.southwest.query(e,t,o+1)),t}subdivide(){const{x:e,y:t,width:o,height:n}=this.bounds,a=o/2,l=n/2;this.northeast=new r({x:e+a,y:t,width:a,height:l},this.capacity),this.northwest=new r({x:e,y:t,width:a,height:l},this.capacity),this.southeast=new r({x:e+a,y:t+l,width:a,height:l},this.capacity),this.southwest=new r({x:e,y:t+l,width:a,height:l},this.capacity),this.divided=!0}intersects(e){const[t,o,n,a]=e.c,{x:l,y:r,width:i,height:s}=this.bounds,c=Math.min(t,n),d=Math.max(t,n),u=Math.min(o,a),h=Math.max(o,a);return!(d<l||c>l+i||h<r||u>r+s)}boundsIntersect(e,t){return!(e.x+e.width<t.x||e.x>t.x+t.width||e.y+e.height<t.y||e.y>t.y+t.height)}wallIntersectsRange(e,t){const[o,n,a,l]=e.c,r=Math.min(o,a),i=Math.max(o,a),s=Math.min(n,l),c=Math.max(n,l);return!(i<t.x||r>t.x+t.width||c<t.y||s>t.y+t.height)}clear(){this.walls=[],this.divided=!1,this.northeast=void 0,this.northwest=void 0,this.southeast=void 0,this.southwest=void 0}getStats(){let e=1,t=this.walls.length,o=1;if(this.divided){const n=this.northeast.getStats(),a=this.northwest.getStats(),l=this.southeast.getStats(),r=this.southwest.getStats();e+=n.nodes+a.nodes+l.nodes+r.nodes,t+=n.walls+a.walls+l.walls+r.walls,o=Math.max(n.maxDepth,a.maxDepth,l.maxDepth,r.maxDepth)+1}return{nodes:e,walls:t,maxDepth:o}}}function i(e,t,o,n,a){const[l,r,i,s]=a.c,c=Math.min(e,o),d=Math.max(e,o),u=Math.min(t,n),h=Math.max(t,n),m=Math.min(l,i),p=Math.max(l,i),f=Math.min(r,s),g=Math.max(r,s);return!(d<m||c>p||h<f||u>g)}const s={class:'map-controls'},c={key:0,class:'door-panel'},d={class:'panel-header'},u={class:'panel-content'},h={class:'door-info'},m={class:'door-name'},p={class:'door-position'},f=['onClick'],g={key:1,class:'token-info'},v=(0,a.defineComponent)({__name:'MapCanvas-V4',props:{mapData:{},tokens:{}},emits:['tokenMove','tokenSelect'],setup(t,{emit:o}){const n=t,v=o,y=(0,a.ref)(),k=(0,a.ref)(),b=(0,a.ref)(!0),w=(0,a.ref)(n.mapData.fogOfWar.enabled),x=(0,a.ref)(!n.mapData.globalLight),V=(0,a.ref)(!0),E=(0,a.ref)(null),N=(0,a.ref)(!1),M=(0,a.computed)(()=>n.mapData.walls.filter(e=>1===e.door));let C=null,D=null,S=null,T=null,B=null,O=null,I=null,A=null,U=!1,q=!1;const L=new Map;let j=null,R=null,J=null,P=!0;const W=(0,a.ref)({x:0,y:0,scale:1}),{isLineBlocked:F,isMovementBlocked:X,isTokenOnWall:Y,calculateFOVShadowCasting:G,getKeyAngles:H,buildQuadTree:K,castRay:Q,shouldBlockVision:Z}=function(){let e=null,t=null;function o(e,t,o,a,l){for(const r of l){if(0===r.sense)continue;if(r.door>0&&1===r.ds)continue;const[l,i,s,c]=r.c;if(n(e,t,o,a,l,i,s,c))return!0}return!1}function n(e,t,o,n,a,l,r,i){const s=(i-l)*(o-e)-(r-a)*(n-t);if(Math.abs(s)<1e-10)return!1;const c=((r-a)*(t-l)-(i-l)*(e-a))/s,d=((o-e)*(t-l)-(n-t)*(e-a))/s,u=1e-10;return c>=-1e-10&&c<=1+u&&d>=-1e-10&&d<=1+u}function a(e,t,o,n,a,l){const r=a-o,i=l-n,s=r*r+i*i;if(0===s)return Math.sqrt((e-o)*(e-o)+(t-n)*(t-n));let c=((e-o)*r+(t-n)*i)/s;c=Math.max(0,Math.min(1,c));const d=o+c*r,u=n+c*i;return Math.sqrt((e-d)*(e-d)+(t-u)*(t-u))}function l(e,t,o,n,l,r,i,s,c){const d=l+5;if(a(e,t,r,i,s,c)<d)return!0;if(a(o,n,r,i,s,c)<d)return!0;const u=Math.sqrt((o-e)**2+(n-t)**2),h=Math.max(5,Math.ceil(u/(l/3)));for(let l=0;l<=h;l++){const u=l/h;if(a(e+(o-e)*u,t+(n-t)*u,r,i,s,c)<d)return!0}return!1}function s(e,t,o,n,a,l,r,i,d,u,h,m,p){if(a<l)return;let f=a;for(let g=n;g<=o;g++){let n=!1;for(let v=-g;v<=0;v++){const y=-g,k=(v-.5)/(y+.5),b=(v+.5)/(y-.5);if(a<b)continue;if(l>k)break;const w=e+v*r+y*i,x=t+v*d+y*u;if(Math.abs(w-e)+Math.abs(x-t)<=o&&p.add(`${w},${x}`),n){if(c(w,x,h,m)){f=b;continue}n=!1,a=f}else c(w,x,h,m)&&g<o&&(n=!0,s(e,t,o,g+1,a,k,r,i,d,u,h,m,p),f=b)}if(n)break}}function c(e,t,o,n){const a=e*n+n/2,l=t*n+n/2;for(const e of o){if(0===e.sense)continue;if(e.door>0&&1===e.ds)continue;const[t,o,n,r]=e.c,i=Math.min(t,n),s=Math.max(t,n),c=Math.min(o,r),d=Math.max(o,r);if(a>=i&&a<=s&&l>=c&&l<=d)return!0}return!1}function d(o,n){if(e&&t===o)return e;console.log(`🌳 构建四叉树: 地图边界 [${n.x}, ${n.y}, ${n.width}, ${n.height}]`);const a=new r(n,10);let l=0;for(const e of o)a.insert(e)&&l++;console.log(`🌳 四叉树构建完成: 插入 ${l}/${o.length} 道墙`);const i=a.getStats();console.log(`🌳 四叉树统计: 节点数=${i.nodes}, 墙壁数=${i.walls}, 最大深度=${i.maxDepth}`);const s=a.query({x:5100,y:4350,width:300,height:300});return console.log(`🧪 测试查询 [5100,4350,300x300]: 找到 ${s.length} 道墙`),s.length>0&&console.log('  前3道墙:',s.slice(0,3).map(e=>`[${e.c[0]},${e.c[1]}]→[${e.c[2]},${e.c[3]}]`)),e=a,t=o,a}function u(e){return 0!==e.sense&&(1===e.door?void 0!==e.ds&&1!==e.ds:1===e.sense)}function h(e,t,o,n,a,l,r,i){const s=(i-l)*(o-e)-(r-a)*(n-t);if(Math.abs(s)<1e-10)return null;const c=((r-a)*(t-l)-(i-l)*(e-a))/s,d=((o-e)*(t-l)-(n-t)*(e-a))/s;return c>=0&&c<=1&&d>=0&&d<=1?{x:e+c*(o-e),y:t+c*(n-t)}:null}return{isLineBlocked:o,isMovementBlocked:function(e,t,o,a,r,s=0,c){if(c){const u=d(r,c),h=Math.max(2*s,20),m={x:Math.min(e,o)-h,y:Math.min(t,a)-h,width:Math.abs(o-e)+2*h,height:Math.abs(a-t)+2*h},p=u.query(m);for(const r of p){if(0===r.move)continue;if(r.door>0&&1===r.ds)continue;if(!i(e,t,o,a,r))continue;const[c,d,u,h]=r.c;if(s>0){if(l(e,t,o,a,s,c,d,u,h))return!0}else if(n(e,t,o,a,c,d,u,h))return!0}return!1}for(const l of r){if(0===l.move)continue;if(l.door>0&&1===l.ds)continue;const[r,i,s,c]=l.c;if(n(e,t,o,a,r,i,s,c))return!0}return!1},isTokenOnWall:function(e,t,o,n,l){let r=n;if(l){const a=2*o,i={x:e-a,y:t-a,width:2*a,height:2*a};if(r=d(n,l).query(i),console.log(`  🔍 四叉树查询: 范围 [${Math.floor(i.x)},${Math.floor(i.y)}] → [${Math.floor(i.x+i.width)},${Math.floor(i.y+i.height)}] 大小 ${Math.floor(i.width)}x${Math.floor(i.height)}, 找到 ${r.length}/${n.length} 道墙`),0===r.length){console.log('  ⚠️ 四叉树找到0道墙,手动检查...');let e=0;for(const t of n){const[o,n,a,l]=t.c,r=Math.min(o,a),s=Math.max(o,a),c=Math.min(n,l),d=Math.max(n,l);!(s<i.x||r>i.x+i.width||d<i.y||c>i.y+i.height)&&e<3&&(console.log(`    墙 [${Math.floor(o)},${Math.floor(n)}]→[${Math.floor(a)},${Math.floor(l)}] 应该在范围内!`),e++)}e>0&&console.log(`  ⚠️ 手动检查发现至少 ${e} 道墙在范围内,但四叉树没找到!`)}}for(const n of r){if(1!==n.move)continue;if(1===n.door&&1===n.ds)continue;const[l,r,i,s]=n.c,c=a(e,t,l,r,i,s);if(console.log(`  🔍 检测墙: [${Math.floor(l)},${Math.floor(r)}]→[${Math.floor(i)},${Math.floor(s)}], 距离: ${Math.floor(c)}px, 半径: ${o}px, 碰撞: ${c<o}`),c<o)return console.log(`  ⚠️ Token在墙上! 距离 ${Math.floor(c)}px < 半径 ${o}px`),!0}return console.log(`  ✅ Token位置合法 (检查了 ${r.length} 道墙)`),!1},calculateVisibleArea:function(e,t,n){const a=[],l=e.x,r=e.y,i=e.vision*n;if(i<=0)return a;const s=2*Math.PI/360;for(let e=0;e<360;e++){const c=e*s,d=Math.cos(c),u=Math.sin(c);for(let e=0;e<=i;e+=n/2){const i=l+d*e,s=r+u*e;if(o(l,r,i,s,t))break;const c=Math.floor(i/n),h=Math.floor(s/n);a.some(e=>e.x===c&&e.y===h)||a.push({x:c,y:h})}}return a},calculateFOVShadowCasting:function(e,t,o,n,a){const l=new Set,r=Math.floor(e/a),i=Math.floor(t/a);l.add(`${r},${i}`);const c=[[1,0],[1,1],[0,1],[-1,1],[-1,0],[-1,-1],[0,-1],[1,-1]];for(const[e,t]of c)s(r,i,o,1,1,0,e,t,0,0,n,a,l);return l},getKeyAngles:function(e,t,o,n,a){const l=new Set;let r=n;if(a){const l={x:e-o,y:t-o,width:2*o,height:2*o};r=d(n,a).query(l),r.length<n.length&&console.log(`  🔍 视野优化: 只检查 ${r.length}/${n.length} 道墙 (节省 ${Math.round(100*(1-r.length/n.length))}%)`)}for(const n of r){if(!u(n))continue;const[a,r,i,s]=n.c;if(Math.sqrt((a-e)**2+(r-t)**2)<=1.2*o){const o=Math.atan2(r-t,a-e);l.add(o-1e-4),l.add(o-1e-5),l.add(o),l.add(o+1e-5),l.add(o+1e-4)}if(Math.sqrt((i-e)**2+(s-t)**2)<=1.2*o){const o=Math.atan2(s-t,i-e);l.add(o-1e-4),l.add(o-1e-5),l.add(o),l.add(o+1e-5),l.add(o+1e-4)}const c=(a+i)/2,d=(r+s)/2;if(Math.sqrt((c-e)**2+(d-t)**2)<=1.2*o){const o=Math.atan2(d-t,c-e);l.add(o-1e-5),l.add(o),l.add(o+1e-5)}}for(let e=0;e<8;e++)l.add(e*Math.PI/4);if(l.size<36)for(let e=0;e<36;e++)l.add(e*Math.PI*2/36);return Array.from(l).sort((e,t)=>e-t)},buildQuadTree:d,castRay:function(e,t,o,n,a,l){const r=e+Math.cos(o)*n,i=t+Math.sin(o)*n;let s=n,c=r,m=i,p=a;if(l){const o=d(a,l),n=10,s={x:Math.min(e,r)-n,y:Math.min(t,i)-n,width:Math.abs(r-e)+2*n,height:Math.abs(i-t)+2*n};p=o.query(s)}for(const o of p){if(!u(o))continue;const[n,a,l,d]=o.c,p=h(e,t,r,i,n,a,l,d);if(p){const o=Math.sqrt((p.x-e)**2+(p.y-t)**2);o<s&&(s=o,c=p.x,m=p.y)}}if(s<n){const o=2,n=Math.max(0,(s-o)/s);c=e+(c-e)*n,m=t+(m-t)*n}return{x:c,y:m}},shouldBlockVision:u}}(),ee=(0,a.computed)(()=>({x:0,y:0,width:n.mapData.width,height:n.mapData.height}));function te(){if(!T)return;if(T.clear(),!b.value)return;const{width:e,height:t,grid:o,gridColor:a,gridAlpha:l}=n.mapData;T.lineStyle(1,parseInt(a.replace('#','0x')),l);for(let n=0;n<=e;n+=o)T.moveTo(n,0),T.lineTo(n,t);for(let n=0;n<=t;n+=o)T.moveTo(0,n),T.lineTo(e,n);T.stroke()}function oe(){if(!B)return;B.clear(),console.log(`🧱 绘制 ${n.mapData.walls.length} 道墙壁`);let e=0,t=0,o=0;for(const a of n.mapData.walls){const[n,l,r,i]=a.c;let s=16777215,c=1,d=10;1===a.door?(1===a.ds?(s=13808780,d=8,c=.6):(s=9127187,d=15,c=1),e++):2===a.door?(s=9662683,c=.8,d=10):0===a.sense?(s=4286945,c=.7,d=8,t++):o++,B.lineStyle(d,s,c),B.moveTo(n,l),B.lineTo(r,i),B.stroke()}console.log(`  - 普通墙: ${o} 道（白色）`),console.log(`  - 门: ${e} 道（棕色）`),console.log(`  - 窗户: ${t} 道（蓝色）`)}function ne(){if(O)if(O.removeChildren(),x.value){console.log(`💡 绘制 ${n.mapData.lights.length} 个光源`);for(const t of n.mapData.lights){const o=new l.Graphics,a=t.dim*n.mapData.grid,r=t.bright*n.mapData.grid,i=parseInt(t.tintColor.replace('#','0x'));a>0&&(o.circle(t.x,t.y,a),o.fill({color:i,alpha:.4*t.tintAlpha})),r>0&&(o.circle(t.x,t.y,r),o.fill({color:i,alpha:.8*t.tintAlpha})),o.circle(t.x,t.y,30),o.fill({color:16776960,alpha:1}),o.circle(t.x,t.y,50),o.stroke({width:5,color:16777215,alpha:.8}),O.addChild(o),e.to(o,{alpha:.8,duration:1+Math.random(),repeat:-1,yoyo:!0,ease:'power1.inOut'})}console.log(`  - 第一个光源位置: (${n.mapData.lights[0].x}, ${n.mapData.lights[0].y})`),console.log(`  - tintAlpha: ${n.mapData.lights[0].tintAlpha}`)}else console.log('💡 光照系统已关闭')}function ae(){if(!I)return;I.removeChildren();const e=n.tokens||n.mapData.tokens||[];console.log(`🎮 绘制 ${e.length} 个 Token`);for(const t of e){const e=new l.Graphics,o=t.width*n.mapData.grid,a=t.x,r=t.y;e.circle(a,r,o/2),e.fill({color:65280,alpha:.8}),e.stroke({width:8,color:16777215}),e.circle(a,r,o/2+15),e.stroke({width:4,color:16776960,alpha:.8});const i=new l.Text({text:t.name,style:{fontSize:32,fill:16777215,stroke:{color:0,width:4},fontWeight:'bold'}});i.anchor.set(.5),i.x=a,i.y=r+o/2+40,e.addChild(i),console.log(`  - Token "${t.name}" 位置: (${a}, ${r}), 大小: ${o}px`),e.eventMode='dynamic',e.cursor='pointer',e.hitArea=new l.Circle(a,r,o/2+20);let s=!1,c=null,d={x:a,y:r};e.on('pointerdown',o=>{o.stopPropagation(),s=!0,U=!0;const n=o.global,a=C.stage.toLocal(n);c={x:a.x,y:a.y},d={x:t.x,y:t.y},E.value=t,v('tokenSelect',t),e.cursor='grabbing'}),e.on('pointerup',o=>{s&&(o.stopPropagation(),console.log(`🖱️ 停止拖动: ${t.name}`),e.cursor='grab',v('tokenMove',t,t.x,t.y),w.value&&(P=!0,le())),s=!1,U=!1,c=null}),e.on('pointermove',o=>{if(s&&c){o.stopPropagation();const l=o.global,i=C.stage.toLocal(l),s=i.x-c.x,u=i.y-c.y,h=d.x+s,m=d.y+u,p=t.width*n.mapData.grid/2;if(!!X(t.x,t.y,h,m,n.mapData.walls,p,ee.value))return;e.x=h-a,e.y=m-r,t.x=h,t.y=m}}),e.on('pointerover',()=>{s||(e.cursor='grab')}),e.on('pointerout',()=>{s||(e.cursor='pointer')}),I.addChild(e)}}function le(){if(!j||!A)return;if(!P)return void console.log('👁️ 战争迷雾无需更新（使用缓存）');const e=performance.now();if(!w.value)return R&&A.children.includes(R)&&(A.removeChild(R),R.destroy(),R=null),void(P=!1);const t=n.tokens||n.mapData.tokens||[],o=j.getContext('2d');if(!o)return;o.clearRect(0,0,j.width,j.height),o.fillStyle='rgba(0, 0, 0, 0.8)',o.fillRect(0,0,j.width,j.height),o.globalCompositeOperation='destination-out';for(const e of t){if(e.vision<=0)continue;const t=re(e);if(t.length>0){console.log(`🔍 Token "${e.name}" 位置: (${Math.floor(e.x)}, ${Math.floor(e.y)})`),console.log('  视野多边形顶点数: '+t.length/2),o.beginPath(),o.moveTo(t[0],t[1]);for(let e=2;e<t.length;e+=2)o.lineTo(t[e],t[e+1]);o.closePath(),o.fillStyle='rgba(255, 255, 255, 1)',o.fill()}}o.globalCompositeOperation='source-over',R&&A.children.includes(R)&&(A.removeChild(R),R.destroy(),R=null),J&&(J.destroy(!0),J=null),J=l.Texture.from(j),R=new l.Sprite(J),A.addChild(R);const a=performance.now();console.log(`👁️ 更新战争迷雾完成，耗时: ${(a-e).toFixed(2)}ms`),P=!1}function re(e){const t=e.vision*n.mapData.grid;if(t<=0)return[];const o=10*Math.round(e.x/10),a=10*Math.round(e.y/10),l=`${e.id}-${o}-${a}`,r=H(e.x,e.y,t,n.mapData.walls,ee.value);console.log(`🔍 Token "${e.name}" 关键角度: ${r.length}个`);const i=[];for(const o of r){const a=ie(e.x,e.y,o,t,n.mapData.walls);i.push({angle:o,...a})}i.sort((e,t)=>e.angle-t.angle);const s=[];let c=null,d=null;for(const e of i){if(null!==c&&null!==d){const t=e.x-c,o=e.y-d;if(Math.sqrt(t*t+o*o)<1)continue}s.push(e.x,e.y),c=e.x,d=e.y}if(L.size>100){const e=L.keys().next().value;L.delete(e)}return L.set(l,s),console.log(`  📊 投射了 ${r.length} 条光线`),s}function ie(e,t,o,n,a){const l=Q(e,t,o,n,a,ee.value),r=Math.sqrt((l.x-e)**2+(l.y-t)**2);return{...l,dist:r}}function se(){let e=0;for(const t of M.value)1!==t.ds&&(t.ds=1,e++);e>0?(console.log(`🔓 打开了 ${e} 道门`),oe(),w.value&&(L.clear(),P=!0,le()),toastr.success(`🔓 已打开 ${e} 道门`)):toastr.info('所有门都已经是开启状态')}function ce(){let e=0;for(const t of M.value)0!==t.ds&&(t.ds=0,e++);e>0?(console.log(`🔒 关闭了 ${e} 道门`),oe(),w.value&&(L.clear(),P=!0,le()),toastr.success(`🔒 已关闭 ${e} 道门`)):toastr.info('所有门都已经是关闭状态')}function de(){if(!C||!y.value)return;const e=y.value.clientWidth,t=y.value.clientHeight,o=n.mapData.width,a=n.mapData.height,l=.9*e/o,r=.9*t/a,i=Math.min(l,r);W.value.scale=i,C.stage.scale.set(i);const s=o*i,c=a*i;C.stage.x=(e-s)/2,C.stage.y=(t-c)/2,console.log(`🗺️ 地图已自动缩放: ${(100*i).toFixed(1)}% (${o}x${a} → ${Math.round(s)}x${Math.round(c)})`)}function ue(){W.value.scale*=1.2,e.to(C.stage.scale,{x:W.value.scale,y:W.value.scale,duration:.3})}function he(){W.value.scale*=.8,e.to(C.stage.scale,{x:W.value.scale,y:W.value.scale,duration:.3})}function me(){de()}function pe(){b.value=!b.value,te()}function fe(){w.value=!w.value,P=!0,le()}function ge(){x.value=!x.value,ne()}function ve(){V.value=!V.value,S&&(S.visible=V.value)}return(0,a.onMounted)(async()=>{if(!y.value||!k.value)return;C=new l.Application,await C.init({canvas:k.value,width:y.value.clientWidth,height:y.value.clientHeight,backgroundColor:n.mapData.backgroundColor||'#1a1a1a',antialias:!0});const t=new l.Container,o=new l.Container,r=new l.Container;O=new l.Container,I=new l.Container;const i=new l.Container;if(A=new l.Container,i.eventMode='none',A.eventMode='none',C.stage.addChild(t),C.stage.addChild(o),C.stage.addChild(r),C.stage.addChild(O),C.stage.addChild(I),C.stage.addChild(i),C.stage.addChild(A),n.mapData.img){const e=await l.Assets.load(n.mapData.img);D=new l.Sprite(e),D.width=n.mapData.width,D.height=n.mapData.height,t.addChild(D)}if(n.mapData.foreground){const e=await l.Assets.load(n.mapData.foreground);S=new l.Sprite(e),S.width=n.mapData.width,S.height=n.mapData.height,i.addChild(S),toastr.info('已加载前景层 (遮挡物)')}T=new l.Graphics,o.addChild(T),te(),B=new l.Graphics,r.addChild(B),oe(),console.log('🌳 正在构建四叉树空间分区...'),K(n.mapData.walls,ee.value),console.log('✅ 四叉树构建完成,碰撞检测性能已优化!'),ne(),ae(),j=document.createElement('canvas'),j.width=n.mapData.width,j.height=n.mapData.height,w.value&&(P=!0,le()),function(){if(!C)return;let t=!1,o={x:0,y:0};C.stage.eventMode='static',window.addEventListener('keydown',e=>{'Space'!==e.code||q||(q=!0,k.value&&(k.value.style.cursor='grab'))}),window.addEventListener('keyup',e=>{'Space'===e.code&&(q=!1,k.value&&!t&&(k.value.style.cursor='default'))}),C.stage.on('pointerdown',e=>{(q||e.target===C?.stage&&!U)&&(t=!0,o={x:e.globalX,y:e.globalY},k.value&&(k.value.style.cursor='grabbing'))}),C.stage.on('pointerup',()=>{t&&(t=!1,k.value&&(k.value.style.cursor=q?'grab':'default'))}),C.stage.on('pointermove',e=>{if((!U||q)&&t){const t=e.globalX-o.x,n=e.globalY-o.y;C.stage.x+=t,C.stage.y+=n,o={x:e.globalX,y:e.globalY}}}),k.value?.addEventListener('wheel',t=>{t.preventDefault();const o=t.deltaY>0?.9:1.1,n=W.value.scale*o;n>=.1&&n<=5&&(W.value.scale=n,e.to(C.stage.scale,{x:n,y:n,duration:.2,ease:'power2.out'}))})}(),de();const s=new ResizeObserver(()=>{C&&y.value&&C.renderer.resize(y.value.clientWidth,y.value.clientHeight)});s.observe(y.value),(0,a.onUnmounted)(()=>{s.disconnect()})}),(0,a.watch)(()=>n.tokens,()=>{U||(ae(),w.value&&(P=!0,le()))},{deep:!0}),(0,a.onUnmounted)(()=>{J&&J.destroy(!0),R&&R.destroy(),C?.destroy(!0)}),(e,t)=>((0,a.openBlock)(),(0,a.createElementBlock)('div',{class:'map-canvas-container',ref_key:'containerRef',ref:y},[(0,a.createElementVNode)('canvas',{ref_key:'canvasRef',ref:k},null,512),(0,a.createCommentVNode)(' 控制面板 '),(0,a.createElementVNode)('div',s,[(0,a.createElementVNode)('button',{onClick:ue,title:'放大'},[...t[3]||(t[3]=[(0,a.createElementVNode)('span',null,'🔍+',-1)])]),(0,a.createElementVNode)('button',{onClick:he,title:'缩小'},[...t[4]||(t[4]=[(0,a.createElementVNode)('span',null,'🔍-',-1)])]),(0,a.createElementVNode)('button',{onClick:me,title:'重置视图'},[...t[5]||(t[5]=[(0,a.createElementVNode)('span',null,'🏠',-1)])]),(0,a.createElementVNode)('button',{onClick:pe,title:'显示/隐藏网格'},[(0,a.createElementVNode)('span',null,(0,a.toDisplayString)(b.value?'⊞':'⊟'),1)]),(0,a.createElementVNode)('button',{onClick:fe,title:'战争迷雾'},[(0,a.createElementVNode)('span',null,(0,a.toDisplayString)(w.value?'🌫️':'☀️'),1)]),(0,a.createElementVNode)('button',{onClick:ge,title:'光照系统'},[(0,a.createElementVNode)('span',null,(0,a.toDisplayString)(x.value?'💡':'🔦'),1)]),n.mapData.foreground?((0,a.openBlock)(),(0,a.createElementBlock)('button',{key:0,onClick:ve,title:'显示/隐藏前景层'},[(0,a.createElementVNode)('span',null,(0,a.toDisplayString)(V.value?'🏠':'🏚️'),1)])):(0,a.createCommentVNode)('v-if',!0),M.value.length>0?((0,a.openBlock)(),(0,a.createElementBlock)('button',{key:1,onClick:t[0]||(t[0]=e=>N.value=!N.value),title:'门控制面板'},[(0,a.createElementVNode)('span',null,(0,a.toDisplayString)(N.value?'🚪':'🚧'),1)])):(0,a.createCommentVNode)('v-if',!0)]),(0,a.createCommentVNode)(' 🆕 门控制面板 '),N.value&&M.value.length>0?((0,a.openBlock)(),(0,a.createElementBlock)('div',c,[(0,a.createElementVNode)('div',d,[(0,a.createElementVNode)('h3',null,'🚪 门控制 ('+(0,a.toDisplayString)(M.value.length)+')',1),(0,a.createElementVNode)('button',{onClick:t[1]||(t[1]=e=>N.value=!1)},'✖')]),(0,a.createElementVNode)('div',u,[(0,a.createElementVNode)('div',{class:'panel-actions'},[(0,a.createElementVNode)('button',{onClick:se,class:'batch-btn'},'🔓 全部开门'),(0,a.createElementVNode)('button',{onClick:ce,class:'batch-btn'},'🔒 全部关门')]),((0,a.openBlock)(!0),(0,a.createElementBlock)(a.Fragment,null,(0,a.renderList)(M.value,(e,t)=>((0,a.openBlock)(),(0,a.createElementBlock)('div',{key:t,class:'door-item'},[(0,a.createElementVNode)('div',h,[(0,a.createElementVNode)('span',m,'门 '+(0,a.toDisplayString)(t+1),1),(0,a.createElementVNode)('span',p,'('+(0,a.toDisplayString)(Math.floor(e.c[0]))+', '+(0,a.toDisplayString)(Math.floor(e.c[1]))+')',1)]),(0,a.createElementVNode)('button',{onClick:t=>function(e){e.ds=1===e.ds?0:1,console.log('🚪 门状态切换: '+(1===e.ds?'开门':'关门'),e.c),oe(),w.value&&(L.clear(),P=!0,le()),toastr.info(1===e.ds?'🔓 门已打开':'🔒 门已关闭')}(e),class:(0,a.normalizeClass)(['door-toggle',1===e.ds?'open':'closed'])},(0,a.toDisplayString)(1===e.ds?'🔓 开门':'🔒 关门'),11,f)]))),128))])])):(0,a.createCommentVNode)('v-if',!0),(0,a.createCommentVNode)(' Token 信息面板 '),E.value?((0,a.openBlock)(),(0,a.createElementBlock)('div',g,[(0,a.createElementVNode)('h3',null,(0,a.toDisplayString)(E.value.name),1),(0,a.createElementVNode)('p',null,'位置: ('+(0,a.toDisplayString)(Math.floor(E.value.x))+', '+(0,a.toDisplayString)(Math.floor(E.value.y))+')',1),(0,a.createElementVNode)('p',null,'视野: '+(0,a.toDisplayString)(E.value.vision)+' 格',1),(0,a.createElementVNode)('button',{onClick:t[2]||(t[2]=e=>E.value=null)},'关闭')])):(0,a.createCommentVNode)('v-if',!0)],512))}});var y=n(42);const k=(0,y.A)(v,[['__scopeId','data-v-f6ba9c7a']]),b=_;var w=n.n(b);const x=z,V=x.z.object({x:x.z.number(),y:x.z.number(),dim:x.z.number().default(0),bright:x.z.number().default(0),tintColor:x.z.string().default('#ffffff'),tintAlpha:x.z.number().min(0).max(1).default(.5),animation:x.z.object({type:x.z.string().optional(),speed:x.z.number().optional(),intensity:x.z.number().optional()}).optional()}),E=x.z.object({c:x.z.tuple([x.z.number(),x.z.number(),x.z.number(),x.z.number()]),move:x.z.union([x.z.literal(0),x.z.literal(1)]).default(1),sense:x.z.union([x.z.literal(0),x.z.literal(1)]).default(1),sound:x.z.union([x.z.literal(0),x.z.literal(1)]).default(1),door:x.z.union([x.z.literal(0),x.z.literal(1),x.z.literal(2)]).default(0),ds:x.z.union([x.z.literal(0),x.z.literal(1)]).optional()}),N=x.z.object({id:x.z.string(),name:x.z.string().default('未命名'),x:x.z.number(),y:x.z.number(),width:x.z.number().default(1),height:x.z.number().default(1),img:x.z.string().optional(),vision:x.z.number().default(0),dimVision:x.z.number().default(0),rotation:x.z.number().default(0),hidden:x.z.boolean().default(!1),elevation:x.z.number().default(0)}),M=x.z.object({name:x.z.string().default('未命名地图'),width:x.z.number().positive(),height:x.z.number().positive(),grid:x.z.number().positive().default(100),shiftX:x.z.number().default(0),shiftY:x.z.number().default(0),gridDistance:x.z.number().positive().default(5),gridUnits:x.z.string().default('ft'),padding:x.z.number().default(0),gridColor:x.z.string().default('#000000'),gridAlpha:x.z.number().min(0).max(1).default(.2),globalLight:x.z.boolean().default(!0),darkness:x.z.number().min(0).max(1).default(0),backgroundColor:x.z.string().default('#000000'),img:x.z.string().nullable().optional(),foreground:x.z.string().nullable().optional(),lights:x.z.array(V).default([]),walls:x.z.array(E).default([]),tokens:x.z.array(N).default([]),fogOfWar:x.z.object({enabled:x.z.boolean().default(!1),explored:x.z.array(x.z.array(x.z.boolean())).optional()}).default({enabled:!1})}),C=x.z.object({mapId:x.z.string(),tokens:x.z.array(N),fogExplored:x.z.array(x.z.array(x.z.boolean())).optional(),viewport:x.z.object({x:x.z.number().default(0),y:x.z.number().default(0),scale:x.z.number().default(1)}).default({})});function D(e){const t=t=>{try{const o=`vtt_map_${e}`,n=w().cloneDeep(t);replaceVariables({[o]:n},{type:'chat'})}catch(e){console.error('保存地图状态失败:',e)}},o=(0,a.ref)((()=>{try{const t=getVariables({type:'chat'}),o=`vtt_map_${e}`;if(t[o]){const n=t[o];return'object'!=typeof n||null===n||'mapId'in n||(n.mapId=e),C.parse(n)}}catch(t){console.warn('加载地图状态失败，使用默认状态:',t);try{const t=`vtt_map_${e}`;replaceVariables({[t]:void 0},{type:'chat'})}catch{}}return{mapId:e,tokens:[],viewport:{x:0,y:0,scale:1}}})()),n=w().debounce(e=>{t(e)},1e3);(0,a.watch)(o,e=>{n(e)},{deep:!0});return{state:o,updateTokenPosition:(e,t,n)=>{const a=o.value.tokens.find(t=>t.id===e);a&&(a.x=t,a.y=n)},addToken:e=>{o.value.tokens.find(t=>t.id===e.id)||o.value.tokens.push(e)},removeToken:e=>{const t=o.value.tokens.findIndex(t=>t.id===e);-1!==t&&o.value.tokens.splice(t,1)},updateViewport:(e,t,n)=>{o.value.viewport={x:e,y:t,scale:n}},markExplored:(e,t)=>{o.value.fogExplored||(o.value.fogExplored=[]),o.value.fogExplored[t]||(o.value.fogExplored[t]=[]),o.value.fogExplored[t][e]=!0},isExplored:(e,t)=>o.value.fogExplored?.[t]?.[e]??!1,saveState:()=>t(o.value)}}const S={class:'vtt-viewer'},T={key:0,class:'loading'},B={key:1,class:'error'},O={class:'error-actions'},I={key:2,class:'upload-dialog'},A={class:'upload-content'},U={class:'upload-actions'},q={class:'toolbar'},L={class:'toolbar-actions'},j={class:'map-wrapper'},R={key:0,class:'side-panel token-manager'},J={class:'panel-header'},P={class:'panel-content'},W={class:'token-header'},F=['onClick'],X={class:'token-details'},Y=['onUpdate:modelValue'],G=['onUpdate:modelValue'],H=['onUpdate:modelValue'],K=['onUpdate:modelValue'],Q=['onUpdate:modelValue'],Z={key:1,class:'side-panel map-info'},ee={class:'panel-header'},te={class:'panel-content'},oe={class:'info-item'},ne={class:'info-item'},ae={class:'info-item'},le={class:'info-item'},re={class:'info-item'},ie={class:'info-item'},se={class:'info-item'},ce=(0,a.defineComponent)({__name:'App',setup(e){const t=(0,a.ref)(!0),o=(0,a.ref)(null),n=(0,a.ref)(null),l=(0,a.ref)(!1),r=(0,a.ref)(!1),i=(0,a.ref)(!1),s=(0,a.ref)(''),c=(0,a.ref)(null),d=(0,a.computed)(()=>{const e=n.value?.tokens||[],t=c.value?.state?.value?.tokens||[];if(console.log('🔍 currentTokens 计算:'),console.log(`  - mapData.tokens: ${e.length} 个`),console.log(`  - mapStateManager.tokens: ${t.length} 个`),console.log(`  - mapStateManager 存在: ${!!c.value}`),!c.value)return console.log(`  ✅ 返回 mapData.tokens (${e.length} 个)`),e;const o=t.length>0?t:e;return console.log(`  ✅ 返回: ${o.length} 个 Token`),o});function u(){const e={name:'示例地图',width:3e3,height:2e3,grid:100,gridDistance:5,gridUnits:'ft',backgroundColor:'#1a1a1a',globalLight:!1,darkness:.5,img:null,foreground:null,lights:[{x:500,y:500,dim:8,bright:4,tintColor:'#ffaa00',tintAlpha:.5},{x:1500,y:1e3,dim:10,bright:5,tintColor:'#ffffff',tintAlpha:.8}],walls:[{c:[0,0,3e3,0],move:1,sense:1,sound:1,door:0},{c:[3e3,0,3e3,2e3],move:1,sense:1,sound:1,door:0},{c:[3e3,2e3,0,2e3],move:1,sense:1,sound:1,door:0},{c:[0,2e3,0,0],move:1,sense:1,sound:1,door:0}],tokens:[{id:'token1',name:'玩家',x:500,y:500,width:1,vision:12}],fogOfWar:{enabled:!1}};try{const a=M.parse(e);n.value=a,c.value=D(a.name),c.value?.state?.value?.tokens&&0===c.value.state.value.tokens.length&&a.tokens&&a.tokens.length>0&&a.tokens.forEach(e=>c.value?.addToken(e)),o.value=null,t.value=!1,i.value=!1,toastr.success('示例地图加载成功')}catch(e){o.value=e instanceof Error?e.message:String(e),toastr.error('示例地图加载失败: '+o.value)}}function h(e){const t=e.target.files?.[0];if(!t)return;const o=new FileReader;o.onload=e=>{s.value=e.target?.result,console.log(`📁 文件已上传: ${t.name} (${t.size} 字节)`),m()},o.readAsText(t)}function m(){try{console.log('开始解析 JSON...');const e=JSON.parse(s.value);console.log('JSON 解析成功，数据:',e),console.log('开始 Zod 验证...');const a=M.parse(e);console.log('Zod 验证成功'),n.value=a,console.log(`📊 地图数据: ${a.tokens?.length||0} 个 Token`);const l=`vtt_map_${a.name}`,r=getVariables({type:'chat'});r[l]&&(console.log(`🗑️ 清除旧的地图状态: ${l}`),delete r[l],replaceVariables(r,{type:'chat'})),c.value=D(a.name),console.log(`📊 状态管理器: ${c.value?.state?.value?.tokens?.length||0} 个 Token`),a.tokens&&a.tokens.length>0?(console.log(`✅ 添加 ${a.tokens.length} 个 Token 到状态管理器`),a.tokens.forEach(e=>{c.value?.addToken(e),console.log(`  - 添加 Token: ${e.name} (${e.x}, ${e.y})`)})):console.log('⚠️ 地图数据中没有 Token');const d=getVariables({type:'script',script_id:getScriptId()});d.vtt_map_data=a,replaceVariables(d,{type:'script',script_id:getScriptId()}),o.value=null,t.value=!1,i.value=!1,s.value='',toastr.success(`地图 "${a.name}" 加载成功`)}catch(e){console.error('详细错误:',e),e instanceof Error&&console.error('错误堆栈:',e.stack),toastr.error('JSON 解析失败: '+(e instanceof Error?e.message:String(e)))}}async function p(){t.value=!0,o.value=null;try{const e=getVariables({type:'script',script_id:getScriptId()});if(!e.vtt_map_url&&!e.vtt_map_data)throw new Error('未配置地图数据。请在脚本变量中设置 vtt_map_url 或 vtt_map_data');let t;if(e.vtt_map_url){const o=await fetch(e.vtt_map_url);t=await o.json()}else t=e.vtt_map_data;const o=M.parse(t);n.value=o,c.value=D(o.name),c.value?.state?.value?.tokens&&0===c.value.state.value.tokens.length&&o.tokens&&o.tokens.length>0&&o.tokens.forEach(e=>{c.value?.addToken(e)}),toastr.success(`地图 "${o.name}" 加载成功`)}catch(e){o.value=e instanceof Error?e.message:String(e),toastr.error('地图加载失败: '+o.value)}finally{t.value=!1}}function f(e,t,o){c.value?.updateTokenPosition(e.id,t,o)}function g(e){console.log('选中 Token:',e)}function v(){if(!c.value?.addToken||!n.value)return;const e=N.parse({id:`token_${Date.now()}`,name:`Token ${d.value.length+1}`,x:n.value.width/2,y:n.value.height/2,width:1,height:1,vision:12});c.value.addToken(e),toastr.success(`添加了新的 Token: ${e.name}`)}function y(){if(!c.value?.state?.value)return;const e=c.value.state.value,t=JSON.stringify(e,null,2);navigator.clipboard.writeText(t).then(()=>{toastr.success('状态已复制到剪贴板')}).catch(()=>{const e=new Blob([t],{type:'application/json'}),o=URL.createObjectURL(e),a=document.createElement('a');a.href=o,a.download=`${n.value?.name}_state.json`,a.click(),URL.revokeObjectURL(o)})}function b(){const e=prompt('请粘贴地图状态 JSON:');if(e)try{const t=JSON.parse(e);replaceVariables({[`vtt_map_${n.value?.name}`]:t},{type:'chat'}),toastr.success('状态导入成功,正在重新加载...'),setTimeout(()=>location.reload(),1e3)}catch(e){toastr.error('导入失败: '+(e instanceof Error?e.message:String(e)))}}return(0,a.onMounted)(()=>{p()}),(e,w)=>((0,a.openBlock)(),(0,a.createElementBlock)('div',S,[t.value?((0,a.openBlock)(),(0,a.createElementBlock)('div',T,[...w[7]||(w[7]=[(0,a.createElementVNode)('div',{class:'spinner'},null,-1),(0,a.createElementVNode)('p',null,'加载地图中...',-1)])])):o.value?((0,a.openBlock)(),(0,a.createElementBlock)('div',B,[w[8]||(w[8]=(0,a.createElementVNode)('h2',null,'❌ 加载失败',-1)),(0,a.createElementVNode)('pre',null,(0,a.toDisplayString)(o.value),1),(0,a.createElementVNode)('div',O,[(0,a.createElementVNode)('button',{onClick:p},'重试'),(0,a.createElementVNode)('button',{onClick:w[0]||(w[0]=e=>i.value=!0)},'📁 上传地图 JSON'),(0,a.createElementVNode)('button',{onClick:u},'🎲 加载示例地图')])])):(0,a.createCommentVNode)('v-if',!0),(0,a.createCommentVNode)(' 上传对话框 '),i.value?((0,a.openBlock)(),(0,a.createElementBlock)('div',I,[(0,a.createElementVNode)('div',A,[w[9]||(w[9]=(0,a.createElementVNode)('h3',null,'上传地图 JSON 文件',-1)),(0,a.createElementVNode)('input',{type:'file',accept:'.json',onChange:h},null,32),w[10]||(w[10]=(0,a.createElementVNode)('p',{class:'upload-hint'},'或粘贴 JSON 内容:',-1)),(0,a.withDirectives)((0,a.createElementVNode)('textarea',{'onUpdate:modelValue':w[1]||(w[1]=e=>s.value=e),placeholder:'粘贴 VTT 地图 JSON...',rows:'10'},null,512),[[a.vModelText,s.value]]),(0,a.createElementVNode)('div',U,[(0,a.createElementVNode)('button',{onClick:m},'加载'),(0,a.createElementVNode)('button',{onClick:w[2]||(w[2]=e=>i.value=!1)},'取消')])])])):n.value?((0,a.openBlock)(),(0,a.createElementBlock)(a.Fragment,{key:3},[(0,a.createCommentVNode)(' 顶部工具栏 '),(0,a.createElementVNode)('div',q,[(0,a.createElementVNode)('h2',null,(0,a.toDisplayString)(n.value.name),1),(0,a.createElementVNode)('div',L,[(0,a.createElementVNode)('button',{onClick:w[3]||(w[3]=e=>l.value=!l.value)},'🎭 Token 管理'),(0,a.createElementVNode)('button',{onClick:w[4]||(w[4]=e=>r.value=!r.value)},'ℹ️ 地图信息'),(0,a.createElementVNode)('button',{onClick:y},'💾 导出状态'),(0,a.createElementVNode)('button',{onClick:b},'📁 导入状态')])]),(0,a.createCommentVNode)(' 地图画布 '),(0,a.createElementVNode)('div',j,[(0,a.createVNode)(k,{'map-data':n.value,tokens:d.value,onTokenMove:f,onTokenSelect:g},null,8,['map-data','tokens'])]),(0,a.createCommentVNode)(' Token 管理面板 '),l.value?((0,a.openBlock)(),(0,a.createElementBlock)('div',R,[(0,a.createElementVNode)('div',J,[w[11]||(w[11]=(0,a.createElementVNode)('h3',null,'Token 管理',-1)),(0,a.createElementVNode)('button',{onClick:w[5]||(w[5]=e=>l.value=!1)},'✖')]),(0,a.createElementVNode)('div',P,[(0,a.createElementVNode)('button',{onClick:v,class:'add-token-btn'},'➕ 添加 Token'),((0,a.openBlock)(!0),(0,a.createElementBlock)(a.Fragment,null,(0,a.renderList)(d.value,e=>((0,a.openBlock)(),(0,a.createElementBlock)('div',{key:e.id,class:'token-item'},[(0,a.createElementVNode)('div',W,[(0,a.createElementVNode)('strong',null,(0,a.toDisplayString)(e.name),1),(0,a.createElementVNode)('button',{onClick:t=>{return o=e.id,void(c.value?.removeToken&&confirm('确定要删除这个 Token 吗?')&&(c.value.removeToken(o),toastr.success('Token 已删除')));var o},class:'delete-btn'},'🗑️',8,F)]),(0,a.createElementVNode)('div',X,[(0,a.createElementVNode)('label',null,[w[12]||(w[12]=(0,a.createTextVNode)(' 名称: ',-1)),(0,a.withDirectives)((0,a.createElementVNode)('input',{'onUpdate:modelValue':t=>e.name=t,type:'text'},null,8,Y),[[a.vModelText,e.name]])]),(0,a.createElementVNode)('label',null,[w[13]||(w[13]=(0,a.createTextVNode)(' X: ',-1)),(0,a.withDirectives)((0,a.createElementVNode)('input',{'onUpdate:modelValue':t=>e.x=t,type:'number',step:'10'},null,8,G),[[a.vModelText,e.x,void 0,{number:!0}]])]),(0,a.createElementVNode)('label',null,[w[14]||(w[14]=(0,a.createTextVNode)(' Y: ',-1)),(0,a.withDirectives)((0,a.createElementVNode)('input',{'onUpdate:modelValue':t=>e.y=t,type:'number',step:'10'},null,8,H),[[a.vModelText,e.y,void 0,{number:!0}]])]),(0,a.createElementVNode)('label',null,[w[15]||(w[15]=(0,a.createTextVNode)(' 视野范围: ',-1)),(0,a.withDirectives)((0,a.createElementVNode)('input',{'onUpdate:modelValue':t=>e.vision=t,type:'number',min:'0',max:'100'},null,8,K),[[a.vModelText,e.vision,void 0,{number:!0}]])]),(0,a.createElementVNode)('label',null,[w[16]||(w[16]=(0,a.createTextVNode)(' 尺寸: ',-1)),(0,a.withDirectives)((0,a.createElementVNode)('input',{'onUpdate:modelValue':t=>e.width=t,type:'number',min:'1',max:'10'},null,8,Q),[[a.vModelText,e.width,void 0,{number:!0}]])])])]))),128))])])):(0,a.createCommentVNode)('v-if',!0),(0,a.createCommentVNode)(' 地图信息面板 '),r.value?((0,a.openBlock)(),(0,a.createElementBlock)('div',Z,[(0,a.createElementVNode)('div',ee,[w[17]||(w[17]=(0,a.createElementVNode)('h3',null,'地图信息',-1)),(0,a.createElementVNode)('button',{onClick:w[6]||(w[6]=e=>r.value=!1)},'✖')]),(0,a.createElementVNode)('div',te,[(0,a.createElementVNode)('div',oe,[w[18]||(w[18]=(0,a.createElementVNode)('label',null,'地图名称:',-1)),(0,a.createElementVNode)('span',null,(0,a.toDisplayString)(n.value.name),1)]),(0,a.createElementVNode)('div',ne,[w[19]||(w[19]=(0,a.createElementVNode)('label',null,'尺寸:',-1)),(0,a.createElementVNode)('span',null,(0,a.toDisplayString)(n.value.width)+' × '+(0,a.toDisplayString)(n.value.height)+' px',1)]),(0,a.createElementVNode)('div',ae,[w[20]||(w[20]=(0,a.createElementVNode)('label',null,'网格:',-1)),(0,a.createElementVNode)('span',null,(0,a.toDisplayString)(n.value.grid)+' px ('+(0,a.toDisplayString)(n.value.gridDistance)+' '+(0,a.toDisplayString)(n.value.gridUnits)+')',1)]),(0,a.createElementVNode)('div',le,[w[21]||(w[21]=(0,a.createElementVNode)('label',null,'光源数量:',-1)),(0,a.createElementVNode)('span',null,(0,a.toDisplayString)(n.value.lights.length),1)]),(0,a.createElementVNode)('div',re,[w[22]||(w[22]=(0,a.createElementVNode)('label',null,'墙壁数量:',-1)),(0,a.createElementVNode)('span',null,(0,a.toDisplayString)(n.value.walls.length),1)]),(0,a.createElementVNode)('div',ie,[w[23]||(w[23]=(0,a.createElementVNode)('label',null,'全局光照:',-1)),(0,a.createElementVNode)('span',null,(0,a.toDisplayString)(n.value.globalLight?'是':'否'),1)]),(0,a.createElementVNode)('div',se,[w[24]||(w[24]=(0,a.createElementVNode)('label',null,'黑暗等级:',-1)),(0,a.createElementVNode)('span',null,(0,a.toDisplayString)((100*n.value.darkness).toFixed(0))+'%',1)])])])):(0,a.createCommentVNode)('v-if',!0)],64)):(0,a.createCommentVNode)('v-if',!0)]))}}),de=(0,y.A)(ce,[['__scopeId','data-v-7ec8e3e4']]);'undefined'!=typeof window&&'function'==typeof window.getScriptId||(void 0===window.$&&(window.$=e=>('function'==typeof e&&('loading'===document.readyState?document.addEventListener('DOMContentLoaded',e):e()),{on:()=>{}}),window.$.fn={}),void 0===window.toastr&&(window.toastr={success:e=>console.log('[Success]',e),error:e=>console.error('[Error]',e),info:e=>console.info('[Info]',e),warning:e=>console.warn('[Warning]',e)}),void 0===window.getScriptId&&(window.getScriptId=()=>'standalone-vtt-viewer',window.getVariables=e=>{const t='script'===e?.type?'vtt_script_vars':'vtt_chat_vars',o=localStorage.getItem(t);return o?JSON.parse(o):{}},window.replaceVariables=(e,t)=>{const o='script'===t?.type?'vtt_script_vars':'vtt_chat_vars',n={...window.getVariables(t),...e};localStorage.setItem(o,JSON.stringify(n))}));const $=window.$,ue=window.toastr;$(()=>{(0,a.createApp)(de).mount('#app'),ue.success('VTT 地图查看器已加载')}),$(window).on('pagehide',()=>{ue.info('VTT 地图查看器已卸载')});
//# sourceMappingURL=index.js.map</script><style>.map-canvas-container[data-v-f6ba9c7a]{position:relative;width:100%;height:100%;overflow:hidden;background:#1a1a1a}canvas[data-v-f6ba9c7a]{display:block;width:100%;height:100%}.map-controls[data-v-f6ba9c7a]{position:absolute;top:10px;right:10px;display:flex;flex-direction:column;gap:5px;z-index:10}.map-controls button[data-v-f6ba9c7a]{width:40px;height:40px;border:none;background:rgba(0,0,0,0.7);color:white;border-radius:5px;cursor:pointer;font-size:18px;transition:background 0.2s}.map-controls button[data-v-f6ba9c7a]:hover{background:rgba(0,0,0,0.9)}.door-panel[data-v-f6ba9c7a]{position:absolute;top:60px;left:10px;width:320px;max-height:500px;background:rgba(0,0,0,0.9);border:1px solid #333;border-radius:8px;overflow:hidden;display:flex;flex-direction:column;z-index:100;box-shadow:0 4px 6px rgba(0,0,0,0.3)}.door-panel .panel-header[data-v-f6ba9c7a]{display:flex;justify-content:space-between;align-items:center;padding:15px;background:rgba(139,69,19,0.3);border-bottom:1px solid #333}.door-panel .panel-header h3[data-v-f6ba9c7a]{margin:0;font-size:16px;color:white}.door-panel .panel-header button[data-v-f6ba9c7a]{background:none;border:none;color:white;font-size:18px;cursor:pointer;padding:0;width:auto;height:auto}.door-panel .panel-header button[data-v-f6ba9c7a]:hover{color:#ff6b6b}.door-panel .panel-content[data-v-f6ba9c7a]{flex:1;overflow-y:auto;padding:10px}.panel-actions[data-v-f6ba9c7a]{display:flex;gap:10px;margin-bottom:15px}.batch-btn[data-v-f6ba9c7a]{flex:1;padding:10px;border:none;border-radius:5px;cursor:pointer;font-size:14px;font-weight:bold;transition:all 0.2s}.batch-btn[data-v-f6ba9c7a]:first-child{background:#4caf50;color:white}.batch-btn[data-v-f6ba9c7a]:first-child:hover{background:#45a049;transform:translateY(-1px)}.batch-btn[data-v-f6ba9c7a]:last-child{background:#f44336;color:white}.batch-btn[data-v-f6ba9c7a]:last-child:hover{background:#da190b;transform:translateY(-1px)}.door-item[data-v-f6ba9c7a]{background:rgba(255,255,255,0.05);padding:12px;border-radius:5px;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center;transition:background 0.2s}.door-item[data-v-f6ba9c7a]:hover{background:rgba(255,255,255,0.1)}.door-info[data-v-f6ba9c7a]{display:flex;flex-direction:column;gap:5px}.door-name[data-v-f6ba9c7a]{font-weight:bold;color:white;font-size:14px}.door-position[data-v-f6ba9c7a]{font-size:12px;color:#aaa}.door-toggle[data-v-f6ba9c7a]{padding:8px 15px;border:none;border-radius:5px;cursor:pointer;font-size:14px;font-weight:bold;transition:all 0.2s;min-width:90px}.door-toggle.open[data-v-f6ba9c7a]{background:#4caf50;color:white}.door-toggle.open[data-v-f6ba9c7a]:hover{background:#45a049;transform:scale(1.05)}.door-toggle.closed[data-v-f6ba9c7a]{background:#f44336;color:white}.door-toggle.closed[data-v-f6ba9c7a]:hover{background:#da190b;transform:scale(1.05)}.token-info[data-v-f6ba9c7a]{position:absolute;bottom:10px;left:10px;background:rgba(0,0,0,0.8);color:white;padding:15px;border-radius:8px;min-width:200px;z-index:10}.token-info h3[data-v-f6ba9c7a]{margin:0 0 10px 0;font-size:16px}.token-info p[data-v-f6ba9c7a]{margin:5px 0;font-size:14px}.token-info button[data-v-f6ba9c7a]{margin-top:10px;padding:5px 10px;background:#4caf50;border:none;color:white;border-radius:4px;cursor:pointer}.token-info button[data-v-f6ba9c7a]:hover{background:#45a049}

.vtt-viewer[data-v-7ec8e3e4]{width:100%;height:100vh;display:flex;flex-direction:column;background:#1a1a1a;color:white;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif}.loading[data-v-7ec8e3e4],.error[data-v-7ec8e3e4]{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;gap:20px}.spinner[data-v-7ec8e3e4]{width:50px;height:50px;border:4px solid rgba(255,255,255,0.3);border-top-color:white;border-radius:50%;animation:spin-7ec8e3e4 1s linear infinite}@keyframes spin-7ec8e3e4{to{transform:rotate(360deg)}}.error pre[data-v-7ec8e3e4]{background:rgba(255,0,0,0.2);padding:15px;border-radius:5px;max-width:600px}.error-actions[data-v-7ec8e3e4]{display:flex;gap:10px}.error button[data-v-7ec8e3e4]{padding:10px 20px;background:#4caf50;border:none;color:white;border-radius:5px;cursor:pointer;transition:background 0.3s}.error button[data-v-7ec8e3e4]:hover{background:#66bb6a}.upload-dialog[data-v-7ec8e3e4]{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);display:flex;align-items:center;justify-content:center;z-index:1000}.upload-content[data-v-7ec8e3e4]{background:#2a2a2a;padding:30px;border-radius:10px;max-width:600px;width:90%}.upload-content h3[data-v-7ec8e3e4]{margin-top:0}.upload-content input[type='file'][data-v-7ec8e3e4]{width:100%;padding:10px;margin:10px 0;background:#1a1a1a;border:2px dashed #666;border-radius:5px;color:white;cursor:pointer}.upload-hint[data-v-7ec8e3e4]{margin:20px 0 10px;color:#aaa}.upload-content textarea[data-v-7ec8e3e4]{width:100%;padding:10px;background:#1a1a1a;border:1px solid #666;border-radius:5px;color:white;font-family:monospace;resize:vertical}.upload-actions[data-v-7ec8e3e4]{display:flex;gap:10px;margin-top:20px;justify-content:flex-end}.upload-actions button[data-v-7ec8e3e4]{padding:10px 20px;background:#4caf50;border:none;color:white;border-radius:5px;cursor:pointer}.upload-actions button[data-v-7ec8e3e4]:last-child{background:#666}.upload-actions button[data-v-7ec8e3e4]:hover{opacity:0.8}.toolbar[data-v-7ec8e3e4]{display:flex;justify-content:space-between;align-items:center;padding:10px 20px;background:rgba(0,0,0,0.8);border-bottom:2px solid #333}.toolbar h2[data-v-7ec8e3e4]{margin:0;font-size:20px}.toolbar-actions[data-v-7ec8e3e4]{display:flex;gap:10px}.toolbar-actions button[data-v-7ec8e3e4]{padding:8px 15px;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.3);color:white;border-radius:5px;cursor:pointer;transition:background 0.2s}.toolbar-actions button[data-v-7ec8e3e4]:hover{background:rgba(255,255,255,0.2)}.map-wrapper[data-v-7ec8e3e4]{flex:1;position:relative}.side-panel[data-v-7ec8e3e4]{position:absolute;top:60px;right:10px;width:300px;max-height:calc(100vh - 80px);background:rgba(0,0,0,0.9);border:1px solid #333;border-radius:8px;overflow:hidden;display:flex;flex-direction:column;z-index:100}.panel-header[data-v-7ec8e3e4]{display:flex;justify-content:space-between;align-items:center;padding:15px;background:rgba(255,255,255,0.1);border-bottom:1px solid #333}.panel-header h3[data-v-7ec8e3e4]{margin:0;font-size:16px}.panel-header button[data-v-7ec8e3e4]{background:none;border:none;color:white;font-size:18px;cursor:pointer}.panel-content[data-v-7ec8e3e4]{flex:1;overflow-y:auto;padding:15px}.add-token-btn[data-v-7ec8e3e4]{width:100%;padding:10px;background:#4caf50;border:none;color:white;border-radius:5px;cursor:pointer;margin-bottom:15px}.token-item[data-v-7ec8e3e4]{background:rgba(255,255,255,0.05);padding:10px;border-radius:5px;margin-bottom:10px}.token-header[data-v-7ec8e3e4]{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}.delete-btn[data-v-7ec8e3e4]{background:rgba(255,0,0,0.3);border:none;color:white;padding:4px 8px;border-radius:3px;cursor:pointer}.token-details[data-v-7ec8e3e4]{display:flex;flex-direction:column;gap:8px}.token-details label[data-v-7ec8e3e4]{display:flex;justify-content:space-between;align-items:center;font-size:14px}.token-details input[data-v-7ec8e3e4]{width:120px;padding:4px 8px;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.3);color:white;border-radius:3px}.info-item[data-v-7ec8e3e4]{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid rgba(255,255,255,0.1)}.info-item label[data-v-7ec8e3e4]{font-weight:bold}


/*# sourceMappingURL=main.css.map*/</style></head><body><div id="app"></div></body></html>
