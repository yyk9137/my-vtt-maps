(()=>{'use strict';var t={54:t=>{t.exports=function(t){var e=[];return e.toString=function(){return this.map(function(e){var n='',r=void 0!==e[5];return e[4]&&(n+='@supports ('.concat(e[4],') {')),e[2]&&(n+='@media '.concat(e[2],' {')),r&&(n+='@layer'.concat(e[5].length>0?' '.concat(e[5]):'',' {')),n+=t(e),r&&(n+='}'),e[2]&&(n+='}'),e[4]&&(n+='}'),n}).join('')},e.i=function(t,n,r,o,s){'string'==typeof t&&(t=[[null,t,void 0]]);var a={};if(r)for(var i=0;i<this.length;i++){var A=this[i][0];null!=A&&(a[A]=!0)}for(var l=0;l<t.length;l++){var c=[].concat(t[l]);r&&a[c[0]]||(void 0!==s&&(void 0===c[5]||(c[1]='@layer'.concat(c[5].length>0?' '.concat(c[5]):'',' {').concat(c[1],'}')),c[5]=s),n&&(c[2]?(c[1]='@media '.concat(c[2],' {').concat(c[1],'}'),c[2]=n):c[2]=n),o&&(c[4]?(c[1]='@supports ('.concat(c[4],') {').concat(c[1],'}'),c[4]=o):c[4]=''.concat(o)),e.push(c))}},e}},134:t=>{t.exports=function(t){var e=document.createElement('style');return t.setAttributes(e,t.attributes),t.insert(e,t.options),e}},219:t=>{t.exports=function(t){if('undefined'==typeof document)return{update:function(){},remove:function(){}};var e=t.insertStyleElement(t);return{update:function(n){!function(t,e,n){var r='';n.supports&&(r+='@supports ('.concat(n.supports,') {')),n.media&&(r+='@media '.concat(n.media,' {'));var o=void 0!==n.layer;o&&(r+='@layer'.concat(n.layer.length>0?' '.concat(n.layer):'',' {')),r+=n.css,o&&(r+='}'),n.media&&(r+='}'),n.supports&&(r+='}');var s=n.sourceMap;s&&'undefined'!=typeof btoa&&(r+='\n/*# sourceMappingURL=data:application/json;base64,'.concat(btoa(unescape(encodeURIComponent(JSON.stringify(s)))),' */')),e.styleTagTransform(r,t,e.options)}(e,t,n)},remove:function(){!function(t){if(null===t.parentNode)return!1;t.parentNode.removeChild(t)}(e)}}}},234:t=>{var e=[];function n(t){for(var n=-1,r=0;r<e.length;r++)if(e[r].identifier===t){n=r;break}return n}function r(t,r){for(var s={},a=[],i=0;i<t.length;i++){var A=t[i],l=r.base?A[0]+r.base:A[0],c=s[l]||0,d=''.concat(l,' ').concat(c);s[l]=c+1;var p=n(d),u={css:A[1],media:A[2],sourceMap:A[3],supports:A[4],layer:A[5]};if(-1!==p)e[p].references++,e[p].updater(u);else{var h=o(u,r);r.byIndex=i,e.splice(i,0,{identifier:d,updater:h,references:1})}a.push(d)}return a}function o(t,e){var n=e.domAPI(e);n.update(t);return function(e){if(e){if(e.css===t.css&&e.media===t.media&&e.sourceMap===t.sourceMap&&e.supports===t.supports&&e.layer===t.layer)return;n.update(t=e)}else n.remove()}}t.exports=function(t,o){var s=r(t=t||[],o=o||{});return function(t){t=t||[];for(var a=0;a<s.length;a++){var i=n(s[a]);e[i].references--}for(var A=r(t,o),l=0;l<s.length;l++){var c=n(s[l]);0===e[c].references&&(e[c].updater(),e.splice(c,1))}s=A}}},387:(t,e,n)=>{n.d(e,{A:()=>i});var r=n(790),o=n.n(r),s=n(54),a=n.n(s)()(o());a.push([t.id,'.vtt-map-button{position:fixed;bottom:20px;right:20px;z-index:9999;display:flex;align-items:center;gap:8px;padding:12px 20px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;border:none;border-radius:50px;box-shadow:0 4px 15px rgba(102,126,234,.4);font-size:16px;font-weight:600;cursor:pointer;transition:all .3s ease}.vtt-map-button:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(102,126,234,.6)}.vtt-map-button:active{transform:translateY(0)}.vtt-map-button svg{width:24px;height:24px}.vtt-floating-window{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);width:80vw;height:80vh;max-width:1400px;min-width:400px;min-height:300px;background:#1a1a1a;border:2px solid #667eea;border-radius:12px;box-shadow:0 10px 40px rgba(0,0,0,.5);z-index:10000;display:flex;flex-direction:column;overflow:hidden}.vtt-floating-window.fullscreen{top:0;left:0;transform:none;width:100vw !important;height:100vh !important;border-radius:0;max-width:none}.vtt-title-bar{padding:12px 20px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);display:flex;justify-content:space-between;align-items:center;cursor:move;-webkit-user-select:none;user-select:none}.vtt-title-bar .vtt-title{display:flex;align-items:center;gap:10px;color:#fff;font-size:18px;font-weight:600}.vtt-title-bar .vtt-title svg{width:20px;height:20px}.vtt-title-bar .vtt-controls{display:flex;gap:8px}.vtt-control-btn{padding:6px 12px;border:none;border-radius:5px;color:#fff;font-size:14px;font-weight:600;cursor:pointer;transition:all .2s ease}.vtt-control-btn:hover{transform:scale(1.05)}.vtt-control-btn:active{transform:scale(0.95)}.vtt-control-btn.vtt-minimize-btn{background:#ff9800}.vtt-control-btn.vtt-minimize-btn:hover{background:#fb8c00}.vtt-control-btn.vtt-fullscreen-btn{background:#2196f3}.vtt-control-btn.vtt-fullscreen-btn:hover{background:#1e88e5}.vtt-control-btn.vtt-close-btn{background:#f44336}.vtt-control-btn.vtt-close-btn:hover{background:#e53935}.vtt-content{flex:1;position:relative;overflow:hidden;background:#0a0a0a}.vtt-content.minimized{display:none}.vtt-loading{position:absolute;top:0;left:0;width:100%;height:100%;display:flex;flex-direction:column;justify-content:center;align-items:center;gap:20px;background:#0a0a0a;color:#fff;z-index:1}.vtt-loading .spinner{width:50px;height:50px;border:4px solid rgba(102,126,234,.3);border-top-color:#667eea;border-radius:50%;animation:spin 1s linear infinite}.vtt-loading p{margin:0;font-size:18px;color:#667eea}.vtt-loading small{font-size:14px;color:#999}.vtt-loading .error-icon{font-size:50px}@keyframes spin{to{transform:rotate(360deg)}}.vtt-iframe{width:100%;height:100%;border:none;background:#fff}.vtt-resize-handle{position:absolute;z-index:10}.vtt-resize-handle.vtt-resize-n{top:0;left:10px;right:10px;height:5px;cursor:n-resize}.vtt-resize-handle.vtt-resize-e{top:10px;right:0;bottom:10px;width:5px;cursor:e-resize}.vtt-resize-handle.vtt-resize-s{bottom:0;left:10px;right:10px;height:5px;cursor:s-resize}.vtt-resize-handle.vtt-resize-w{top:10px;left:0;bottom:10px;width:5px;cursor:w-resize}.vtt-resize-handle.vtt-resize-ne{top:0;right:0;width:10px;height:10px;cursor:ne-resize}.vtt-resize-handle.vtt-resize-se{bottom:0;right:0;width:10px;height:10px;cursor:se-resize}.vtt-resize-handle.vtt-resize-sw{bottom:0;left:0;width:10px;height:10px;cursor:sw-resize}.vtt-resize-handle.vtt-resize-nw{top:0;left:0;width:10px;height:10px;cursor:nw-resize}body.vtt-dragging,body.vtt-resizing{-webkit-user-select:none;user-select:none}body.vtt-dragging *,body.vtt-resizing *{cursor:inherit !important}@media (max-width:768px){.vtt-floating-window{width:95vw;height:90vh}.vtt-map-button{bottom:80px}}','',{version:3,sources:['webpack://./src/vtt-floating-window-with-ai/index.scss'],names:[],mappings:'AAGA,gBACE,cAAA,CACA,WAAA,CACA,UAAA,CACA,YAAA,CAEA,YAAA,CACA,kBAAA,CACA,OAAA,CAEA,iBAAA,CACA,0DAAA,CACA,UAAA,CACA,WAAA,CACA,kBAAA,CACA,0CAAA,CAEA,cAAA,CACA,eAAA,CACA,cAAA,CAEA,uBAAA,CAEA,sBACE,0BAAA,CACA,0CAAA,CAGF,uBACE,uBAAA,CAGF,oBACE,UAAA,CACA,WAAA,CAKJ,qBACE,cAAA,CACA,OAAA,CACA,QAAA,CACA,8BAAA,CAEA,UAAA,CACA,WAAA,CACA,gBAAA,CACA,eAAA,CACA,gBAAA,CAEA,kBAAA,CACA,wBAAA,CACA,kBAAA,CACA,qCAAA,CAEA,aAAA,CACA,YAAA,CACA,qBAAA,CAEA,eAAA,CAEA,gCACE,KAAA,CACA,MAAA,CACA,cAAA,CACA,sBAAA,CACA,uBAAA,CACA,eAAA,CACA,cAAA,CAKJ,eACE,iBAAA,CACA,0DAAA,CAEA,YAAA,CACA,6BAAA,CACA,kBAAA,CAEA,WAAA,CACA,wBAAA,CAAA,gBAAA,CAEA,0BACE,YAAA,CACA,kBAAA,CACA,QAAA,CAEA,UAAA,CACA,cAAA,CACA,eAAA,CAEA,8BACE,UAAA,CACA,WAAA,CAIJ,6BACE,YAAA,CACA,OAAA,CAKJ,iBACE,gBAAA,CACA,WAAA,CACA,iBAAA,CAEA,UAAA,CACA,cAAA,CACA,eAAA,CAEA,cAAA,CACA,uBAAA,CAEA,uBACE,qBAAA,CAGF,wBACE,qBAAA,CAGF,kCACE,kBAAA,CAEA,wCACE,kBAAA,CAIJ,oCACE,kBAAA,CAEA,0CACE,kBAAA,CAIJ,+BACE,kBAAA,CAEA,qCACE,kBAAA,CAMN,aACE,MAAA,CACA,iBAAA,CACA,eAAA,CACA,kBAAA,CAEA,uBACE,YAAA,CAKJ,aACE,iBAAA,CACA,KAAA,CACA,MAAA,CACA,UAAA,CACA,WAAA,CAEA,YAAA,CACA,qBAAA,CACA,sBAAA,CACA,kBAAA,CACA,QAAA,CAEA,kBAAA,CACA,UAAA,CACA,SAAA,CAEA,sBACE,UAAA,CACA,WAAA,CACA,qCAAA,CACA,wBAAA,CACA,iBAAA,CACA,iCAAA,CAGF,eACE,QAAA,CACA,cAAA,CACA,aAAA,CAGF,mBACE,cAAA,CACA,UAAA,CAGF,yBACE,cAAA,CAIJ,gBACE,GACE,wBAAA,CAAA,CAKJ,YACE,UAAA,CACA,WAAA,CACA,WAAA,CACA,eAAA,CAIF,mBACE,iBAAA,CACA,UAAA,CAEA,gCACE,KAAA,CACA,SAAA,CACA,UAAA,CACA,UAAA,CACA,eAAA,CAGF,gCACE,QAAA,CACA,OAAA,CACA,WAAA,CACA,SAAA,CACA,eAAA,CAGF,gCACE,QAAA,CACA,SAAA,CACA,UAAA,CACA,UAAA,CACA,eAAA,CAGF,gCACE,QAAA,CACA,MAAA,CACA,WAAA,CACA,SAAA,CACA,eAAA,CAGF,iCACE,KAAA,CACA,OAAA,CACA,UAAA,CACA,WAAA,CACA,gBAAA,CAGF,iCACE,QAAA,CACA,OAAA,CACA,UAAA,CACA,WAAA,CACA,gBAAA,CAGF,iCACE,QAAA,CACA,MAAA,CACA,UAAA,CACA,WAAA,CACA,gBAAA,CAGF,iCACE,KAAA,CACA,MAAA,CACA,UAAA,CACA,WAAA,CACA,gBAAA,CAKJ,oCAEE,wBAAA,CAAA,gBAAA,CAEA,wCACE,yBAAA,CAKJ,yBACE,qBACE,UAAA,CACA,WAAA,CAGF,gBACE,WAAA,CAAA',sourcesContent:['// VTT 地图悬浮窗样式\r\n\r\n// 浮动按钮\r\n.vtt-map-button {\r\n  position: fixed;\r\n  bottom: 20px;\r\n  right: 20px;\r\n  z-index: 9999;\r\n\r\n  display: flex;\r\n  align-items: center;\r\n  gap: 8px;\r\n\r\n  padding: 12px 20px;\r\n  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\r\n  color: white;\r\n  border: none;\r\n  border-radius: 50px;\r\n  box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);\r\n\r\n  font-size: 16px;\r\n  font-weight: 600;\r\n  cursor: pointer;\r\n\r\n  transition: all 0.3s ease;\r\n\r\n  &:hover {\r\n    transform: translateY(-2px);\r\n    box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);\r\n  }\r\n\r\n  &:active {\r\n    transform: translateY(0);\r\n  }\r\n\r\n  svg {\r\n    width: 24px;\r\n    height: 24px;\r\n  }\r\n}\r\n\r\n// 悬浮窗\r\n.vtt-floating-window {\r\n  position: fixed;\r\n  top: 50%;\r\n  left: 50%;\r\n  transform: translate(-50%, -50%);\r\n\r\n  width: 80vw;\r\n  height: 80vh;\r\n  max-width: 1400px;\r\n  min-width: 400px;\r\n  min-height: 300px;\r\n\r\n  background: #1a1a1a;\r\n  border: 2px solid #667eea;\r\n  border-radius: 12px;\r\n  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);\r\n\r\n  z-index: 10000;\r\n  display: flex;\r\n  flex-direction: column;\r\n\r\n  overflow: hidden;\r\n\r\n  &.fullscreen {\r\n    top: 0;\r\n    left: 0;\r\n    transform: none;\r\n    width: 100vw !important;\r\n    height: 100vh !important;\r\n    border-radius: 0;\r\n    max-width: none;\r\n  }\r\n}\r\n\r\n// 标题栏\r\n.vtt-title-bar {\r\n  padding: 12px 20px;\r\n  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\r\n\r\n  display: flex;\r\n  justify-content: space-between;\r\n  align-items: center;\r\n\r\n  cursor: move;\r\n  user-select: none;\r\n\r\n  .vtt-title {\r\n    display: flex;\r\n    align-items: center;\r\n    gap: 10px;\r\n\r\n    color: white;\r\n    font-size: 18px;\r\n    font-weight: 600;\r\n\r\n    svg {\r\n      width: 20px;\r\n      height: 20px;\r\n    }\r\n  }\r\n\r\n  .vtt-controls {\r\n    display: flex;\r\n    gap: 8px;\r\n  }\r\n}\r\n\r\n// 控制按钮\r\n.vtt-control-btn {\r\n  padding: 6px 12px;\r\n  border: none;\r\n  border-radius: 5px;\r\n\r\n  color: white;\r\n  font-size: 14px;\r\n  font-weight: 600;\r\n\r\n  cursor: pointer;\r\n  transition: all 0.2s ease;\r\n\r\n  &:hover {\r\n    transform: scale(1.05);\r\n  }\r\n\r\n  &:active {\r\n    transform: scale(0.95);\r\n  }\r\n\r\n  &.vtt-minimize-btn {\r\n    background: #ff9800;\r\n\r\n    &:hover {\r\n      background: #fb8c00;\r\n    }\r\n  }\r\n\r\n  &.vtt-fullscreen-btn {\r\n    background: #2196f3;\r\n\r\n    &:hover {\r\n      background: #1e88e5;\r\n    }\r\n  }\r\n\r\n  &.vtt-close-btn {\r\n    background: #f44336;\r\n\r\n    &:hover {\r\n      background: #e53935;\r\n    }\r\n  }\r\n}\r\n\r\n// 内容区域\r\n.vtt-content {\r\n  flex: 1;\r\n  position: relative;\r\n  overflow: hidden;\r\n  background: #0a0a0a;\r\n\r\n  &.minimized {\r\n    display: none;\r\n  }\r\n}\r\n\r\n// 加载中\r\n.vtt-loading {\r\n  position: absolute;\r\n  top: 0;\r\n  left: 0;\r\n  width: 100%;\r\n  height: 100%;\r\n\r\n  display: flex;\r\n  flex-direction: column;\r\n  justify-content: center;\r\n  align-items: center;\r\n  gap: 20px;\r\n\r\n  background: #0a0a0a;\r\n  color: white;\r\n  z-index: 1;\r\n\r\n  .spinner {\r\n    width: 50px;\r\n    height: 50px;\r\n    border: 4px solid rgba(102, 126, 234, 0.3);\r\n    border-top-color: #667eea;\r\n    border-radius: 50%;\r\n    animation: spin 1s linear infinite;\r\n  }\r\n\r\n  p {\r\n    margin: 0;\r\n    font-size: 18px;\r\n    color: #667eea;\r\n  }\r\n\r\n  small {\r\n    font-size: 14px;\r\n    color: #999;\r\n  }\r\n\r\n  .error-icon {\r\n    font-size: 50px;\r\n  }\r\n}\r\n\r\n@keyframes spin {\r\n  to {\r\n    transform: rotate(360deg);\r\n  }\r\n}\r\n\r\n// iframe\r\n.vtt-iframe {\r\n  width: 100%;\r\n  height: 100%;\r\n  border: none;\r\n  background: white;\r\n}\r\n\r\n// 调整大小手柄\r\n.vtt-resize-handle {\r\n  position: absolute;\r\n  z-index: 10;\r\n\r\n  &.vtt-resize-n {\r\n    top: 0;\r\n    left: 10px;\r\n    right: 10px;\r\n    height: 5px;\r\n    cursor: n-resize;\r\n  }\r\n\r\n  &.vtt-resize-e {\r\n    top: 10px;\r\n    right: 0;\r\n    bottom: 10px;\r\n    width: 5px;\r\n    cursor: e-resize;\r\n  }\r\n\r\n  &.vtt-resize-s {\r\n    bottom: 0;\r\n    left: 10px;\r\n    right: 10px;\r\n    height: 5px;\r\n    cursor: s-resize;\r\n  }\r\n\r\n  &.vtt-resize-w {\r\n    top: 10px;\r\n    left: 0;\r\n    bottom: 10px;\r\n    width: 5px;\r\n    cursor: w-resize;\r\n  }\r\n\r\n  &.vtt-resize-ne {\r\n    top: 0;\r\n    right: 0;\r\n    width: 10px;\r\n    height: 10px;\r\n    cursor: ne-resize;\r\n  }\r\n\r\n  &.vtt-resize-se {\r\n    bottom: 0;\r\n    right: 0;\r\n    width: 10px;\r\n    height: 10px;\r\n    cursor: se-resize;\r\n  }\r\n\r\n  &.vtt-resize-sw {\r\n    bottom: 0;\r\n    left: 0;\r\n    width: 10px;\r\n    height: 10px;\r\n    cursor: sw-resize;\r\n  }\r\n\r\n  &.vtt-resize-nw {\r\n    top: 0;\r\n    left: 0;\r\n    width: 10px;\r\n    height: 10px;\r\n    cursor: nw-resize;\r\n  }\r\n}\r\n\r\n// 拖动和调整大小时的样式\r\nbody.vtt-dragging,\r\nbody.vtt-resizing {\r\n  user-select: none;\r\n\r\n  * {\r\n    cursor: inherit !important;\r\n  }\r\n}\r\n\r\n// 响应式\r\n@media (max-width: 768px) {\r\n  .vtt-floating-window {\r\n    width: 95vw;\r\n    height: 90vh;\r\n  }\r\n\r\n  .vtt-map-button {\r\n    bottom: 80px; // 避免遮挡移动端输入框\r\n  }\r\n}\r\n'],sourceRoot:''}]);const i=a},699:t=>{t.exports=function(t,e){if(e.styleSheet)e.styleSheet.cssText=t;else{for(;e.firstChild;)e.removeChild(e.firstChild);e.appendChild(document.createTextNode(t))}}},714:(t,e,n)=>{t.exports=function(t){var e=n.nc;e&&t.setAttribute('nonce',e)}},790:t=>{t.exports=function(t){var e=t[1],n=t[3];if(!n)return e;if('function'==typeof btoa){var r=btoa(unescape(encodeURIComponent(JSON.stringify(n)))),o='sourceMappingURL=data:application/json;charset=utf-8;base64,'.concat(r),s='/*# '.concat(o,' */');return[e].concat([s]).join('\n')}return[e].join('\n')}},881:t=>{var e={};t.exports=function(t,n){var r=function(t){if(void 0===e[t]){var n=document.querySelector(t);if(window.HTMLIFrameElement&&n instanceof window.HTMLIFrameElement)try{n=n.contentDocument.head}catch(t){n=null}e[t]=n}return e[t]}(t);if(!r)throw new Error('Couldn\'t find a style target. This probably means that the value for the \'insert\' parameter is invalid.');r.appendChild(n)}}},e={};function n(r){var o=e[r];if(void 0!==o)return o.exports;var s=e[r]={id:r,exports:{}};return t[r](s,s.exports,n),s.exports}n.n=t=>{var e=t&&t.__esModule?()=>t.default:()=>t;return n.d(e,{a:e}),e},n.d=(t,e)=>{for(var r in e)n.o(e,r)&&!n.o(t,r)&&Object.defineProperty(t,r,{enumerable:!0,get:e[r]})},n.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),n.nc=void 0;const r=z,o=r.z.object({action:r.z.enum(['move_token','open_door','close_door','toggle_light','reveal_area','spawn_token','remove_token','play_sound','chat_message','roll_dice','trigger_event']),params:r.z.record(r.z.any()),description:r.z.string().optional()}),s=r.z.object({commands:r.z.array(o),context:r.z.record(r.z.any()).optional()});class a{mapState;context;commandQueue=[];executing=!1;constructor(){this.mapState=this.loadMapState(),this.context=this.loadContext()}async handlePlayerInput(t){try{const e=function(t,e){return`玩家说："${t}"\n\n可见的门：${e.visibleDoors.map(t=>`${t.name}(${1===t.state?'开':'关'})`).join(', ')||'无'}\n\n示例：\n玩家："我要打开门" → {"commands":[{"action":"open_door","params":{"doorId":"door_1"}}]}\n玩家："关上门" → {"commands":[{"action":"close_door","params":{"doorId":"door_1"}}]}\n玩家："你好" → {"commands":[]}\n\n可用 actions：\n- open_door: 开门, params={doorId}\n- close_door: 关门, params={doorId}\n- move_token: 移动, params={tokenId,x,y}\n\n只返回JSON格式：{"commands":[...]}`}(t,this.getMapContext()),n=await this.callAI(e),r=this.parseAIResponse(n);if(!r.commands||0===r.commands.length)return{success:!0,executed:!1,simpleMessage:'无地图操作',shouldBlock:!1};const o=await this.validateAndExecuteCommands(r.commands);return r.context&&this.updateContext(r.context),o.allPassed?{success:!0,executed:!0,simpleMessage:`✅ ${this.getActionDescription(r.commands)}`,shouldBlock:!1}:{success:!1,executed:!1,simpleMessage:`❌ ${o.failureReason}`,shouldBlock:!0,modifiedInput:o.modifiedInput}}catch(t){return console.error('AI-GM 处理失败:',t),{success:!1,executed:!1,simpleMessage:'❌ 无法解析指令',shouldBlock:!1}}}getActionDescription(t){const e={open_door:'开门',close_door:'关门',move_token:'移动',reveal_area:'揭示区域',toggle_light:'切换光源',spawn_token:'生成角色',remove_token:'移除角色'};return t.map(t=>e[t.action]||t.action).join('、')+'完成'}async callAI(t){try{console.log('[AI-GM] 正在调用 AI...');const e=`${'你是 VTT 指令解析器。只解析玩家输入的地图操作，返回 JSON 格式的 commands 数组。'}\n\n${t}`,n=await triggerSlash(`/genraw length=500 ${e}`,{source:'ai-gm'});return console.log('[AI-GM] AI 响应:',n),n||''}catch(t){throw console.error('[AI-GM] API 调用失败:',t),new Error('无法连接到 AI 服务，请检查酒馆的 API 配置是否正确')}}parseAIResponse(t){const e=t.match(/```json\n?([\s\S]*?)\n?```/)||t.match(/\{[\s\S]*\}/);if(!e)throw new Error('AI 响应格式错误：未找到有效的 JSON');const n=e[1]||e[0],r=JSON.parse(n);return s.parse(r)}async validateAndExecuteCommands(t){for(const e of t){const t=this.validateCommand(e);if(!t.passed)return console.warn('[AI-GM] 验证失败:',t.reason),{allPassed:!1,failureReason:t.reason,modifiedInput:t.modifiedInput}}return await this.executeCommands(t),{allPassed:!0}}validateCommand(t){switch(t.action){case'open_door':return this.validateOpenDoor(t.params);case'close_door':default:return{passed:!0};case'move_token':return this.validateMoveToken(t.params)}}validateOpenDoor(t){const{doorId:e}=t,n=this.loadMapState(),r=n.walls?.find(t=>t.id===e||t.door>0);if(!r)return{passed:!1,reason:'找不到门',modifiedInput:'你试图寻找门，但这里似乎没有门。'};if(1===r.ds)return{passed:!1,reason:'门已经开着',modifiedInput:'你发现门已经是开着的了。'};const o=this.getDoorRules(e);if(o?.locked){const t=this.getPlayerStats();if(o.required_strength&&t.strength<o.required_strength)return{passed:!1,reason:`需要力量 ${o.required_strength}，当前力量 ${t.strength}`,modifiedInput:'你用力推门，但门纹丝不动。看起来你的力量还不够。'};if(o.required_key&&!t.inventory?.includes(o.required_key))return{passed:!1,reason:`需要钥匙: ${o.required_key}`,modifiedInput:'门被锁住了。你需要找到合适的钥匙。'}}return{passed:!0}}validateMoveToken(t){return{passed:!0}}getDoorRules(t){try{const e=getVariables({type:'script',script_id:getScriptId()});return(e.vtt_door_rules||{})[t]}catch{return null}}getPlayerStats(){try{if('undefined'!=typeof Mvu){const t=Mvu.getMvuData({type:'message',message_id:'latest'}),e=t?.stat_data?.角色?.player1||t?.stat_data?.characters?.player1;if(e)return{strength:e.力量||e.strength||e.STR||10,inventory:e.inventory||e.背包||[]}}return getVariables({type:'script',script_id:getScriptId()}).player_stats||{strength:10,inventory:[]}}catch{return{strength:10,inventory:[]}}}async executeCommands(t){if(this.commandQueue.push(...t),!this.executing){this.executing=!0;try{for(;this.commandQueue.length>0;){const t=this.commandQueue.shift();await this.executeCommand(t),await this.sleep(500)}}finally{this.executing=!1}}}async executeCommand(t){switch(console.log(`🎬 执行指令: ${t.action}`,t.params),t.action){case'move_token':await this.moveToken(t.params);break;case'open_door':await this.openDoor(t.params);break;case'close_door':await this.closeDoor(t.params);break;case'toggle_light':await this.toggleLight(t.params);break;case'reveal_area':await this.revealArea(t.params);break;case'spawn_token':await this.spawnToken(t.params);break;case'remove_token':await this.removeToken(t.params);break;case'play_sound':await this.playSound(t.params);break;case'chat_message':await this.sendChatMessage(t.params);break;case'roll_dice':await this.rollDice(t.params);break;case'trigger_event':await this.triggerEvent(t.params);break;default:console.warn(`未知指令: ${t.action}`)}}async moveToken(t){const{tokenId:e,x:n,y:r,animated:o=!0}=t,s=this.loadMapState(),a=s.tokens.find(t=>t.id===e);a?(a.x=n,a.y=r,this.saveMapState(s),this.notifyMapUpdate()):console.warn(`Token ${e} 不存在`)}async openDoor(t){const{doorId:e}=t,n=this.loadMapState(),r=n.walls.find(t=>t.id===e||1===t.door);r?(r.ds=1,this.saveMapState(n),this.notifyMapUpdate()):console.warn(`门 ${e} 不存在`)}async closeDoor(t){const{doorId:e}=t,n=this.loadMapState(),r=n.walls.find(t=>t.id===e);r&&(r.ds=0,this.saveMapState(n),this.notifyMapUpdate())}async toggleLight(t){const{lightId:e,enabled:n}=t,r=this.loadMapState(),o=r.lights.find(t=>t.id===e);o&&(o.enabled=n??!o.enabled,this.saveMapState(r),this.notifyMapUpdate())}async revealArea(t){const{roomId:e,x:n,y:r,width:o,height:s,permanent:a=!0}=t;console.log(`揭示区域: ${e}`),this.notifyMapUpdate()}async spawnToken(t){const{type:e,name:n,x:r,y:o,image:s,stats:a}=t,i=this.loadMapState(),A={id:`token_${Date.now()}`,name:n||'未命名',x:r,y:o,width:1,height:1,vision:'monster'===e?0:12,image:s,stats:a||{}};i.tokens.push(A),this.saveMapState(i),this.notifyMapUpdate()}async removeToken(t){const{tokenId:e}=t,n=this.loadMapState();n.tokens=n.tokens.filter(t=>t.id!==e),this.saveMapState(n),this.notifyMapUpdate()}async playSound(t){const{soundId:e,volume:n=.5}=t;console.log(`播放音效: ${e} (音量: ${n})`)}async sendChatMessage(t){const{type:e='system',message:n}=t;toastr.info(n,'system'===e?'系统':'GM')}async rollDice(t){const{formula:e,reason:n}=t;console.log(`掷骰: ${e} (${n})`)}async triggerEvent(t){const{eventId:e,data:n}=t;console.log(`触发事件: ${e}`,n)}getMapContext(){const t=this.loadMapState();return{mapName:t.name||'未命名地图',currentRoom:this.context.currentRoom||'unknown',playerToken:t.tokens.find(t=>'player1'===t.id)||{},visibleDoors:this.getVisibleDoors(t),visibleItems:this.getVisibleItems(t),nearbyNPCs:this.getNearbyNPCs(t)}}getVisibleDoors(t){return t.walls.filter(t=>t.door>0).map((t,e)=>({id:t.id||`door_${e}`,name:`门 ${e+1}`,state:t.ds,x:t.c[0],y:t.c[1]}))}getVisibleItems(t){return[]}getNearbyNPCs(t){return t.tokens.filter(t=>'player1'!==t.id)}loadMapState(){return getVariables({type:'script',script_id:getScriptId()}).vtt_map_data||{tokens:[],walls:[],lights:[]}}saveMapState(t){replaceVariables({vtt_map_data:t},{type:'script',script_id:getScriptId()})}loadContext(){return getVariables({type:'script',script_id:getScriptId()}).ai_gm_context||{currentRoom:'entrance',discoveredRooms:[]}}updateContext(t){this.context={...this.context,...t},replaceVariables({ai_gm_context:this.context},{type:'script',script_id:getScriptId()})}notifyMapUpdate(){window.dispatchEvent(new CustomEvent('vtt-map-update'))}sleep(t){return new Promise(e=>setTimeout(e,t))}}var i=n(234),A=n.n(i),l=n(219),c=n.n(l),d=n(881),p=n.n(d),u=n(714),h=n.n(u),g=n(134),m=n.n(g),C=n(699),f=n.n(C),v=n(387),x={};x.styleTagTransform=f(),x.setAttributes=h(),x.insert=p().bind(null,'head'),x.domAPI=c(),x.insertStyleElement=m();A()(v.A,x);v.A&&v.A.locals&&v.A.locals,r.z.object({tokenId:r.z.string(),name:r.z.string(),avatar:r.z.string().optional(),hp:r.z.number().optional(),maxHp:r.z.number().optional(),mp:r.z.number().optional(),maxMp:r.z.number().optional(),stats:r.z.record(r.z.any()).optional(),conditions:r.z.array(r.z.string()).optional(),customData:r.z.record(r.z.any()).optional()});class b{statusCache=new Map;mvuInitialized=!1;updateInterval=null;constructor(){this.initializeMvu(),this.setupMessageListener()}async initializeMvu(){try{await waitGlobalInitialized('Mvu'),this.mvuInitialized=!0,console.log('[MVU Token] MVU 初始化成功'),this.setupMvuListeners(),this.startAutoUpdate()}catch(t){console.error('[MVU Token] MVU 初始化失败:',t),toastr.warning('MVU 未安装，Token 状态栏将无法显示数据')}}setupMvuListeners(){this.mvuInitialized&&(eventOn(Mvu.events.VARIABLE_UPDATE_ENDED,t=>{console.log('[MVU Token] 变量更新，刷新所有 Token 状态'),this.refreshAllTokens()}),eventOn(Mvu.events.SINGLE_VARIABLE_UPDATED,(t,e,n,r)=>{if(e.startsWith('角色.')||e.startsWith('characters.')){console.log(`[MVU Token] 角色变量更新: ${e}`);const t=this.extractCharacterName(e);t&&this.updateTokenByName(t)}}))}extractCharacterName(t){const e=t.match(/^(?:角色|characters)\.([^.]+)\./);return e?e[1]:null}setupMessageListener(){window.addEventListener('message',t=>{const e=$('#vtt-floating-window iframe')[0];if(!e||t.source!==e.contentWindow)return;const{type:n,tokenId:r}=t.data;switch(n){case'request-token-status':this.sendTokenStatus(r);break;case'request-all-tokens':this.sendAllTokens()}})}startAutoUpdate(){this.updateInterval=window.setInterval(()=>{this.refreshAllTokens()},5e3)}stopAutoUpdate(){null!==this.updateInterval&&(clearInterval(this.updateInterval),this.updateInterval=null)}async getTokenStatus(t){if(!this.mvuInitialized)return null;try{const e=Mvu.getMvuData({type:'message',message_id:'latest'}),n=this.findCharacterData(e.stat_data,t);if(!n)return console.warn(`[MVU Token] 未找到 Token ${t} 的数据`),null;const r={tokenId:t,name:n.name||n.名称||t,avatar:n.avatar||n.头像,hp:n.hp||n.生命值||n.HP,maxHp:n.maxHp||n.最大生命值||n.最大HP,mp:n.mp||n.魔法值||n.MP,maxMp:n.maxMp||n.最大魔法值||n.最大MP,stats:{力量:n.力量||n.STR||n.strength,敏捷:n.敏捷||n.DEX||n.dexterity,体质:n.体质||n.CON||n.constitution,智力:n.智力||n.INT||n.intelligence,感知:n.感知||n.WIS||n.wisdom,魅力:n.魅力||n.CHA||n.charisma},conditions:n.conditions||n.状态效果||[],customData:n.customData||{}};return this.statusCache.set(t,r),r}catch(e){return console.error(`[MVU Token] 获取 Token ${t} 状态失败:`,e),null}}findCharacterData(t,e){const n=[`角色.${e}`,`characters.${e}`,`tokens.${e}`,`玩家.${e}`,`players.${e}`];for(const e of n){const n=_.get(t,e);if(n)return n}const r=_.get(t,'角色')||_.get(t,'characters')||{};for(const[t,n]of Object.entries(r))if('object'==typeof n&&null!==n&&(n.id===e||t===e||n.name===e))return n;return null}async sendTokenStatus(t){const e=await this.getTokenStatus(t),n=$('#vtt-floating-window iframe')[0];n&&n.contentWindow&&n.contentWindow.postMessage({type:'token-status-update',tokenId:t,status:e},'*')}async sendAllTokens(){if(this.mvuInitialized)try{const t=Mvu.getMvuData({type:'message',message_id:'latest'}).stat_data,e=_.get(t,'角色')||_.get(t,'characters')||{},n={};for(const[t,r]of Object.entries(e))if('object'==typeof r&&null!==r){const e=await this.getTokenStatus(t);e&&(n[t]=e)}const r=$('#vtt-floating-window iframe')[0];if(!r||!r.contentWindow)return;r.contentWindow.postMessage({type:'all-tokens-status',statuses:n},'*')}catch(t){console.error('[MVU Token] 发送所有 Token 状态失败:',t)}}refreshAllTokens(){this.sendAllTokens()}updateTokenByName(t){this.sendTokenStatus(t)}async refreshToken(t){await this.sendTokenStatus(t)}destroy(){this.stopAutoUpdate(),this.statusCache.clear()}}const w='https://yyk9137.github.io/my-vtt-maps/vtt-map-viewer/index.html';let y=null,I=null;function k(){console.log('[VTT悬浮窗+AI] 开始初始化...'),toastr.success('🗺️ VTT 地图悬浮窗（AI 增强版）已加载');try{console.log('[VTT悬浮窗+AI] 正在创建浮动按钮...'),function(){if($('#vtt-map-button').length>0)return void console.log('[VTT悬浮窗+AI] 地图按钮已存在，跳过创建');const t=$('<button>').attr('id','vtt-map-button').attr('title','打开 VTT 地图 (Ctrl+M)').addClass('vtt-map-button').css({position:'fixed',bottom:'20px',right:'20px',zIndex:9999,display:'flex',alignItems:'center',gap:'8px',padding:'12px 20px',background:'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',color:'white',border:'none',borderRadius:'50px',boxShadow:'0 4px 15px rgba(102, 126, 234, 0.4)',fontSize:'16px',fontWeight:'600',cursor:'pointer',transition:'all 0.3s ease'}).html('\n      <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">\n        <path d="M20.5 3l-.16.03L15 5.1 9 3 3.36 4.9c-.21.07-.36.25-.36.48V20.5c0 .28.22.5.5.5l.16-.03L9 18.9l6 2.1 5.64-1.9c.21-.07.36-.25.36-.48V3.5c0-.28-.22-.5-.5-.5zM15 19l-6-2.11V5l6 2.11V19z"/>\n      </svg>\n      <span>地图</span>\n    ').on('click',()=>{console.log('[VTT悬浮窗+AI] 地图按钮被点击'),M()}).hover(function(){$(this).css({transform:'translateY(-2px)',boxShadow:'0 6px 20px rgba(102, 126, 234, 0.6)'})},function(){$(this).css({transform:'translateY(0)',boxShadow:'0 4px 15px rgba(102, 126, 234, 0.4)'})});$('body').append(t),console.log('[VTT悬浮窗+AI] 地图按钮已添加到页面，ID:',t.attr('id'))}(),console.log('[VTT悬浮窗+AI] ✅ 浮动按钮创建成功'),console.log('[VTT悬浮窗+AI] 正在注册快捷键...'),$(document).on('keydown',t=>{t.ctrlKey&&'m'===t.key&&(t.preventDefault(),console.log('[VTT悬浮窗+AI] 快捷键 Ctrl+M 触发'),M())}),console.log('[VTT悬浮窗+AI] ✅ 快捷键注册成功'),console.log('[VTT悬浮窗+AI] 正在初始化 AI-GM 控制器...'),y=new a,console.log('[VTT悬浮窗+AI] ✅ AI-GM 控制器初始化成功'),console.log('[VTT悬浮窗+AI] 正在注册消息监听...'),eventOn(tavern_events.MESSAGE_SENT,async t=>{try{const e=getChatMessages(t);if(!e||0===e.length)return;const n=e[0];if(!n||!n.is_user)return;const r=n.message||'';if(!r)return;if(console.log('[AI-GM 方案A] 检测到用户消息:',r),!['门','灯','光','移动','进入','查看','搜索','打开','关闭','关上'].some(t=>r.includes(t)))return void console.log('[AI-GM 方案A] 非地图动作，跳过');console.log('[AI-GM 方案A] 检测到地图动作，开始验证...');const o=await y.handlePlayerInput(r);if(toastr.info(o.simpleMessage),o.executed)console.log('[AI-GM 方案A] ✅ 验证通过，地图已更新'),T();else if(o.shouldBlock&&o.modifiedInput){console.log('[AI-GM 方案A] ❌ 验证失败，修改消息内容');const e={...n,message:o.modifiedInput};updateChatMessage(t,e),eventEmit(tavern_events.MESSAGE_UPDATED,t)}}catch(t){console.error('[AI-GM 方案A] 处理失败:',t)}}),console.log('[VTT悬浮窗+AI] ✅ AI-GM 拦截器已启用（验证 → 执行地图操作 → 放行生成叙述）'),function(){if($('#ai-gm-control-btn').length>0)return;const t=$('<button>').attr('id','ai-gm-control-btn').attr('title','让 AI 根据最后一条消息控制地图').css({position:'fixed',bottom:'20px',right:'140px',zIndex:9999,display:'flex',alignItems:'center',gap:'8px',padding:'12px 20px',background:'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',color:'white',border:'none',borderRadius:'50px',boxShadow:'0 4px 15px rgba(240, 147, 251, 0.4)',fontSize:'16px',fontWeight:'600',cursor:'pointer',transition:'all 0.3s ease'}).html('🤖 AI-GM').on('click',async()=>{t.prop('disabled',!0).html('⏳ 处理中...');try{const t=function(){try{const t=getChatMessages(-1);if(console.log('[AI-GM] 获取聊天消息:',t),!t||!Array.isArray(t)||0===t.length)return console.warn('[AI-GM] 没有聊天消息'),null;const e=t[0];if(e&&e.is_user&&e.message)return console.log('[AI-GM] 找到用户消息:',e.message),e.message;const n=getChatMessages('0-'+getLastMessageId(),{role:'user'});if(n&&n.length>0){const t=n[n.length-1];return console.log('[AI-GM] 找到用户消息:',t.message),t.message}return console.warn('[AI-GM] 没有找到用户消息'),null}catch(t){return console.error('[AI-GM] 获取消息失败:',t),null}}();if(!t)return void toastr.warning('没有找到最近的用户消息');console.log('[AI-GM 方案A] 处理用户输入:',t);const e=await y.handlePlayerInput(t);toastr.info(e.simpleMessage),e.executed?(console.log('[AI-GM 方案A] ✅ 验证通过，地图已更新，等待角色扮演AI生成叙述'),T()):e.modifiedInput&&(console.log('[AI-GM 方案A] ❌ 验证失败，发送失败提示'),await triggerSlash(`/sendas name=system ${e.modifiedInput}`,{source:'ai-gm'}))}catch(t){console.error('[AI-GM] 错误:',t),toastr.error('AI 处理出错，请查看控制台')}finally{t.prop('disabled',!1).html('🤖 AI-GM')}}).hover(function(){$(this).css({transform:'translateY(-2px)',boxShadow:'0 6px 20px rgba(240, 147, 251, 0.6)'})},function(){$(this).css({transform:'translateY(0)',boxShadow:'0 4px 15px rgba(240, 147, 251, 0.4)'})});$('body').append(t)}(),console.log('[VTT悬浮窗+AI] 正在初始化 MVU Token 状态管理器...'),I=new b,console.log('[VTT悬浮窗+AI] ✅ MVU Token 状态管理器初始化成功'),console.log('[VTT悬浮窗+AI] ✅ 初始化完成！')}catch(t){console.error('[VTT悬浮窗+AI] ❌ 初始化失败:',t),toastr.error('VTT 悬浮窗初始化失败，请查看控制台')}}function T(){const t=$('#vtt-floating-window iframe');if(t.length>0){const e=t[0].contentWindow;e?.postMessage({type:'vtt-map-refresh'},'*')}}function M(){console.log('[VTT悬浮窗+AI] toggleVTTWindow 被调用');const t=$('#vtt-floating-window');if(console.log('[VTT悬浮窗+AI] 查找现有窗口，找到:',t.length,'个'),t.length>0){const e=t.is(':visible');console.log('[VTT悬浮窗+AI] 窗口当前可见:',e),e?(console.log('[VTT悬浮窗+AI] 隐藏窗口'),t.hide()):(console.log('[VTT悬浮窗+AI] 显示窗口'),t.show())}else console.log('[VTT悬浮窗+AI] 创建新窗口'),function(){console.log('[VTT悬浮窗+AI] 开始创建窗口 DOM 结构...');const t=$('<div>').attr('id','vtt-floating-window').addClass('vtt-floating-window').css({position:'fixed',top:'50%',left:'50%',transform:'translate(-50%, -50%)',width:'80vw',height:'80vh',maxWidth:'1400px',minWidth:'400px',minHeight:'300px',background:'#1a1a1a',border:'2px solid #667eea',borderRadius:'12px',boxShadow:'0 10px 40px rgba(0, 0, 0, 0.5)',zIndex:1e4,display:'flex',flexDirection:'column',overflow:'hidden'}),e=$('<div>').addClass('vtt-title-bar').css({padding:'12px 20px',background:'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',display:'flex',justifyContent:'space-between',alignItems:'center',cursor:'move',userSelect:'none'}),n=$('<div>').addClass('vtt-title').css({display:'flex',alignItems:'center',gap:'10px',color:'white',fontSize:'18px',fontWeight:'600'}).html('\n      <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">\n        <path d="M20.5 3l-.16.03L15 5.1 9 3 3.36 4.9c-.21.07-.36.25-.36.48V20.5c0 .28.22.5.5.5l.16-.03L9 18.9l6 2.1 5.64-1.9c.21-.07.36-.25.36-.48V3.5c0-.28-.22-.5-.5-.5zM15 19l-6-2.11V5l6 2.11V19z"/>\n      </svg>\n      <span>VTT 地图查看器 (AI 增强)</span>\n    '),r=$('<div>').addClass('vtt-controls').css({display:'flex',gap:'8px'}),o={padding:'6px 12px',border:'none',borderRadius:'5px',color:'white',fontSize:'14px',fontWeight:'600',cursor:'pointer',transition:'all 0.2s ease'},s=$('<button>').addClass('vtt-control-btn vtt-minimize-btn').attr('title','最小化').css({...o,background:'#ff9800'}).html('➖').on('click',()=>{const e=t.find('.vtt-content');e.hasClass('minimized')?(e.removeClass('minimized').show(),t.css('height','80vh'),s.html('➖')):(e.addClass('minimized').hide(),t.css('height','auto'),s.html('⬜'))}),a=$('<button>').addClass('vtt-control-btn vtt-fullscreen-btn').attr('title','全屏').css({...o,background:'#2196f3'}).html('⛶').on('click',()=>{t.hasClass('fullscreen')?(t.removeClass('fullscreen'),t.css({top:'50%',left:'50%',transform:'translate(-50%, -50%)',width:'80vw',height:'80vh',borderRadius:'12px'}),a.html('⛶')):(t.addClass('fullscreen'),t.css({top:'0',left:'0',transform:'none',width:'100vw',height:'100vh',borderRadius:'0'}),a.html('🗗'))}),i=$('<button>').addClass('vtt-control-btn vtt-close-btn').attr('title','关闭 (Esc)').css({...o,background:'#f44336'}).html('❌').on('click',()=>{t.hide()});r.append(s,a,i),e.append(n,r);const A=$('<div>').addClass('vtt-content').css({flex:'1',position:'relative',overflow:'hidden',background:'#0a0a0a'}),l=$('<div>').addClass('vtt-loading').css({position:'absolute',top:'0',left:'0',width:'100%',height:'100%',display:'flex',flexDirection:'column',justifyContent:'center',alignItems:'center',gap:'20px',background:'#0a0a0a',color:'white',zIndex:'1'}).html('\n      <div class="spinner" style="width: 50px; height: 50px; border: 4px solid rgba(102, 126, 234, 0.3); border-top-color: #667eea; border-radius: 50%; animation: spin 1s linear infinite;"></div>\n      <p style="margin: 0; font-size: 18px; color: #667eea;">正在加载 VTT 地图...</p>\n    '),c=$('<iframe>').addClass('vtt-iframe').attr('src',w).attr('allow','fullscreen').css({width:'100%',height:'100%',border:'none',background:'white'}).on('load',()=>{l.fadeOut(),toastr.success('🗺️ 地图加载完成')}).on('error',()=>{l.html('\n        <div class="error-icon" style="font-size: 50px;">⚠️</div>\n        <p style="margin: 0; font-size: 18px;">地图加载失败</p>\n        <small style="font-size: 14px; color: #999;">请检查 URL 是否正确</small>\n      '),toastr.error('❌ 地图加载失败')});A.append(l,c),t.append(e,A),console.log('[VTT悬浮窗+AI] 窗口 DOM 结构创建完成，准备添加到页面...'),$('#vtt-spin-animation').length||$('<style>').attr('id','vtt-spin-animation').text('@keyframes spin { to { transform: rotate(360deg); } }').appendTo('head');$('body').append(t),console.log('[VTT悬浮窗+AI] 窗口已添加到页面');const d=$('#vtt-floating-window');console.log('[VTT悬浮窗+AI] 验证窗口存在:',d.length),console.log('[VTT悬浮窗+AI] 窗口可见性:',d.is(':visible')),console.log('[VTT悬浮窗+AI] 窗口 display:',d.css('display')),console.log('[VTT悬浮窗+AI] 窗口 opacity:',d.css('opacity')),function(t,e){let n=!1,r=0,o=0;e.on('mousedown',s=>{if($(s.target).closest('.vtt-control-btn').length>0)return;n=!0;const a=t.offset();r=s.pageX-a.left,o=s.pageY-a.top,e.css('cursor','grabbing'),$('body').addClass('vtt-dragging')}),$(document).on('mousemove.vtt-drag',e=>{if(n&&!t.hasClass('fullscreen')){const n=e.pageX-r,s=e.pageY-o,a=$(window).width()-t.outerWidth(),i=$(window).height()-t.outerHeight();t.css({left:Math.max(0,Math.min(n,a))+'px',top:Math.max(0,Math.min(s,i))+'px',transform:'none'})}}),$(document).on('mouseup.vtt-drag',()=>{n&&(n=!1,e.css('cursor','move'),$('body').removeClass('vtt-dragging'))})}(t,e),function(t){['n','e','s','w','ne','se','sw','nw'].forEach(e=>{const n=$('<div>').addClass(`vtt-resize-handle vtt-resize-${e}`).attr('data-direction',e);t.append(n)});let e=!1,n='',r=0,o=0,s=0,a=0,i=0,A=0;t.find('.vtt-resize-handle').on('mousedown',l=>{t.hasClass('fullscreen')||(e=!0,n=$(l.currentTarget).attr('data-direction'),r=l.pageX,o=l.pageY,s=t.width(),a=t.height(),i=t.offset().left,A=t.offset().top,$('body').addClass('vtt-resizing'),l.preventDefault())}),$(document).on('mousemove.vtt-resize',l=>{if(e){const e=l.pageX-r,c=l.pageY-o;let d=s,p=a,u=i,h=A;n.includes('e')&&(d=s+e),n.includes('w')&&(d=s-e,u=i+e),n.includes('s')&&(p=a+c),n.includes('n')&&(p=a-c,h=A+c),d=Math.max(400,d),p=Math.max(300,p),t.css({width:d+'px',height:p+'px',left:u+'px',top:h+'px'})}}),$(document).on('mouseup.vtt-resize',()=>{e&&(e=!1,$('body').removeClass('vtt-resizing'))})}(t),$(document).on('keydown.vtt-window',e=>{'Escape'===e.key&&t.is(':visible')&&t.hide()}),console.log('[VTT悬浮窗+AI] 开始显示窗口...'),t.show().css({display:'flex',opacity:'1',visibility:'visible'}),console.log('[VTT悬浮窗+AI] ✅ 窗口创建完成！'),setTimeout(()=>{const t=$('#vtt-floating-window'),e=t.is(':visible');console.log('[VTT悬浮窗+AI] 🔍 最终验证:'),console.log('  - 存在:',t.length),console.log('  - 可见:',e),console.log('  - display:',t.css('display')),e||(console.warn('[VTT悬浮窗+AI] ⚠️ 窗口不可见，强制显示...'),t.show().css('display','flex'),toastr.warning('地图窗口已强制显示'));const n=t[0]?.getBoundingClientRect();n&&(console.log('  - 实际尺寸:',n.width,'x',n.height),0!==n.width&&0!==n.height||console.error('[VTT悬浮窗+AI] ❌ 窗口尺寸为0！'))},500)}()}$(window).on('pagehide',()=>{$('#vtt-map-button').remove(),$('#vtt-floating-window').remove(),$('#ai-gm-control-btn').remove(),I&&(I.destroy(),I=null),toastr.info('🗺️ VTT 地图悬浮窗已卸载')}),console.log('[VTT悬浮窗+AI] document.readyState:',document.readyState),'loading'===document.readyState?(console.log('[VTT悬浮窗+AI] DOM 加载中，等待 ready 事件...'),$(k)):(console.log('[VTT悬浮窗+AI] DOM 已就绪，立即初始化'),k())})();
//# sourceMappingURL=index.js.map
