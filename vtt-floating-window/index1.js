(()=>{'use strict';var t={54:t=>{t.exports=function(t){var n=[];return n.toString=function(){return this.map(function(n){var e='',r=void 0!==n[5];return n[4]&&(e+='@supports ('.concat(n[4],') {')),n[2]&&(e+='@media '.concat(n[2],' {')),r&&(e+='@layer'.concat(n[5].length>0?' '.concat(n[5]):'',' {')),e+=t(n),r&&(e+='}'),n[2]&&(e+='}'),n[4]&&(e+='}'),e}).join('')},n.i=function(t,e,r,o,a){'string'==typeof t&&(t=[[null,t,void 0]]);var s={};if(r)for(var i=0;i<this.length;i++){var A=this[i][0];null!=A&&(s[A]=!0)}for(var c=0;c<t.length;c++){var l=[].concat(t[c]);r&&s[l[0]]||(void 0!==a&&(void 0===l[5]||(l[1]='@layer'.concat(l[5].length>0?' '.concat(l[5]):'',' {').concat(l[1],'}')),l[5]=a),e&&(l[2]?(l[1]='@media '.concat(l[2],' {').concat(l[1],'}'),l[2]=e):l[2]=e),o&&(l[4]?(l[1]='@supports ('.concat(l[4],') {').concat(l[1],'}'),l[4]=o):l[4]=''.concat(o)),n.push(l))}},n}},134:t=>{t.exports=function(t){var n=document.createElement('style');return t.setAttributes(n,t.attributes),t.insert(n,t.options),n}},219:t=>{t.exports=function(t){if('undefined'==typeof document)return{update:function(){},remove:function(){}};var n=t.insertStyleElement(t);return{update:function(e){!function(t,n,e){var r='';e.supports&&(r+='@supports ('.concat(e.supports,') {')),e.media&&(r+='@media '.concat(e.media,' {'));var o=void 0!==e.layer;o&&(r+='@layer'.concat(e.layer.length>0?' '.concat(e.layer):'',' {')),r+=e.css,o&&(r+='}'),e.media&&(r+='}'),e.supports&&(r+='}');var a=e.sourceMap;a&&'undefined'!=typeof btoa&&(r+='\n/*# sourceMappingURL=data:application/json;base64,'.concat(btoa(unescape(encodeURIComponent(JSON.stringify(a)))),' */')),n.styleTagTransform(r,t,n.options)}(n,t,e)},remove:function(){!function(t){if(null===t.parentNode)return!1;t.parentNode.removeChild(t)}(n)}}}},234:t=>{var n=[];function e(t){for(var e=-1,r=0;r<n.length;r++)if(n[r].identifier===t){e=r;break}return e}function r(t,r){for(var a={},s=[],i=0;i<t.length;i++){var A=t[i],c=r.base?A[0]+r.base:A[0],l=a[c]||0,d=''.concat(c,' ').concat(l);a[c]=l+1;var p=e(d),C={css:A[1],media:A[2],sourceMap:A[3],supports:A[4],layer:A[5]};if(-1!==p)n[p].references++,n[p].updater(C);else{var h=o(C,r);r.byIndex=i,n.splice(i,0,{identifier:d,updater:h,references:1})}s.push(d)}return s}function o(t,n){var e=n.domAPI(n);e.update(t);return function(n){if(n){if(n.css===t.css&&n.media===t.media&&n.sourceMap===t.sourceMap&&n.supports===t.supports&&n.layer===t.layer)return;e.update(t=n)}else e.remove()}}t.exports=function(t,o){var a=r(t=t||[],o=o||{});return function(t){t=t||[];for(var s=0;s<a.length;s++){var i=e(a[s]);n[i].references--}for(var A=r(t,o),c=0;c<a.length;c++){var l=e(a[c]);0===n[l].references&&(n[l].updater(),n.splice(l,1))}a=A}}},387:(t,n,e)=>{e.d(n,{A:()=>i});var r=e(790),o=e.n(r),a=e(54),s=e.n(a)()(o());s.push([t.id,'.vtt-map-button{position:fixed;bottom:20px;right:20px;z-index:9999;display:flex;align-items:center;gap:8px;padding:12px 20px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;border:none;border-radius:50px;box-shadow:0 4px 15px rgba(102,126,234,.4);font-size:16px;font-weight:600;cursor:pointer;transition:all .3s ease}.vtt-map-button:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(102,126,234,.6)}.vtt-map-button:active{transform:translateY(0)}.vtt-map-button svg{width:24px;height:24px}.vtt-floating-window{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);width:80vw;height:80vh;max-width:1400px;min-width:400px;min-height:300px;background:#1a1a1a;border:2px solid #667eea;border-radius:12px;box-shadow:0 10px 40px rgba(0,0,0,.5);z-index:10000;display:flex;flex-direction:column;overflow:hidden}.vtt-floating-window.fullscreen{top:0;left:0;transform:none;width:100vw !important;height:100vh !important;border-radius:0;max-width:none}.vtt-title-bar{padding:12px 20px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);display:flex;justify-content:space-between;align-items:center;cursor:move;-webkit-user-select:none;user-select:none}.vtt-title-bar .vtt-title{display:flex;align-items:center;gap:10px;color:#fff;font-size:18px;font-weight:600}.vtt-title-bar .vtt-title svg{width:20px;height:20px}.vtt-title-bar .vtt-controls{display:flex;gap:8px}.vtt-control-btn{padding:6px 12px;border:none;border-radius:5px;color:#fff;font-size:14px;font-weight:600;cursor:pointer;transition:all .2s ease}.vtt-control-btn:hover{transform:scale(1.05)}.vtt-control-btn:active{transform:scale(0.95)}.vtt-control-btn.vtt-minimize-btn{background:#ff9800}.vtt-control-btn.vtt-minimize-btn:hover{background:#fb8c00}.vtt-control-btn.vtt-fullscreen-btn{background:#2196f3}.vtt-control-btn.vtt-fullscreen-btn:hover{background:#1e88e5}.vtt-control-btn.vtt-close-btn{background:#f44336}.vtt-control-btn.vtt-close-btn:hover{background:#e53935}.vtt-content{flex:1;position:relative;overflow:hidden;background:#0a0a0a}.vtt-content.minimized{display:none}.vtt-loading{position:absolute;top:0;left:0;width:100%;height:100%;display:flex;flex-direction:column;justify-content:center;align-items:center;gap:20px;background:#0a0a0a;color:#fff;z-index:1}.vtt-loading .spinner{width:50px;height:50px;border:4px solid rgba(102,126,234,.3);border-top-color:#667eea;border-radius:50%;animation:spin 1s linear infinite}.vtt-loading p{margin:0;font-size:18px;color:#667eea}.vtt-loading small{font-size:14px;color:#999}.vtt-loading .error-icon{font-size:50px}@keyframes spin{to{transform:rotate(360deg)}}.vtt-iframe{width:100%;height:100%;border:none;background:#fff}.vtt-resize-handle{position:absolute;z-index:10}.vtt-resize-handle.vtt-resize-n{top:0;left:10px;right:10px;height:5px;cursor:n-resize}.vtt-resize-handle.vtt-resize-e{top:10px;right:0;bottom:10px;width:5px;cursor:e-resize}.vtt-resize-handle.vtt-resize-s{bottom:0;left:10px;right:10px;height:5px;cursor:s-resize}.vtt-resize-handle.vtt-resize-w{top:10px;left:0;bottom:10px;width:5px;cursor:w-resize}.vtt-resize-handle.vtt-resize-ne{top:0;right:0;width:10px;height:10px;cursor:ne-resize}.vtt-resize-handle.vtt-resize-se{bottom:0;right:0;width:10px;height:10px;cursor:se-resize}.vtt-resize-handle.vtt-resize-sw{bottom:0;left:0;width:10px;height:10px;cursor:sw-resize}.vtt-resize-handle.vtt-resize-nw{top:0;left:0;width:10px;height:10px;cursor:nw-resize}body.vtt-dragging,body.vtt-resizing{-webkit-user-select:none;user-select:none}body.vtt-dragging *,body.vtt-resizing *{cursor:inherit !important}@media (max-width:768px){.vtt-floating-window{width:95vw;height:90vh}.vtt-map-button{bottom:80px}}','',{version:3,sources:['webpack://./src/vtt-floating-window-with-ai/index.scss'],names:[],mappings:'AAGA,gBACE,cAAA,CACA,WAAA,CACA,UAAA,CACA,YAAA,CAEA,YAAA,CACA,kBAAA,CACA,OAAA,CAEA,iBAAA,CACA,0DAAA,CACA,UAAA,CACA,WAAA,CACA,kBAAA,CACA,0CAAA,CAEA,cAAA,CACA,eAAA,CACA,cAAA,CAEA,uBAAA,CAEA,sBACE,0BAAA,CACA,0CAAA,CAGF,uBACE,uBAAA,CAGF,oBACE,UAAA,CACA,WAAA,CAKJ,qBACE,cAAA,CACA,OAAA,CACA,QAAA,CACA,8BAAA,CAEA,UAAA,CACA,WAAA,CACA,gBAAA,CACA,eAAA,CACA,gBAAA,CAEA,kBAAA,CACA,wBAAA,CACA,kBAAA,CACA,qCAAA,CAEA,aAAA,CACA,YAAA,CACA,qBAAA,CAEA,eAAA,CAEA,gCACE,KAAA,CACA,MAAA,CACA,cAAA,CACA,sBAAA,CACA,uBAAA,CACA,eAAA,CACA,cAAA,CAKJ,eACE,iBAAA,CACA,0DAAA,CAEA,YAAA,CACA,6BAAA,CACA,kBAAA,CAEA,WAAA,CACA,wBAAA,CAAA,gBAAA,CAEA,0BACE,YAAA,CACA,kBAAA,CACA,QAAA,CAEA,UAAA,CACA,cAAA,CACA,eAAA,CAEA,8BACE,UAAA,CACA,WAAA,CAIJ,6BACE,YAAA,CACA,OAAA,CAKJ,iBACE,gBAAA,CACA,WAAA,CACA,iBAAA,CAEA,UAAA,CACA,cAAA,CACA,eAAA,CAEA,cAAA,CACA,uBAAA,CAEA,uBACE,qBAAA,CAGF,wBACE,qBAAA,CAGF,kCACE,kBAAA,CAEA,wCACE,kBAAA,CAIJ,oCACE,kBAAA,CAEA,0CACE,kBAAA,CAIJ,+BACE,kBAAA,CAEA,qCACE,kBAAA,CAMN,aACE,MAAA,CACA,iBAAA,CACA,eAAA,CACA,kBAAA,CAEA,uBACE,YAAA,CAKJ,aACE,iBAAA,CACA,KAAA,CACA,MAAA,CACA,UAAA,CACA,WAAA,CAEA,YAAA,CACA,qBAAA,CACA,sBAAA,CACA,kBAAA,CACA,QAAA,CAEA,kBAAA,CACA,UAAA,CACA,SAAA,CAEA,sBACE,UAAA,CACA,WAAA,CACA,qCAAA,CACA,wBAAA,CACA,iBAAA,CACA,iCAAA,CAGF,eACE,QAAA,CACA,cAAA,CACA,aAAA,CAGF,mBACE,cAAA,CACA,UAAA,CAGF,yBACE,cAAA,CAIJ,gBACE,GACE,wBAAA,CAAA,CAKJ,YACE,UAAA,CACA,WAAA,CACA,WAAA,CACA,eAAA,CAIF,mBACE,iBAAA,CACA,UAAA,CAEA,gCACE,KAAA,CACA,SAAA,CACA,UAAA,CACA,UAAA,CACA,eAAA,CAGF,gCACE,QAAA,CACA,OAAA,CACA,WAAA,CACA,SAAA,CACA,eAAA,CAGF,gCACE,QAAA,CACA,SAAA,CACA,UAAA,CACA,UAAA,CACA,eAAA,CAGF,gCACE,QAAA,CACA,MAAA,CACA,WAAA,CACA,SAAA,CACA,eAAA,CAGF,iCACE,KAAA,CACA,OAAA,CACA,UAAA,CACA,WAAA,CACA,gBAAA,CAGF,iCACE,QAAA,CACA,OAAA,CACA,UAAA,CACA,WAAA,CACA,gBAAA,CAGF,iCACE,QAAA,CACA,MAAA,CACA,UAAA,CACA,WAAA,CACA,gBAAA,CAGF,iCACE,KAAA,CACA,MAAA,CACA,UAAA,CACA,WAAA,CACA,gBAAA,CAKJ,oCAEE,wBAAA,CAAA,gBAAA,CAEA,wCACE,yBAAA,CAKJ,yBACE,qBACE,UAAA,CACA,WAAA,CAGF,gBACE,WAAA,CAAA',sourcesContent:['// VTT åœ°å›¾æ‚¬æµ®çª—æ ·å¼\r\n\r\n// æµ®åŠ¨æŒ‰é’®\r\n.vtt-map-button {\r\n  position: fixed;\r\n  bottom: 20px;\r\n  right: 20px;\r\n  z-index: 9999;\r\n\r\n  display: flex;\r\n  align-items: center;\r\n  gap: 8px;\r\n\r\n  padding: 12px 20px;\r\n  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\r\n  color: white;\r\n  border: none;\r\n  border-radius: 50px;\r\n  box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);\r\n\r\n  font-size: 16px;\r\n  font-weight: 600;\r\n  cursor: pointer;\r\n\r\n  transition: all 0.3s ease;\r\n\r\n  &:hover {\r\n    transform: translateY(-2px);\r\n    box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);\r\n  }\r\n\r\n  &:active {\r\n    transform: translateY(0);\r\n  }\r\n\r\n  svg {\r\n    width: 24px;\r\n    height: 24px;\r\n  }\r\n}\r\n\r\n// æ‚¬æµ®çª—\r\n.vtt-floating-window {\r\n  position: fixed;\r\n  top: 50%;\r\n  left: 50%;\r\n  transform: translate(-50%, -50%);\r\n\r\n  width: 80vw;\r\n  height: 80vh;\r\n  max-width: 1400px;\r\n  min-width: 400px;\r\n  min-height: 300px;\r\n\r\n  background: #1a1a1a;\r\n  border: 2px solid #667eea;\r\n  border-radius: 12px;\r\n  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);\r\n\r\n  z-index: 10000;\r\n  display: flex;\r\n  flex-direction: column;\r\n\r\n  overflow: hidden;\r\n\r\n  &.fullscreen {\r\n    top: 0;\r\n    left: 0;\r\n    transform: none;\r\n    width: 100vw !important;\r\n    height: 100vh !important;\r\n    border-radius: 0;\r\n    max-width: none;\r\n  }\r\n}\r\n\r\n// æ ‡é¢˜æ \r\n.vtt-title-bar {\r\n  padding: 12px 20px;\r\n  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\r\n\r\n  display: flex;\r\n  justify-content: space-between;\r\n  align-items: center;\r\n\r\n  cursor: move;\r\n  user-select: none;\r\n\r\n  .vtt-title {\r\n    display: flex;\r\n    align-items: center;\r\n    gap: 10px;\r\n\r\n    color: white;\r\n    font-size: 18px;\r\n    font-weight: 600;\r\n\r\n    svg {\r\n      width: 20px;\r\n      height: 20px;\r\n    }\r\n  }\r\n\r\n  .vtt-controls {\r\n    display: flex;\r\n    gap: 8px;\r\n  }\r\n}\r\n\r\n// æ§åˆ¶æŒ‰é’®\r\n.vtt-control-btn {\r\n  padding: 6px 12px;\r\n  border: none;\r\n  border-radius: 5px;\r\n\r\n  color: white;\r\n  font-size: 14px;\r\n  font-weight: 600;\r\n\r\n  cursor: pointer;\r\n  transition: all 0.2s ease;\r\n\r\n  &:hover {\r\n    transform: scale(1.05);\r\n  }\r\n\r\n  &:active {\r\n    transform: scale(0.95);\r\n  }\r\n\r\n  &.vtt-minimize-btn {\r\n    background: #ff9800;\r\n\r\n    &:hover {\r\n      background: #fb8c00;\r\n    }\r\n  }\r\n\r\n  &.vtt-fullscreen-btn {\r\n    background: #2196f3;\r\n\r\n    &:hover {\r\n      background: #1e88e5;\r\n    }\r\n  }\r\n\r\n  &.vtt-close-btn {\r\n    background: #f44336;\r\n\r\n    &:hover {\r\n      background: #e53935;\r\n    }\r\n  }\r\n}\r\n\r\n// å†…å®¹åŒºåŸŸ\r\n.vtt-content {\r\n  flex: 1;\r\n  position: relative;\r\n  overflow: hidden;\r\n  background: #0a0a0a;\r\n\r\n  &.minimized {\r\n    display: none;\r\n  }\r\n}\r\n\r\n// åŠ è½½ä¸­\r\n.vtt-loading {\r\n  position: absolute;\r\n  top: 0;\r\n  left: 0;\r\n  width: 100%;\r\n  height: 100%;\r\n\r\n  display: flex;\r\n  flex-direction: column;\r\n  justify-content: center;\r\n  align-items: center;\r\n  gap: 20px;\r\n\r\n  background: #0a0a0a;\r\n  color: white;\r\n  z-index: 1;\r\n\r\n  .spinner {\r\n    width: 50px;\r\n    height: 50px;\r\n    border: 4px solid rgba(102, 126, 234, 0.3);\r\n    border-top-color: #667eea;\r\n    border-radius: 50%;\r\n    animation: spin 1s linear infinite;\r\n  }\r\n\r\n  p {\r\n    margin: 0;\r\n    font-size: 18px;\r\n    color: #667eea;\r\n  }\r\n\r\n  small {\r\n    font-size: 14px;\r\n    color: #999;\r\n  }\r\n\r\n  .error-icon {\r\n    font-size: 50px;\r\n  }\r\n}\r\n\r\n@keyframes spin {\r\n  to {\r\n    transform: rotate(360deg);\r\n  }\r\n}\r\n\r\n// iframe\r\n.vtt-iframe {\r\n  width: 100%;\r\n  height: 100%;\r\n  border: none;\r\n  background: white;\r\n}\r\n\r\n// è°ƒæ•´å¤§å°æ‰‹æŸ„\r\n.vtt-resize-handle {\r\n  position: absolute;\r\n  z-index: 10;\r\n\r\n  &.vtt-resize-n {\r\n    top: 0;\r\n    left: 10px;\r\n    right: 10px;\r\n    height: 5px;\r\n    cursor: n-resize;\r\n  }\r\n\r\n  &.vtt-resize-e {\r\n    top: 10px;\r\n    right: 0;\r\n    bottom: 10px;\r\n    width: 5px;\r\n    cursor: e-resize;\r\n  }\r\n\r\n  &.vtt-resize-s {\r\n    bottom: 0;\r\n    left: 10px;\r\n    right: 10px;\r\n    height: 5px;\r\n    cursor: s-resize;\r\n  }\r\n\r\n  &.vtt-resize-w {\r\n    top: 10px;\r\n    left: 0;\r\n    bottom: 10px;\r\n    width: 5px;\r\n    cursor: w-resize;\r\n  }\r\n\r\n  &.vtt-resize-ne {\r\n    top: 0;\r\n    right: 0;\r\n    width: 10px;\r\n    height: 10px;\r\n    cursor: ne-resize;\r\n  }\r\n\r\n  &.vtt-resize-se {\r\n    bottom: 0;\r\n    right: 0;\r\n    width: 10px;\r\n    height: 10px;\r\n    cursor: se-resize;\r\n  }\r\n\r\n  &.vtt-resize-sw {\r\n    bottom: 0;\r\n    left: 0;\r\n    width: 10px;\r\n    height: 10px;\r\n    cursor: sw-resize;\r\n  }\r\n\r\n  &.vtt-resize-nw {\r\n    top: 0;\r\n    left: 0;\r\n    width: 10px;\r\n    height: 10px;\r\n    cursor: nw-resize;\r\n  }\r\n}\r\n\r\n// æ‹–åŠ¨å’Œè°ƒæ•´å¤§å°æ—¶çš„æ ·å¼\r\nbody.vtt-dragging,\r\nbody.vtt-resizing {\r\n  user-select: none;\r\n\r\n  * {\r\n    cursor: inherit !important;\r\n  }\r\n}\r\n\r\n// å“åº”å¼\r\n@media (max-width: 768px) {\r\n  .vtt-floating-window {\r\n    width: 95vw;\r\n    height: 90vh;\r\n  }\r\n\r\n  .vtt-map-button {\r\n    bottom: 80px; // é¿å…é®æŒ¡ç§»åŠ¨ç«¯è¾“å…¥æ¡†\r\n  }\r\n}\r\n'],sourceRoot:''}]);const i=s},699:t=>{t.exports=function(t,n){if(n.styleSheet)n.styleSheet.cssText=t;else{for(;n.firstChild;)n.removeChild(n.firstChild);n.appendChild(document.createTextNode(t))}}},714:(t,n,e)=>{t.exports=function(t){var n=e.nc;n&&t.setAttribute('nonce',n)}},790:t=>{t.exports=function(t){var n=t[1],e=t[3];if(!e)return n;if('function'==typeof btoa){var r=btoa(unescape(encodeURIComponent(JSON.stringify(e)))),o='sourceMappingURL=data:application/json;charset=utf-8;base64,'.concat(r),a='/*# '.concat(o,' */');return[n].concat([a]).join('\n')}return[n].join('\n')}},881:t=>{var n={};t.exports=function(t,e){var r=function(t){if(void 0===n[t]){var e=document.querySelector(t);if(window.HTMLIFrameElement&&e instanceof window.HTMLIFrameElement)try{e=e.contentDocument.head}catch(t){e=null}n[t]=e}return n[t]}(t);if(!r)throw new Error('Couldn\'t find a style target. This probably means that the value for the \'insert\' parameter is invalid.');r.appendChild(e)}}},n={};function e(r){var o=n[r];if(void 0!==o)return o.exports;var a=n[r]={id:r,exports:{}};return t[r](a,a.exports,e),a.exports}e.n=t=>{var n=t&&t.__esModule?()=>t.default:()=>t;return e.d(n,{a:n}),n},e.d=(t,n)=>{for(var r in n)e.o(n,r)&&!e.o(t,r)&&Object.defineProperty(t,r,{enumerable:!0,get:n[r]})},e.o=(t,n)=>Object.prototype.hasOwnProperty.call(t,n),e.nc=void 0;var r=e(234),o=e.n(r),a=e(219),s=e.n(a),i=e(881),A=e.n(i),c=e(714),l=e.n(c),d=e(134),p=e.n(d),C=e(699),h=e.n(C),m=e(387),u={};u.styleTagTransform=h(),u.setAttributes=l(),u.insert=A().bind(null,'head'),u.domAPI=s(),u.insertStyleElement=p();o()(m.A,u);m.A&&m.A.locals&&m.A.locals;const g=z,v=g.z.object({action:g.z.enum(['move_token','open_door','close_door','toggle_light','reveal_area','spawn_token','remove_token','play_sound','chat_message','roll_dice','trigger_event']),params:g.z.record(g.z.any()),description:g.z.string().optional()}),f=g.z.object({narrative:g.z.string(),commands:g.z.array(v),context:g.z.record(g.z.any()).optional()});class x{mapState;context;commandQueue=[];executing=!1;constructor(){this.mapState=this.loadMapState(),this.context=this.loadContext()}async handlePlayerInput(t){try{const n=function(t,n){return`ä½ æ˜¯ä¸€ä¸ª TRPG æ¸¸æˆçš„ GMï¼ˆGame Masterï¼‰ï¼Œéœ€è¦æ ¹æ®ç©å®¶çš„è¡ŒåŠ¨æ¥æ§åˆ¶è™šæ‹Ÿæ¡Œé¢ï¼ˆVTTï¼‰åœ°å›¾ã€‚\n\n## å½“å‰åœ°å›¾çŠ¶æ€\n\nåœ°å›¾åç§°: ${n.mapName}\nå½“å‰æˆ¿é—´: ${n.currentRoom}\n\nç©å®¶ä½ç½®: (${n.playerToken.x}, ${n.playerToken.y})\nç©å®¶è§†é‡èŒƒå›´: ${n.playerToken.vision} æ ¼\n\nå¯è§çš„é—¨:\n${n.visibleDoors.map(t=>`- ${t.name}: ${1===t.state?'å¼€å¯':'å…³é—­'} (ä½ç½®: ${t.x}, ${t.y})`).join('\n')}\n\nå¯è§çš„ç‰©å“:\n${n.visibleItems.map(t=>`- ${t.name} (ä½ç½®: ${t.x}, ${t.y})`).join('\n')}\n\né™„è¿‘çš„ NPC:\n${n.nearbyNPCs.map(t=>`- ${t.name} (ä½ç½®: ${t.x}, ${t.y})`).join('\n')}\n\n## ç©å®¶è¾“å…¥\n\n"${t}"\n\n## ä½ çš„ä»»åŠ¡\n\n1. ç†è§£ç©å®¶çš„æ„å›¾\n2. ç”Ÿæˆå™è¿°æ–‡æœ¬ï¼ˆæè¿°åœºæ™¯å˜åŒ–ï¼‰\n3. ç”Ÿæˆæ§åˆ¶æŒ‡ä»¤ï¼ˆç§»åŠ¨ Tokenã€å¼€é—¨ç­‰ï¼‰\n\n## å¯ç”¨æŒ‡ä»¤\n\n### ç§»åŠ¨ Token\n\`\`\`json\n{\n  "action": "move_token",\n  "params": {\n    "tokenId": "player1",\n    "x": ç›®æ ‡Xåæ ‡,\n    "y": ç›®æ ‡Yåæ ‡,\n    "animated": true  // æ˜¯å¦æ’­æ”¾ç§»åŠ¨åŠ¨ç”»\n  }\n}\n\`\`\`\n\n### å¼€é—¨/å…³é—¨\n\`\`\`json\n{\n  "action": "open_door",\n  "params": {\n    "doorId": "door_1"\n  }\n}\n\`\`\`\n\n### æ­ç¤ºåŒºåŸŸï¼ˆç§»é™¤æˆ˜äº‰è¿·é›¾ï¼‰\n\`\`\`json\n{\n  "action": "reveal_area",\n  "params": {\n    "roomId": "room_left",\n    "permanent": true  // æ˜¯å¦æ°¸ä¹…æ­ç¤º\n  }\n}\n\`\`\`\n\n### ç”Ÿæˆ NPC/æ€ªç‰©\n\`\`\`json\n{\n  "action": "spawn_token",\n  "params": {\n    "type": "npc",\n    "name": "å“¥å¸ƒæ—æˆ˜å£«",\n    "x": åæ ‡,\n    "y": åæ ‡,\n    "image": "è·¯å¾„ï¼ˆå¯é€‰ï¼‰",\n    "stats": {\n      "hp": 20,\n      "ac": 14\n    }\n  }\n}\n\`\`\`\n\n### æ’­æ”¾éŸ³æ•ˆ\n\`\`\`json\n{\n  "action": "play_sound",\n  "params": {\n    "soundId": "door_creak",\n    "volume": 0.5\n  }\n}\n\`\`\`\n\n### å‘é€ç³»ç»Ÿæ¶ˆæ¯\n\`\`\`json\n{\n  "action": "chat_message",\n  "params": {\n    "type": "system",\n    "message": "ä½ å¬åˆ°è¿œå¤„ä¼ æ¥å¥‡æ€ªçš„å£°éŸ³..."\n  }\n}\n\`\`\`\n\n## å“åº”æ ¼å¼\n\nè¯·ä»¥ JSON æ ¼å¼è¿”å›ï¼ŒåŒ…å«ä»¥ä¸‹å­—æ®µï¼š\n\n\`\`\`json\n{\n  "narrative": "ä½ æ¨å¼€åšé‡çš„æœ¨é—¨ï¼Œé—¨è½´å‘å‡ºåˆºè€³çš„å±å‘€å£°ã€‚é—¨åæ˜¯ä¸€ä¸ªæ˜æš—çš„æˆ¿é—´ï¼Œä½ éšçº¦çœ‹åˆ°æˆ¿é—´ä¸­å¤®æœ‰ä¸€ä¸ªæœ¨ç®±ã€‚",\n  "commands": [\n    {\n      "action": "open_door",\n      "params": { "doorId": "door_1" },\n      "description": "æ‰“å¼€å·¦è¾¹çš„é—¨"\n    },\n    {\n      "action": "play_sound",\n      "params": { "soundId": "door_creak", "volume": 0.5 },\n      "description": "æ’­æ”¾å¼€é—¨éŸ³æ•ˆ"\n    },\n    {\n      "action": "move_token",\n      "params": { "tokenId": "player1", "x": 1500, "y": 1000, "animated": true },\n      "description": "ç©å®¶è¿›å…¥æˆ¿é—´"\n    },\n    {\n      "action": "reveal_area",\n      "params": { "roomId": "room_left", "permanent": true },\n      "description": "æ­ç¤ºæˆ¿é—´å†…éƒ¨"\n    }\n  ],\n  "context": {\n    "currentRoom": "room_left",\n    "discoveredRooms": ["entrance", "room_left"]\n  }\n}\n\`\`\`\n\nè¯·æ ¹æ®ç©å®¶çš„è¾“å…¥ç”Ÿæˆåˆé€‚çš„å“åº”ã€‚åªè¿”å› JSONï¼Œä¸è¦æœ‰å…¶ä»–æ–‡å­—ã€‚`}(t,this.getMapContext()),e=await this.callAI(n),r=this.parseAIResponse(e);return await this.executeCommands(r.commands),r.context&&this.updateContext(r.context),{narrative:r.narrative,success:!0}}catch(t){return console.error('AI-GM å¤„ç†å¤±è´¥:',t),{narrative:'æŠ±æ­‰ï¼Œæˆ‘æ— æ³•ç†è§£ä½ çš„æ„å›¾ã€‚è¯·æ¢ä¸€ç§æ–¹å¼æè¿°ã€‚',success:!1}}}async callAI(t){const n=await fetch('/api/backends/chat-completions/generate',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({messages:[{role:'system',content:'ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ TRPG GMï¼Œéœ€è¦æ ¹æ®ç©å®¶è¾“å…¥ç”Ÿæˆ VTT æ§åˆ¶æŒ‡ä»¤ã€‚å§‹ç»ˆä»¥ JSON æ ¼å¼è¿”å›ã€‚'},{role:'user',content:t}],max_tokens:1e3,temperature:.7})});return(await n.json()).choices[0].message.content}parseAIResponse(t){const n=t.match(/```json\n?([\s\S]*?)\n?```/)||t.match(/\{[\s\S]*\}/);if(!n)throw new Error('AI å“åº”æ ¼å¼é”™è¯¯ï¼šæœªæ‰¾åˆ°æœ‰æ•ˆçš„ JSON');const e=n[1]||n[0],r=JSON.parse(e);return f.parse(r)}async executeCommands(t){if(this.commandQueue.push(...t),!this.executing){this.executing=!0;try{for(;this.commandQueue.length>0;){const t=this.commandQueue.shift();await this.executeCommand(t),await this.sleep(500)}}finally{this.executing=!1}}}async executeCommand(t){switch(console.log(`ğŸ¬ æ‰§è¡ŒæŒ‡ä»¤: ${t.action}`,t.params),t.action){case'move_token':await this.moveToken(t.params);break;case'open_door':await this.openDoor(t.params);break;case'close_door':await this.closeDoor(t.params);break;case'toggle_light':await this.toggleLight(t.params);break;case'reveal_area':await this.revealArea(t.params);break;case'spawn_token':await this.spawnToken(t.params);break;case'remove_token':await this.removeToken(t.params);break;case'play_sound':await this.playSound(t.params);break;case'chat_message':await this.sendChatMessage(t.params);break;case'roll_dice':await this.rollDice(t.params);break;case'trigger_event':await this.triggerEvent(t.params);break;default:console.warn(`æœªçŸ¥æŒ‡ä»¤: ${t.action}`)}}async moveToken(t){const{tokenId:n,x:e,y:r,animated:o=!0}=t,a=this.loadMapState(),s=a.tokens.find(t=>t.id===n);s?(s.x=e,s.y=r,this.saveMapState(a),this.notifyMapUpdate()):console.warn(`Token ${n} ä¸å­˜åœ¨`)}async openDoor(t){const{doorId:n}=t,e=this.loadMapState(),r=e.walls.find(t=>t.id===n||1===t.door);r?(r.ds=1,this.saveMapState(e),this.notifyMapUpdate()):console.warn(`é—¨ ${n} ä¸å­˜åœ¨`)}async closeDoor(t){const{doorId:n}=t,e=this.loadMapState(),r=e.walls.find(t=>t.id===n);r&&(r.ds=0,this.saveMapState(e),this.notifyMapUpdate())}async toggleLight(t){const{lightId:n,enabled:e}=t,r=this.loadMapState(),o=r.lights.find(t=>t.id===n);o&&(o.enabled=e??!o.enabled,this.saveMapState(r),this.notifyMapUpdate())}async revealArea(t){const{roomId:n,x:e,y:r,width:o,height:a,permanent:s=!0}=t;console.log(`æ­ç¤ºåŒºåŸŸ: ${n}`),this.notifyMapUpdate()}async spawnToken(t){const{type:n,name:e,x:r,y:o,image:a,stats:s}=t,i=this.loadMapState(),A={id:`token_${Date.now()}`,name:e||'æœªå‘½å',x:r,y:o,width:1,height:1,vision:'monster'===n?0:12,image:a,stats:s||{}};i.tokens.push(A),this.saveMapState(i),this.notifyMapUpdate()}async removeToken(t){const{tokenId:n}=t,e=this.loadMapState();e.tokens=e.tokens.filter(t=>t.id!==n),this.saveMapState(e),this.notifyMapUpdate()}async playSound(t){const{soundId:n,volume:e=.5}=t;console.log(`æ’­æ”¾éŸ³æ•ˆ: ${n} (éŸ³é‡: ${e})`)}async sendChatMessage(t){const{type:n='system',message:e}=t;toastr.info(e,'system'===n?'ç³»ç»Ÿ':'GM')}async rollDice(t){const{formula:n,reason:e}=t;console.log(`æ·éª°: ${n} (${e})`)}async triggerEvent(t){const{eventId:n,data:e}=t;console.log(`è§¦å‘äº‹ä»¶: ${n}`,e)}getMapContext(){const t=this.loadMapState();return{mapName:t.name||'æœªå‘½ååœ°å›¾',currentRoom:this.context.currentRoom||'unknown',playerToken:t.tokens.find(t=>'player1'===t.id)||{},visibleDoors:this.getVisibleDoors(t),visibleItems:this.getVisibleItems(t),nearbyNPCs:this.getNearbyNPCs(t)}}getVisibleDoors(t){return t.walls.filter(t=>t.door>0).map((t,n)=>({id:t.id||`door_${n}`,name:`é—¨ ${n+1}`,state:t.ds,x:t.c[0],y:t.c[1]}))}getVisibleItems(t){return[]}getNearbyNPCs(t){return t.tokens.filter(t=>'player1'!==t.id)}loadMapState(){return getVariables({type:'script',script_id:getScriptId()}).vtt_map_data||{tokens:[],walls:[],lights:[]}}saveMapState(t){replaceVariables({vtt_map_data:t},{type:'script',script_id:getScriptId()})}loadContext(){return getVariables({type:'script',script_id:getScriptId()}).ai_gm_context||{currentRoom:'entrance',discoveredRooms:[]}}updateContext(t){this.context={...this.context,...t},replaceVariables({ai_gm_context:this.context},{type:'script',script_id:getScriptId()})}notifyMapUpdate(){window.dispatchEvent(new CustomEvent('vtt-map-update'))}sleep(t){return new Promise(n=>setTimeout(n,t))}}const b='https://yyk9137.github.io/my-vtt-maps/vtt-map-viewer/index.html';let w=null;function y(){console.log('[VTTæ‚¬æµ®çª—+AI] å¼€å§‹åˆå§‹åŒ–...'),toastr.success('ğŸ—ºï¸ VTT åœ°å›¾æ‚¬æµ®çª—ï¼ˆAI å¢å¼ºç‰ˆï¼‰å·²åŠ è½½');try{console.log('[VTTæ‚¬æµ®çª—+AI] æ­£åœ¨åˆ›å»ºæµ®åŠ¨æŒ‰é’®...'),function(){if($('#vtt-map-button').length>0)return;const t=$('<button>').attr('id','vtt-map-button').attr('title','æ‰“å¼€ VTT åœ°å›¾ (Ctrl+M)').addClass('vtt-map-button').html('\n      <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">\n        <path d="M20.5 3l-.16.03L15 5.1 9 3 3.36 4.9c-.21.07-.36.25-.36.48V20.5c0 .28.22.5.5.5l.16-.03L9 18.9l6 2.1 5.64-1.9c.21-.07.36-.25.36-.48V3.5c0-.28-.22-.5-.5-.5zM15 19l-6-2.11V5l6 2.11V19z"/>\n      </svg>\n      <span>åœ°å›¾</span>\n    ').on('click',()=>{E()});$('body').append(t)}(),console.log('[VTTæ‚¬æµ®çª—+AI] âœ… æµ®åŠ¨æŒ‰é’®åˆ›å»ºæˆåŠŸ'),console.log('[VTTæ‚¬æµ®çª—+AI] æ­£åœ¨æ³¨å†Œå¿«æ·é”®...'),$(document).on('keydown',t=>{t.ctrlKey&&'m'===t.key&&(t.preventDefault(),console.log('[VTTæ‚¬æµ®çª—+AI] å¿«æ·é”® Ctrl+M è§¦å‘'),E())}),console.log('[VTTæ‚¬æµ®çª—+AI] âœ… å¿«æ·é”®æ³¨å†ŒæˆåŠŸ'),console.log('[VTTæ‚¬æµ®çª—+AI] æ­£åœ¨åˆå§‹åŒ– AI-GM æ§åˆ¶å™¨...'),w=new x,console.log('[VTTæ‚¬æµ®çª—+AI] âœ… AI-GM æ§åˆ¶å™¨åˆå§‹åŒ–æˆåŠŸ'),console.log('[VTTæ‚¬æµ®çª—+AI] æ­£åœ¨æ³¨å†Œæ¶ˆæ¯ç›‘å¬...'),$(document).on('message_received',async t=>{const n=t.detail?.message;if(n&&n.is_user&&(console.log('[AI-GM] æ£€æµ‹åˆ°ç”¨æˆ·æ¶ˆæ¯:',n.mes),['é—¨','ç¯','å…‰','ç§»åŠ¨','è¿›å…¥','æŸ¥çœ‹','æœç´¢','æ‰“å¼€','å…³é—­'].some(t=>n.mes.includes(t)))){console.log('[AI-GM] æ£€æµ‹åˆ°åœ°å›¾åŠ¨ä½œï¼Œè‡ªåŠ¨å¤„ç†...');try{(await w.handlePlayerInput(n.mes)).success&&(k(),toastr.info('ğŸ—ºï¸ åœ°å›¾å·²æ›´æ–°'))}catch(t){console.error('[AI-GM] è‡ªåŠ¨å¤„ç†å¤±è´¥:',t)}}}),console.log('[VTTæ‚¬æµ®çª—+AI] âœ… æ¶ˆæ¯ç›‘å¬æ³¨å†ŒæˆåŠŸ'),function(){if($('#ai-gm-control-btn').length>0)return;const t=$('<button>').attr('id','ai-gm-control-btn').attr('title','è®© AI æ ¹æ®æœ€åä¸€æ¡æ¶ˆæ¯æ§åˆ¶åœ°å›¾').css({position:'fixed',bottom:'20px',right:'140px',zIndex:9999,display:'flex',alignItems:'center',gap:'8px',padding:'12px 20px',background:'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',color:'white',border:'none',borderRadius:'50px',boxShadow:'0 4px 15px rgba(240, 147, 251, 0.4)',fontSize:'16px',fontWeight:'600',cursor:'pointer',transition:'all 0.3s ease'}).html('ğŸ¤– AI-GM').on('click',async()=>{t.prop('disabled',!0).html('â³ å¤„ç†ä¸­...');try{const t=function(){const t=getChatMessages();if(!t||0===t.length)return null;for(let n=t.length-1;n>=0;n--)if(t[n].is_user)return t[n].mes;return null}();if(!t)return void toastr.warning('æ²¡æœ‰æ‰¾åˆ°æœ€è¿‘çš„ç”¨æˆ·æ¶ˆæ¯');console.log('[AI-GM] å¤„ç†ç”¨æˆ·è¾“å…¥:',t);const e=await w.handlePlayerInput(t);e.success?(toastr.success('âœ… AI å·²æ‰§è¡ŒåŠ¨ä½œ'),n=e.narrative,triggerSlash('/echo '+n,{source:'ai-gm'}),k()):toastr.error('âŒ AI å¤„ç†å¤±è´¥')}catch(t){console.error('[AI-GM] é”™è¯¯:',t),toastr.error('AI å¤„ç†å‡ºé”™ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°')}finally{t.prop('disabled',!1).html('ğŸ¤– AI-GM')}var n}).hover(function(){$(this).css({transform:'translateY(-2px)',boxShadow:'0 6px 20px rgba(240, 147, 251, 0.6)'})},function(){$(this).css({transform:'translateY(0)',boxShadow:'0 4px 15px rgba(240, 147, 251, 0.4)'})});$('body').append(t)}(),console.log('[VTTæ‚¬æµ®çª—+AI] âœ… åˆå§‹åŒ–å®Œæˆï¼')}catch(t){console.error('[VTTæ‚¬æµ®çª—+AI] âŒ åˆå§‹åŒ–å¤±è´¥:',t),toastr.error('VTT æ‚¬æµ®çª—åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°')}}function k(){const t=$('#vtt-floating-window iframe');if(t.length>0){const n=t[0].contentWindow;n?.postMessage({type:'vtt-map-refresh'},'*')}}function E(){const t=$('#vtt-floating-window');t.length>0?t.is(':visible')?t.hide():t.show():function(){const t=$('<div>').attr('id','vtt-floating-window').addClass('vtt-floating-window'),n=$('<div>').addClass('vtt-title-bar'),e=$('<div>').addClass('vtt-title').html('\n      <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">\n        <path d="M20.5 3l-.16.03L15 5.1 9 3 3.36 4.9c-.21.07-.36.25-.36.48V20.5c0 .28.22.5.5.5l.16-.03L9 18.9l6 2.1 5.64-1.9c.21-.07.36-.25.36-.48V3.5c0-.28-.22-.5-.5-.5zM15 19l-6-2.11V5l6 2.11V19z"/>\n      </svg>\n      <span>VTT åœ°å›¾æŸ¥çœ‹å™¨ (AI å¢å¼º)</span>\n    '),r=$('<div>').addClass('vtt-controls'),o=$('<button>').addClass('vtt-control-btn vtt-minimize-btn').attr('title','æœ€å°åŒ–').html('â–').on('click',()=>{const n=t.find('.vtt-content');n.hasClass('minimized')?(n.removeClass('minimized'),t.css('height','80vh'),o.html('â–')):(n.addClass('minimized'),t.css('height','auto'),o.html('â¬œ'))}),a=$('<button>').addClass('vtt-control-btn vtt-fullscreen-btn').attr('title','å…¨å±').html('â›¶').on('click',()=>{t.hasClass('fullscreen')?(t.removeClass('fullscreen'),a.html('â›¶')):(t.addClass('fullscreen'),a.html('ğŸ——'))}),s=$('<button>').addClass('vtt-control-btn vtt-close-btn').attr('title','å…³é—­ (Esc)').html('âŒ').on('click',()=>{t.hide()});r.append(o,a,s),n.append(e,r);const i=$('<div>').addClass('vtt-content'),A=$('<div>').addClass('vtt-loading').html('\n      <div class="spinner"></div>\n      <p>æ­£åœ¨åŠ è½½ VTT åœ°å›¾...</p>\n    '),c=$('<iframe>').addClass('vtt-iframe').attr('src',b).attr('allow','fullscreen').on('load',()=>{A.fadeOut(),toastr.success('ğŸ—ºï¸ åœ°å›¾åŠ è½½å®Œæˆ')}).on('error',()=>{A.html('\n        <div class="error-icon">âš ï¸</div>\n        <p>åœ°å›¾åŠ è½½å¤±è´¥</p>\n        <small>è¯·æ£€æŸ¥ URL æ˜¯å¦æ­£ç¡®</small>\n      '),toastr.error('âŒ åœ°å›¾åŠ è½½å¤±è´¥')});i.append(A,c),t.append(n,i),$('body').append(t),function(t,n){let e=!1,r=0,o=0;n.on('mousedown',a=>{if($(a.target).closest('.vtt-control-btn').length>0)return;e=!0;const s=t.offset();r=a.pageX-s.left,o=a.pageY-s.top,n.css('cursor','grabbing'),$('body').addClass('vtt-dragging')}),$(document).on('mousemove.vtt-drag',n=>{if(e&&!t.hasClass('fullscreen')){const e=n.pageX-r,a=n.pageY-o,s=$(t).width()-t.outerWidth(),i=$(t).height()-t.outerHeight();t.css({left:Math.max(0,Math.min(e,s))+'px',top:Math.max(0,Math.min(a,i))+'px',transform:'none'})}}),$(document).on('mouseup.vtt-drag',()=>{e&&(e=!1,n.css('cursor','move'),$('body').removeClass('vtt-dragging'))})}(t,n),function(t){['n','e','s','w','ne','se','sw','nw'].forEach(n=>{const e=$('<div>').addClass(`vtt-resize-handle vtt-resize-${n}`).attr('data-direction',n);t.append(e)});let n=!1,e='',r=0,o=0,a=0,s=0,i=0,A=0;t.find('.vtt-resize-handle').on('mousedown',c=>{t.hasClass('fullscreen')||(n=!0,e=$(c.currentTarget).attr('data-direction'),r=c.pageX,o=c.pageY,a=t.width(),s=t.height(),i=t.offset().left,A=t.offset().top,$('body').addClass('vtt-resizing'),c.preventDefault())}),$(document).on('mousemove.vtt-resize',c=>{if(n){const n=c.pageX-r,l=c.pageY-o;let d=a,p=s,C=i,h=A;e.includes('e')&&(d=a+n),e.includes('w')&&(d=a-n,C=i+n),e.includes('s')&&(p=s+l),e.includes('n')&&(p=s-l,h=A+l),d=Math.max(400,d),p=Math.max(300,p),t.css({width:d+'px',height:p+'px',left:C+'px',top:h+'px'})}}),$(document).on('mouseup.vtt-resize',()=>{n&&(n=!1,$('body').removeClass('vtt-resizing'))})}(t),$(document).on('keydown.vtt-window',n=>{'Escape'===n.key&&t.is(':visible')&&t.hide()}),t.fadeIn(300)}()}$(window).on('pagehide',()=>{$('#vtt-map-button').remove(),$('#vtt-floating-window').remove(),$('#ai-gm-control-btn').remove(),toastr.info('ğŸ—ºï¸ VTT åœ°å›¾æ‚¬æµ®çª—å·²å¸è½½')}),console.log('[VTTæ‚¬æµ®çª—+AI] document.readyState:',document.readyState),'loading'===document.readyState?(console.log('[VTTæ‚¬æµ®çª—+AI] DOM åŠ è½½ä¸­ï¼Œç­‰å¾… ready äº‹ä»¶...'),$(y)):(console.log('[VTTæ‚¬æµ®çª—+AI] DOM å·²å°±ç»ªï¼Œç«‹å³åˆå§‹åŒ–'),y())})();
//# sourceMappingURL=index.js.map
