(()=>{'use strict';var t={54:t=>{t.exports=function(t){var n=[];return n.toString=function(){return this.map(function(n){var e='',r=void 0!==n[5];return n[4]&&(e+='@supports ('.concat(n[4],') {')),n[2]&&(e+='@media '.concat(n[2],' {')),r&&(e+='@layer'.concat(n[5].length>0?' '.concat(n[5]):'',' {')),e+=t(n),r&&(e+='}'),n[2]&&(e+='}'),n[4]&&(e+='}'),e}).join('')},n.i=function(t,e,r,o,a){'string'==typeof t&&(t=[[null,t,void 0]]);var s={};if(r)for(var i=0;i<this.length;i++){var A=this[i][0];null!=A&&(s[A]=!0)}for(var l=0;l<t.length;l++){var c=[].concat(t[l]);r&&s[c[0]]||(void 0!==a&&(void 0===c[5]||(c[1]='@layer'.concat(c[5].length>0?' '.concat(c[5]):'',' {').concat(c[1],'}')),c[5]=a),e&&(c[2]?(c[1]='@media '.concat(c[2],' {').concat(c[1],'}'),c[2]=e):c[2]=e),o&&(c[4]?(c[1]='@supports ('.concat(c[4],') {').concat(c[1],'}'),c[4]=o):c[4]=''.concat(o)),n.push(c))}},n}},134:t=>{t.exports=function(t){var n=document.createElement('style');return t.setAttributes(n,t.attributes),t.insert(n,t.options),n}},219:t=>{t.exports=function(t){if('undefined'==typeof document)return{update:function(){},remove:function(){}};var n=t.insertStyleElement(t);return{update:function(e){!function(t,n,e){var r='';e.supports&&(r+='@supports ('.concat(e.supports,') {')),e.media&&(r+='@media '.concat(e.media,' {'));var o=void 0!==e.layer;o&&(r+='@layer'.concat(e.layer.length>0?' '.concat(e.layer):'',' {')),r+=e.css,o&&(r+='}'),e.media&&(r+='}'),e.supports&&(r+='}');var a=e.sourceMap;a&&'undefined'!=typeof btoa&&(r+='\n/*# sourceMappingURL=data:application/json;base64,'.concat(btoa(unescape(encodeURIComponent(JSON.stringify(a)))),' */')),n.styleTagTransform(r,t,n.options)}(n,t,e)},remove:function(){!function(t){if(null===t.parentNode)return!1;t.parentNode.removeChild(t)}(n)}}}},234:t=>{var n=[];function e(t){for(var e=-1,r=0;r<n.length;r++)if(n[r].identifier===t){e=r;break}return e}function r(t,r){for(var a={},s=[],i=0;i<t.length;i++){var A=t[i],l=r.base?A[0]+r.base:A[0],c=a[l]||0,d=''.concat(l,' ').concat(c);a[l]=c+1;var p=e(d),h={css:A[1],media:A[2],sourceMap:A[3],supports:A[4],layer:A[5]};if(-1!==p)n[p].references++,n[p].updater(h);else{var g=o(h,r);r.byIndex=i,n.splice(i,0,{identifier:d,updater:g,references:1})}s.push(d)}return s}function o(t,n){var e=n.domAPI(n);e.update(t);return function(n){if(n){if(n.css===t.css&&n.media===t.media&&n.sourceMap===t.sourceMap&&n.supports===t.supports&&n.layer===t.layer)return;e.update(t=n)}else e.remove()}}t.exports=function(t,o){var a=r(t=t||[],o=o||{});return function(t){t=t||[];for(var s=0;s<a.length;s++){var i=e(a[s]);n[i].references--}for(var A=r(t,o),l=0;l<a.length;l++){var c=e(a[l]);0===n[c].references&&(n[c].updater(),n.splice(c,1))}a=A}}},387:(t,n,e)=>{e.d(n,{A:()=>i});var r=e(790),o=e.n(r),a=e(54),s=e.n(a)()(o());s.push([t.id,'.vtt-map-button{position:fixed;bottom:20px;right:20px;z-index:9999;display:flex;align-items:center;gap:8px;padding:12px 20px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;border:none;border-radius:50px;box-shadow:0 4px 15px rgba(102,126,234,.4);font-size:16px;font-weight:600;cursor:pointer;transition:all .3s ease}.vtt-map-button:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(102,126,234,.6)}.vtt-map-button:active{transform:translateY(0)}.vtt-map-button svg{width:24px;height:24px}.vtt-floating-window{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);width:80vw;height:80vh;max-width:1400px;min-width:400px;min-height:300px;background:#1a1a1a;border:2px solid #667eea;border-radius:12px;box-shadow:0 10px 40px rgba(0,0,0,.5);z-index:10000;display:flex;flex-direction:column;overflow:hidden}.vtt-floating-window.fullscreen{top:0;left:0;transform:none;width:100vw !important;height:100vh !important;border-radius:0;max-width:none}.vtt-title-bar{padding:12px 20px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);display:flex;justify-content:space-between;align-items:center;cursor:move;-webkit-user-select:none;user-select:none}.vtt-title-bar .vtt-title{display:flex;align-items:center;gap:10px;color:#fff;font-size:18px;font-weight:600}.vtt-title-bar .vtt-title svg{width:20px;height:20px}.vtt-title-bar .vtt-controls{display:flex;gap:8px}.vtt-control-btn{padding:6px 12px;border:none;border-radius:5px;color:#fff;font-size:14px;font-weight:600;cursor:pointer;transition:all .2s ease}.vtt-control-btn:hover{transform:scale(1.05)}.vtt-control-btn:active{transform:scale(0.95)}.vtt-control-btn.vtt-minimize-btn{background:#ff9800}.vtt-control-btn.vtt-minimize-btn:hover{background:#fb8c00}.vtt-control-btn.vtt-fullscreen-btn{background:#2196f3}.vtt-control-btn.vtt-fullscreen-btn:hover{background:#1e88e5}.vtt-control-btn.vtt-close-btn{background:#f44336}.vtt-control-btn.vtt-close-btn:hover{background:#e53935}.vtt-content{flex:1;position:relative;overflow:hidden;background:#0a0a0a}.vtt-content.minimized{display:none}.vtt-loading{position:absolute;top:0;left:0;width:100%;height:100%;display:flex;flex-direction:column;justify-content:center;align-items:center;gap:20px;background:#0a0a0a;color:#fff;z-index:1}.vtt-loading .spinner{width:50px;height:50px;border:4px solid rgba(102,126,234,.3);border-top-color:#667eea;border-radius:50%;animation:spin 1s linear infinite}.vtt-loading p{margin:0;font-size:18px;color:#667eea}.vtt-loading small{font-size:14px;color:#999}.vtt-loading .error-icon{font-size:50px}@keyframes spin{to{transform:rotate(360deg)}}.vtt-iframe{width:100%;height:100%;border:none;background:#fff}.vtt-resize-handle{position:absolute;z-index:10}.vtt-resize-handle.vtt-resize-n{top:0;left:10px;right:10px;height:5px;cursor:n-resize}.vtt-resize-handle.vtt-resize-e{top:10px;right:0;bottom:10px;width:5px;cursor:e-resize}.vtt-resize-handle.vtt-resize-s{bottom:0;left:10px;right:10px;height:5px;cursor:s-resize}.vtt-resize-handle.vtt-resize-w{top:10px;left:0;bottom:10px;width:5px;cursor:w-resize}.vtt-resize-handle.vtt-resize-ne{top:0;right:0;width:10px;height:10px;cursor:ne-resize}.vtt-resize-handle.vtt-resize-se{bottom:0;right:0;width:10px;height:10px;cursor:se-resize}.vtt-resize-handle.vtt-resize-sw{bottom:0;left:0;width:10px;height:10px;cursor:sw-resize}.vtt-resize-handle.vtt-resize-nw{top:0;left:0;width:10px;height:10px;cursor:nw-resize}body.vtt-dragging,body.vtt-resizing{-webkit-user-select:none;user-select:none}body.vtt-dragging *,body.vtt-resizing *{cursor:inherit !important}@media (max-width:768px){.vtt-floating-window{width:95vw;height:90vh}.vtt-map-button{bottom:80px}}','',{version:3,sources:['webpack://./src/vtt-floating-window-with-ai/index.scss'],names:[],mappings:'AAGA,gBACE,cAAA,CACA,WAAA,CACA,UAAA,CACA,YAAA,CAEA,YAAA,CACA,kBAAA,CACA,OAAA,CAEA,iBAAA,CACA,0DAAA,CACA,UAAA,CACA,WAAA,CACA,kBAAA,CACA,0CAAA,CAEA,cAAA,CACA,eAAA,CACA,cAAA,CAEA,uBAAA,CAEA,sBACE,0BAAA,CACA,0CAAA,CAGF,uBACE,uBAAA,CAGF,oBACE,UAAA,CACA,WAAA,CAKJ,qBACE,cAAA,CACA,OAAA,CACA,QAAA,CACA,8BAAA,CAEA,UAAA,CACA,WAAA,CACA,gBAAA,CACA,eAAA,CACA,gBAAA,CAEA,kBAAA,CACA,wBAAA,CACA,kBAAA,CACA,qCAAA,CAEA,aAAA,CACA,YAAA,CACA,qBAAA,CAEA,eAAA,CAEA,gCACE,KAAA,CACA,MAAA,CACA,cAAA,CACA,sBAAA,CACA,uBAAA,CACA,eAAA,CACA,cAAA,CAKJ,eACE,iBAAA,CACA,0DAAA,CAEA,YAAA,CACA,6BAAA,CACA,kBAAA,CAEA,WAAA,CACA,wBAAA,CAAA,gBAAA,CAEA,0BACE,YAAA,CACA,kBAAA,CACA,QAAA,CAEA,UAAA,CACA,cAAA,CACA,eAAA,CAEA,8BACE,UAAA,CACA,WAAA,CAIJ,6BACE,YAAA,CACA,OAAA,CAKJ,iBACE,gBAAA,CACA,WAAA,CACA,iBAAA,CAEA,UAAA,CACA,cAAA,CACA,eAAA,CAEA,cAAA,CACA,uBAAA,CAEA,uBACE,qBAAA,CAGF,wBACE,qBAAA,CAGF,kCACE,kBAAA,CAEA,wCACE,kBAAA,CAIJ,oCACE,kBAAA,CAEA,0CACE,kBAAA,CAIJ,+BACE,kBAAA,CAEA,qCACE,kBAAA,CAMN,aACE,MAAA,CACA,iBAAA,CACA,eAAA,CACA,kBAAA,CAEA,uBACE,YAAA,CAKJ,aACE,iBAAA,CACA,KAAA,CACA,MAAA,CACA,UAAA,CACA,WAAA,CAEA,YAAA,CACA,qBAAA,CACA,sBAAA,CACA,kBAAA,CACA,QAAA,CAEA,kBAAA,CACA,UAAA,CACA,SAAA,CAEA,sBACE,UAAA,CACA,WAAA,CACA,qCAAA,CACA,wBAAA,CACA,iBAAA,CACA,iCAAA,CAGF,eACE,QAAA,CACA,cAAA,CACA,aAAA,CAGF,mBACE,cAAA,CACA,UAAA,CAGF,yBACE,cAAA,CAIJ,gBACE,GACE,wBAAA,CAAA,CAKJ,YACE,UAAA,CACA,WAAA,CACA,WAAA,CACA,eAAA,CAIF,mBACE,iBAAA,CACA,UAAA,CAEA,gCACE,KAAA,CACA,SAAA,CACA,UAAA,CACA,UAAA,CACA,eAAA,CAGF,gCACE,QAAA,CACA,OAAA,CACA,WAAA,CACA,SAAA,CACA,eAAA,CAGF,gCACE,QAAA,CACA,SAAA,CACA,UAAA,CACA,UAAA,CACA,eAAA,CAGF,gCACE,QAAA,CACA,MAAA,CACA,WAAA,CACA,SAAA,CACA,eAAA,CAGF,iCACE,KAAA,CACA,OAAA,CACA,UAAA,CACA,WAAA,CACA,gBAAA,CAGF,iCACE,QAAA,CACA,OAAA,CACA,UAAA,CACA,WAAA,CACA,gBAAA,CAGF,iCACE,QAAA,CACA,MAAA,CACA,UAAA,CACA,WAAA,CACA,gBAAA,CAGF,iCACE,KAAA,CACA,MAAA,CACA,UAAA,CACA,WAAA,CACA,gBAAA,CAKJ,oCAEE,wBAAA,CAAA,gBAAA,CAEA,wCACE,yBAAA,CAKJ,yBACE,qBACE,UAAA,CACA,WAAA,CAGF,gBACE,WAAA,CAAA',sourcesContent:['// VTT 地图悬浮窗样式\r\n\r\n// 浮动按钮\r\n.vtt-map-button {\r\n  position: fixed;\r\n  bottom: 20px;\r\n  right: 20px;\r\n  z-index: 9999;\r\n\r\n  display: flex;\r\n  align-items: center;\r\n  gap: 8px;\r\n\r\n  padding: 12px 20px;\r\n  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\r\n  color: white;\r\n  border: none;\r\n  border-radius: 50px;\r\n  box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);\r\n\r\n  font-size: 16px;\r\n  font-weight: 600;\r\n  cursor: pointer;\r\n\r\n  transition: all 0.3s ease;\r\n\r\n  &:hover {\r\n    transform: translateY(-2px);\r\n    box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);\r\n  }\r\n\r\n  &:active {\r\n    transform: translateY(0);\r\n  }\r\n\r\n  svg {\r\n    width: 24px;\r\n    height: 24px;\r\n  }\r\n}\r\n\r\n// 悬浮窗\r\n.vtt-floating-window {\r\n  position: fixed;\r\n  top: 50%;\r\n  left: 50%;\r\n  transform: translate(-50%, -50%);\r\n\r\n  width: 80vw;\r\n  height: 80vh;\r\n  max-width: 1400px;\r\n  min-width: 400px;\r\n  min-height: 300px;\r\n\r\n  background: #1a1a1a;\r\n  border: 2px solid #667eea;\r\n  border-radius: 12px;\r\n  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);\r\n\r\n  z-index: 10000;\r\n  display: flex;\r\n  flex-direction: column;\r\n\r\n  overflow: hidden;\r\n\r\n  &.fullscreen {\r\n    top: 0;\r\n    left: 0;\r\n    transform: none;\r\n    width: 100vw !important;\r\n    height: 100vh !important;\r\n    border-radius: 0;\r\n    max-width: none;\r\n  }\r\n}\r\n\r\n// 标题栏\r\n.vtt-title-bar {\r\n  padding: 12px 20px;\r\n  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\r\n\r\n  display: flex;\r\n  justify-content: space-between;\r\n  align-items: center;\r\n\r\n  cursor: move;\r\n  user-select: none;\r\n\r\n  .vtt-title {\r\n    display: flex;\r\n    align-items: center;\r\n    gap: 10px;\r\n\r\n    color: white;\r\n    font-size: 18px;\r\n    font-weight: 600;\r\n\r\n    svg {\r\n      width: 20px;\r\n      height: 20px;\r\n    }\r\n  }\r\n\r\n  .vtt-controls {\r\n    display: flex;\r\n    gap: 8px;\r\n  }\r\n}\r\n\r\n// 控制按钮\r\n.vtt-control-btn {\r\n  padding: 6px 12px;\r\n  border: none;\r\n  border-radius: 5px;\r\n\r\n  color: white;\r\n  font-size: 14px;\r\n  font-weight: 600;\r\n\r\n  cursor: pointer;\r\n  transition: all 0.2s ease;\r\n\r\n  &:hover {\r\n    transform: scale(1.05);\r\n  }\r\n\r\n  &:active {\r\n    transform: scale(0.95);\r\n  }\r\n\r\n  &.vtt-minimize-btn {\r\n    background: #ff9800;\r\n\r\n    &:hover {\r\n      background: #fb8c00;\r\n    }\r\n  }\r\n\r\n  &.vtt-fullscreen-btn {\r\n    background: #2196f3;\r\n\r\n    &:hover {\r\n      background: #1e88e5;\r\n    }\r\n  }\r\n\r\n  &.vtt-close-btn {\r\n    background: #f44336;\r\n\r\n    &:hover {\r\n      background: #e53935;\r\n    }\r\n  }\r\n}\r\n\r\n// 内容区域\r\n.vtt-content {\r\n  flex: 1;\r\n  position: relative;\r\n  overflow: hidden;\r\n  background: #0a0a0a;\r\n\r\n  &.minimized {\r\n    display: none;\r\n  }\r\n}\r\n\r\n// 加载中\r\n.vtt-loading {\r\n  position: absolute;\r\n  top: 0;\r\n  left: 0;\r\n  width: 100%;\r\n  height: 100%;\r\n\r\n  display: flex;\r\n  flex-direction: column;\r\n  justify-content: center;\r\n  align-items: center;\r\n  gap: 20px;\r\n\r\n  background: #0a0a0a;\r\n  color: white;\r\n  z-index: 1;\r\n\r\n  .spinner {\r\n    width: 50px;\r\n    height: 50px;\r\n    border: 4px solid rgba(102, 126, 234, 0.3);\r\n    border-top-color: #667eea;\r\n    border-radius: 50%;\r\n    animation: spin 1s linear infinite;\r\n  }\r\n\r\n  p {\r\n    margin: 0;\r\n    font-size: 18px;\r\n    color: #667eea;\r\n  }\r\n\r\n  small {\r\n    font-size: 14px;\r\n    color: #999;\r\n  }\r\n\r\n  .error-icon {\r\n    font-size: 50px;\r\n  }\r\n}\r\n\r\n@keyframes spin {\r\n  to {\r\n    transform: rotate(360deg);\r\n  }\r\n}\r\n\r\n// iframe\r\n.vtt-iframe {\r\n  width: 100%;\r\n  height: 100%;\r\n  border: none;\r\n  background: white;\r\n}\r\n\r\n// 调整大小手柄\r\n.vtt-resize-handle {\r\n  position: absolute;\r\n  z-index: 10;\r\n\r\n  &.vtt-resize-n {\r\n    top: 0;\r\n    left: 10px;\r\n    right: 10px;\r\n    height: 5px;\r\n    cursor: n-resize;\r\n  }\r\n\r\n  &.vtt-resize-e {\r\n    top: 10px;\r\n    right: 0;\r\n    bottom: 10px;\r\n    width: 5px;\r\n    cursor: e-resize;\r\n  }\r\n\r\n  &.vtt-resize-s {\r\n    bottom: 0;\r\n    left: 10px;\r\n    right: 10px;\r\n    height: 5px;\r\n    cursor: s-resize;\r\n  }\r\n\r\n  &.vtt-resize-w {\r\n    top: 10px;\r\n    left: 0;\r\n    bottom: 10px;\r\n    width: 5px;\r\n    cursor: w-resize;\r\n  }\r\n\r\n  &.vtt-resize-ne {\r\n    top: 0;\r\n    right: 0;\r\n    width: 10px;\r\n    height: 10px;\r\n    cursor: ne-resize;\r\n  }\r\n\r\n  &.vtt-resize-se {\r\n    bottom: 0;\r\n    right: 0;\r\n    width: 10px;\r\n    height: 10px;\r\n    cursor: se-resize;\r\n  }\r\n\r\n  &.vtt-resize-sw {\r\n    bottom: 0;\r\n    left: 0;\r\n    width: 10px;\r\n    height: 10px;\r\n    cursor: sw-resize;\r\n  }\r\n\r\n  &.vtt-resize-nw {\r\n    top: 0;\r\n    left: 0;\r\n    width: 10px;\r\n    height: 10px;\r\n    cursor: nw-resize;\r\n  }\r\n}\r\n\r\n// 拖动和调整大小时的样式\r\nbody.vtt-dragging,\r\nbody.vtt-resizing {\r\n  user-select: none;\r\n\r\n  * {\r\n    cursor: inherit !important;\r\n  }\r\n}\r\n\r\n// 响应式\r\n@media (max-width: 768px) {\r\n  .vtt-floating-window {\r\n    width: 95vw;\r\n    height: 90vh;\r\n  }\r\n\r\n  .vtt-map-button {\r\n    bottom: 80px; // 避免遮挡移动端输入框\r\n  }\r\n}\r\n'],sourceRoot:''}]);const i=s},699:t=>{t.exports=function(t,n){if(n.styleSheet)n.styleSheet.cssText=t;else{for(;n.firstChild;)n.removeChild(n.firstChild);n.appendChild(document.createTextNode(t))}}},714:(t,n,e)=>{t.exports=function(t){var n=e.nc;n&&t.setAttribute('nonce',n)}},790:t=>{t.exports=function(t){var n=t[1],e=t[3];if(!e)return n;if('function'==typeof btoa){var r=btoa(unescape(encodeURIComponent(JSON.stringify(e)))),o='sourceMappingURL=data:application/json;charset=utf-8;base64,'.concat(r),a='/*# '.concat(o,' */');return[n].concat([a]).join('\n')}return[n].join('\n')}},881:t=>{var n={};t.exports=function(t,e){var r=function(t){if(void 0===n[t]){var e=document.querySelector(t);if(window.HTMLIFrameElement&&e instanceof window.HTMLIFrameElement)try{e=e.contentDocument.head}catch(t){e=null}n[t]=e}return n[t]}(t);if(!r)throw new Error('Couldn\'t find a style target. This probably means that the value for the \'insert\' parameter is invalid.');r.appendChild(e)}}},n={};function e(r){var o=n[r];if(void 0!==o)return o.exports;var a=n[r]={id:r,exports:{}};return t[r](a,a.exports,e),a.exports}e.n=t=>{var n=t&&t.__esModule?()=>t.default:()=>t;return e.d(n,{a:n}),n},e.d=(t,n)=>{for(var r in n)e.o(n,r)&&!e.o(t,r)&&Object.defineProperty(t,r,{enumerable:!0,get:n[r]})},e.o=(t,n)=>Object.prototype.hasOwnProperty.call(t,n),e.nc=void 0;const r=z,o=r.z.object({action:r.z.enum(['move_token','open_door','close_door','toggle_light','reveal_area','spawn_token','remove_token','play_sound','chat_message','roll_dice','trigger_event']),params:r.z.record(r.z.any()),description:r.z.string().optional()}),a=r.z.object({narrative:r.z.string(),commands:r.z.array(o),context:r.z.record(r.z.any()).optional()});class s{mapState;context;commandQueue=[];executing=!1;constructor(){this.mapState=this.loadMapState(),this.context=this.loadContext()}async handlePlayerInput(t){try{const n=function(t,n){return`你是一个 TRPG 游戏的 GM（Game Master），需要根据玩家的行动来控制虚拟桌面（VTT）地图。\n\n## 当前地图状态\n\n地图名称: ${n.mapName}\n当前房间: ${n.currentRoom}\n\n玩家位置: (${n.playerToken.x}, ${n.playerToken.y})\n玩家视野范围: ${n.playerToken.vision} 格\n\n可见的门:\n${n.visibleDoors.map(t=>`- ${t.name}: ${1===t.state?'开启':'关闭'} (位置: ${t.x}, ${t.y})`).join('\n')}\n\n可见的物品:\n${n.visibleItems.map(t=>`- ${t.name} (位置: ${t.x}, ${t.y})`).join('\n')}\n\n附近的 NPC:\n${n.nearbyNPCs.map(t=>`- ${t.name} (位置: ${t.x}, ${t.y})`).join('\n')}\n\n## 玩家输入\n\n"${t}"\n\n## 你的任务\n\n1. 理解玩家的意图\n2. 生成叙述文本（描述场景变化）\n3. 生成控制指令（移动 Token、开门等）\n\n## 可用指令\n\n### 移动 Token\n\`\`\`json\n{\n  "action": "move_token",\n  "params": {\n    "tokenId": "player1",\n    "x": 目标X坐标,\n    "y": 目标Y坐标,\n    "animated": true  // 是否播放移动动画\n  }\n}\n\`\`\`\n\n### 开门/关门\n\`\`\`json\n{\n  "action": "open_door",\n  "params": {\n    "doorId": "door_1"\n  }\n}\n\`\`\`\n\n### 揭示区域（移除战争迷雾）\n\`\`\`json\n{\n  "action": "reveal_area",\n  "params": {\n    "roomId": "room_left",\n    "permanent": true  // 是否永久揭示\n  }\n}\n\`\`\`\n\n### 生成 NPC/怪物\n\`\`\`json\n{\n  "action": "spawn_token",\n  "params": {\n    "type": "npc",\n    "name": "哥布林战士",\n    "x": 坐标,\n    "y": 坐标,\n    "image": "路径（可选）",\n    "stats": {\n      "hp": 20,\n      "ac": 14\n    }\n  }\n}\n\`\`\`\n\n### 播放音效\n\`\`\`json\n{\n  "action": "play_sound",\n  "params": {\n    "soundId": "door_creak",\n    "volume": 0.5\n  }\n}\n\`\`\`\n\n### 发送系统消息\n\`\`\`json\n{\n  "action": "chat_message",\n  "params": {\n    "type": "system",\n    "message": "你听到远处传来奇怪的声音..."\n  }\n}\n\`\`\`\n\n## 响应格式\n\n请以 JSON 格式返回，包含以下字段：\n\n\`\`\`json\n{\n  "narrative": "你推开厚重的木门，门轴发出刺耳的吱呀声。门后是一个昏暗的房间，你隐约看到房间中央有一个木箱。",\n  "commands": [\n    {\n      "action": "open_door",\n      "params": { "doorId": "door_1" },\n      "description": "打开左边的门"\n    },\n    {\n      "action": "play_sound",\n      "params": { "soundId": "door_creak", "volume": 0.5 },\n      "description": "播放开门音效"\n    },\n    {\n      "action": "move_token",\n      "params": { "tokenId": "player1", "x": 1500, "y": 1000, "animated": true },\n      "description": "玩家进入房间"\n    },\n    {\n      "action": "reveal_area",\n      "params": { "roomId": "room_left", "permanent": true },\n      "description": "揭示房间内部"\n    }\n  ],\n  "context": {\n    "currentRoom": "room_left",\n    "discoveredRooms": ["entrance", "room_left"]\n  }\n}\n\`\`\`\n\n请根据玩家的输入生成合适的响应。只返回 JSON，不要有其他文字。`}(t,this.getMapContext()),e=await this.callAI(n),r=this.parseAIResponse(e);return await this.executeCommands(r.commands),r.context&&this.updateContext(r.context),{narrative:r.narrative,success:!0}}catch(t){return console.error('AI-GM 处理失败:',t),{narrative:'抱歉，我无法理解你的意图。请换一种方式描述。',success:!1}}}async callAI(t){try{console.log('[AI-GM] 正在调用 AI...');const n=`${'你是一个专业的 TRPG GM，需要根据玩家输入生成 VTT 控制指令。始终以 JSON 格式返回。'}\n\n${t}`,e=await triggerSlash(`/genraw length=1500 ${n}`,{source:'ai-gm'});return console.log('[AI-GM] AI 响应:',e),e||''}catch(t){throw console.error('[AI-GM] API 调用失败:',t),new Error('无法连接到 AI 服务，请检查酒馆的 API 配置是否正确')}}parseAIResponse(t){const n=t.match(/```json\n?([\s\S]*?)\n?```/)||t.match(/\{[\s\S]*\}/);if(!n)throw new Error('AI 响应格式错误：未找到有效的 JSON');const e=n[1]||n[0],r=JSON.parse(e);return a.parse(r)}async executeCommands(t){if(this.commandQueue.push(...t),!this.executing){this.executing=!0;try{for(;this.commandQueue.length>0;){const t=this.commandQueue.shift();await this.executeCommand(t),await this.sleep(500)}}finally{this.executing=!1}}}async executeCommand(t){switch(console.log(`🎬 执行指令: ${t.action}`,t.params),t.action){case'move_token':await this.moveToken(t.params);break;case'open_door':await this.openDoor(t.params);break;case'close_door':await this.closeDoor(t.params);break;case'toggle_light':await this.toggleLight(t.params);break;case'reveal_area':await this.revealArea(t.params);break;case'spawn_token':await this.spawnToken(t.params);break;case'remove_token':await this.removeToken(t.params);break;case'play_sound':await this.playSound(t.params);break;case'chat_message':await this.sendChatMessage(t.params);break;case'roll_dice':await this.rollDice(t.params);break;case'trigger_event':await this.triggerEvent(t.params);break;default:console.warn(`未知指令: ${t.action}`)}}async moveToken(t){const{tokenId:n,x:e,y:r,animated:o=!0}=t,a=this.loadMapState(),s=a.tokens.find(t=>t.id===n);s?(s.x=e,s.y=r,this.saveMapState(a),this.notifyMapUpdate()):console.warn(`Token ${n} 不存在`)}async openDoor(t){const{doorId:n}=t,e=this.loadMapState(),r=e.walls.find(t=>t.id===n||1===t.door);r?(r.ds=1,this.saveMapState(e),this.notifyMapUpdate()):console.warn(`门 ${n} 不存在`)}async closeDoor(t){const{doorId:n}=t,e=this.loadMapState(),r=e.walls.find(t=>t.id===n);r&&(r.ds=0,this.saveMapState(e),this.notifyMapUpdate())}async toggleLight(t){const{lightId:n,enabled:e}=t,r=this.loadMapState(),o=r.lights.find(t=>t.id===n);o&&(o.enabled=e??!o.enabled,this.saveMapState(r),this.notifyMapUpdate())}async revealArea(t){const{roomId:n,x:e,y:r,width:o,height:a,permanent:s=!0}=t;console.log(`揭示区域: ${n}`),this.notifyMapUpdate()}async spawnToken(t){const{type:n,name:e,x:r,y:o,image:a,stats:s}=t,i=this.loadMapState(),A={id:`token_${Date.now()}`,name:e||'未命名',x:r,y:o,width:1,height:1,vision:'monster'===n?0:12,image:a,stats:s||{}};i.tokens.push(A),this.saveMapState(i),this.notifyMapUpdate()}async removeToken(t){const{tokenId:n}=t,e=this.loadMapState();e.tokens=e.tokens.filter(t=>t.id!==n),this.saveMapState(e),this.notifyMapUpdate()}async playSound(t){const{soundId:n,volume:e=.5}=t;console.log(`播放音效: ${n} (音量: ${e})`)}async sendChatMessage(t){const{type:n='system',message:e}=t;toastr.info(e,'system'===n?'系统':'GM')}async rollDice(t){const{formula:n,reason:e}=t;console.log(`掷骰: ${n} (${e})`)}async triggerEvent(t){const{eventId:n,data:e}=t;console.log(`触发事件: ${n}`,e)}getMapContext(){const t=this.loadMapState();return{mapName:t.name||'未命名地图',currentRoom:this.context.currentRoom||'unknown',playerToken:t.tokens.find(t=>'player1'===t.id)||{},visibleDoors:this.getVisibleDoors(t),visibleItems:this.getVisibleItems(t),nearbyNPCs:this.getNearbyNPCs(t)}}getVisibleDoors(t){return t.walls.filter(t=>t.door>0).map((t,n)=>({id:t.id||`door_${n}`,name:`门 ${n+1}`,state:t.ds,x:t.c[0],y:t.c[1]}))}getVisibleItems(t){return[]}getNearbyNPCs(t){return t.tokens.filter(t=>'player1'!==t.id)}loadMapState(){return getVariables({type:'script',script_id:getScriptId()}).vtt_map_data||{tokens:[],walls:[],lights:[]}}saveMapState(t){replaceVariables({vtt_map_data:t},{type:'script',script_id:getScriptId()})}loadContext(){return getVariables({type:'script',script_id:getScriptId()}).ai_gm_context||{currentRoom:'entrance',discoveredRooms:[]}}updateContext(t){this.context={...this.context,...t},replaceVariables({ai_gm_context:this.context},{type:'script',script_id:getScriptId()})}notifyMapUpdate(){window.dispatchEvent(new CustomEvent('vtt-map-update'))}sleep(t){return new Promise(n=>setTimeout(n,t))}}var i=e(234),A=e.n(i),l=e(219),c=e.n(l),d=e(881),p=e.n(d),h=e(714),g=e.n(h),u=e(134),C=e.n(u),m=e(699),f=e.n(m),v=e(387),x={};x.styleTagTransform=f(),x.setAttributes=g(),x.insert=p().bind(null,'head'),x.domAPI=c(),x.insertStyleElement=C();A()(v.A,x);v.A&&v.A.locals&&v.A.locals,r.z.object({tokenId:r.z.string(),name:r.z.string(),avatar:r.z.string().optional(),hp:r.z.number().optional(),maxHp:r.z.number().optional(),mp:r.z.number().optional(),maxMp:r.z.number().optional(),stats:r.z.record(r.z.any()).optional(),conditions:r.z.array(r.z.string()).optional(),customData:r.z.record(r.z.any()).optional()});class b{statusCache=new Map;mvuInitialized=!1;updateInterval=null;constructor(){this.initializeMvu(),this.setupMessageListener()}async initializeMvu(){try{await waitGlobalInitialized('Mvu'),this.mvuInitialized=!0,console.log('[MVU Token] MVU 初始化成功'),this.setupMvuListeners(),this.startAutoUpdate()}catch(t){console.error('[MVU Token] MVU 初始化失败:',t),toastr.warning('MVU 未安装，Token 状态栏将无法显示数据')}}setupMvuListeners(){this.mvuInitialized&&(eventOn(Mvu.events.VARIABLE_UPDATE_ENDED,t=>{console.log('[MVU Token] 变量更新，刷新所有 Token 状态'),this.refreshAllTokens()}),eventOn(Mvu.events.SINGLE_VARIABLE_UPDATED,(t,n,e,r)=>{if(n.startsWith('角色.')||n.startsWith('characters.')){console.log(`[MVU Token] 角色变量更新: ${n}`);const t=this.extractCharacterName(n);t&&this.updateTokenByName(t)}}))}extractCharacterName(t){const n=t.match(/^(?:角色|characters)\.([^.]+)\./);return n?n[1]:null}setupMessageListener(){window.addEventListener('message',t=>{const n=$('#vtt-floating-window iframe')[0];if(!n||t.source!==n.contentWindow)return;const{type:e,tokenId:r}=t.data;switch(e){case'request-token-status':this.sendTokenStatus(r);break;case'request-all-tokens':this.sendAllTokens()}})}startAutoUpdate(){this.updateInterval=window.setInterval(()=>{this.refreshAllTokens()},5e3)}stopAutoUpdate(){null!==this.updateInterval&&(clearInterval(this.updateInterval),this.updateInterval=null)}async getTokenStatus(t){if(!this.mvuInitialized)return null;try{const n=Mvu.getMvuData({type:'message',message_id:'latest'}),e=this.findCharacterData(n.stat_data,t);if(!e)return console.warn(`[MVU Token] 未找到 Token ${t} 的数据`),null;const r={tokenId:t,name:e.name||e.名称||t,avatar:e.avatar||e.头像,hp:e.hp||e.生命值||e.HP,maxHp:e.maxHp||e.最大生命值||e.最大HP,mp:e.mp||e.魔法值||e.MP,maxMp:e.maxMp||e.最大魔法值||e.最大MP,stats:{力量:e.力量||e.STR||e.strength,敏捷:e.敏捷||e.DEX||e.dexterity,体质:e.体质||e.CON||e.constitution,智力:e.智力||e.INT||e.intelligence,感知:e.感知||e.WIS||e.wisdom,魅力:e.魅力||e.CHA||e.charisma},conditions:e.conditions||e.状态效果||[],customData:e.customData||{}};return this.statusCache.set(t,r),r}catch(n){return console.error(`[MVU Token] 获取 Token ${t} 状态失败:`,n),null}}findCharacterData(t,n){const e=[`角色.${n}`,`characters.${n}`,`tokens.${n}`,`玩家.${n}`,`players.${n}`];for(const n of e){const e=_.get(t,n);if(e)return e}const r=_.get(t,'角色')||_.get(t,'characters')||{};for(const[t,e]of Object.entries(r))if('object'==typeof e&&null!==e&&(e.id===n||t===n||e.name===n))return e;return null}async sendTokenStatus(t){const n=await this.getTokenStatus(t),e=$('#vtt-floating-window iframe')[0];e&&e.contentWindow&&e.contentWindow.postMessage({type:'token-status-update',tokenId:t,status:n},'*')}async sendAllTokens(){if(this.mvuInitialized)try{const t=Mvu.getMvuData({type:'message',message_id:'latest'}).stat_data,n=_.get(t,'角色')||_.get(t,'characters')||{},e={};for(const[t,r]of Object.entries(n))if('object'==typeof r&&null!==r){const n=await this.getTokenStatus(t);n&&(e[t]=n)}const r=$('#vtt-floating-window iframe')[0];if(!r||!r.contentWindow)return;r.contentWindow.postMessage({type:'all-tokens-status',statuses:e},'*')}catch(t){console.error('[MVU Token] 发送所有 Token 状态失败:',t)}}refreshAllTokens(){this.sendAllTokens()}updateTokenByName(t){this.sendTokenStatus(t)}async refreshToken(t){await this.sendTokenStatus(t)}destroy(){this.stopAutoUpdate(),this.statusCache.clear()}}const w='https://yyk9137.github.io/my-vtt-maps/vtt-map-viewer/index.html';let y=null,T=null;function k(){console.log('[VTT悬浮窗+AI] 开始初始化...'),toastr.success('🗺️ VTT 地图悬浮窗（AI 增强版）已加载');try{console.log('[VTT悬浮窗+AI] 正在创建浮动按钮...'),function(){if($('#vtt-map-button').length>0)return void console.log('[VTT悬浮窗+AI] 地图按钮已存在，跳过创建');const t=$('<button>').attr('id','vtt-map-button').attr('title','打开 VTT 地图 (Ctrl+M)').addClass('vtt-map-button').css({position:'fixed',bottom:'20px',right:'20px',zIndex:9999,display:'flex',alignItems:'center',gap:'8px',padding:'12px 20px',background:'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',color:'white',border:'none',borderRadius:'50px',boxShadow:'0 4px 15px rgba(102, 126, 234, 0.4)',fontSize:'16px',fontWeight:'600',cursor:'pointer',transition:'all 0.3s ease'}).html('\n      <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">\n        <path d="M20.5 3l-.16.03L15 5.1 9 3 3.36 4.9c-.21.07-.36.25-.36.48V20.5c0 .28.22.5.5.5l.16-.03L9 18.9l6 2.1 5.64-1.9c.21-.07.36-.25.36-.48V3.5c0-.28-.22-.5-.5-.5zM15 19l-6-2.11V5l6 2.11V19z"/>\n      </svg>\n      <span>地图</span>\n    ').on('click',()=>{console.log('[VTT悬浮窗+AI] 地图按钮被点击'),M()}).hover(function(){$(this).css({transform:'translateY(-2px)',boxShadow:'0 6px 20px rgba(102, 126, 234, 0.6)'})},function(){$(this).css({transform:'translateY(0)',boxShadow:'0 4px 15px rgba(102, 126, 234, 0.4)'})});$('body').append(t),console.log('[VTT悬浮窗+AI] 地图按钮已添加到页面，ID:',t.attr('id'))}(),console.log('[VTT悬浮窗+AI] ✅ 浮动按钮创建成功'),console.log('[VTT悬浮窗+AI] 正在注册快捷键...'),$(document).on('keydown',t=>{t.ctrlKey&&'m'===t.key&&(t.preventDefault(),console.log('[VTT悬浮窗+AI] 快捷键 Ctrl+M 触发'),M())}),console.log('[VTT悬浮窗+AI] ✅ 快捷键注册成功'),console.log('[VTT悬浮窗+AI] 正在初始化 AI-GM 控制器...'),y=new s,console.log('[VTT悬浮窗+AI] ✅ AI-GM 控制器初始化成功'),console.log('[VTT悬浮窗+AI] 正在注册消息监听...'),console.log('[VTT悬浮窗+AI] ⚠️ AI 自动处理已禁用（需要配置 API）'),function(){if($('#ai-gm-control-btn').length>0)return;const t=$('<button>').attr('id','ai-gm-control-btn').attr('title','让 AI 根据最后一条消息控制地图').css({position:'fixed',bottom:'20px',right:'140px',zIndex:9999,display:'flex',alignItems:'center',gap:'8px',padding:'12px 20px',background:'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',color:'white',border:'none',borderRadius:'50px',boxShadow:'0 4px 15px rgba(240, 147, 251, 0.4)',fontSize:'16px',fontWeight:'600',cursor:'pointer',transition:'all 0.3s ease'}).html('🤖 AI-GM').on('click',async()=>{t.prop('disabled',!0).html('⏳ 处理中...');try{const t=function(){try{const t=getChatMessages(-1);if(console.log('[AI-GM] 获取聊天消息:',t),!t||!Array.isArray(t)||0===t.length)return console.warn('[AI-GM] 没有聊天消息'),null;const n=t[0];if(n&&n.is_user&&n.message)return console.log('[AI-GM] 找到用户消息:',n.message),n.message;const e=getChatMessages('0-'+getLastMessageId(),{role:'user'});if(e&&e.length>0){const t=e[e.length-1];return console.log('[AI-GM] 找到用户消息:',t.message),t.message}return console.warn('[AI-GM] 没有找到用户消息'),null}catch(t){return console.error('[AI-GM] 获取消息失败:',t),null}}();if(!t)return void toastr.warning('没有找到最近的用户消息');console.log('[AI-GM] 处理用户输入:',t);const e=await y.handlePlayerInput(t);e.success?(toastr.success('✅ AI 已执行动作'),n=e.narrative,triggerSlash('/echo '+n,{source:'ai-gm'}),I()):toastr.error('❌ AI 处理失败')}catch(t){console.error('[AI-GM] 错误:',t),toastr.error('AI 处理出错，请查看控制台')}finally{t.prop('disabled',!1).html('🤖 AI-GM')}var n}).hover(function(){$(this).css({transform:'translateY(-2px)',boxShadow:'0 6px 20px rgba(240, 147, 251, 0.6)'})},function(){$(this).css({transform:'translateY(0)',boxShadow:'0 4px 15px rgba(240, 147, 251, 0.4)'})});$('body').append(t)}(),console.log('[VTT悬浮窗+AI] 正在初始化 MVU Token 状态管理器...'),T=new b,console.log('[VTT悬浮窗+AI] ✅ MVU Token 状态管理器初始化成功'),console.log('[VTT悬浮窗+AI] ✅ 初始化完成！')}catch(t){console.error('[VTT悬浮窗+AI] ❌ 初始化失败:',t),toastr.error('VTT 悬浮窗初始化失败，请查看控制台')}}function I(){const t=$('#vtt-floating-window iframe');if(t.length>0){const n=t[0].contentWindow;n?.postMessage({type:'vtt-map-refresh'},'*')}}function M(){console.log('[VTT悬浮窗+AI] toggleVTTWindow 被调用');const t=$('#vtt-floating-window');if(console.log('[VTT悬浮窗+AI] 查找现有窗口，找到:',t.length,'个'),t.length>0){const n=t.is(':visible');console.log('[VTT悬浮窗+AI] 窗口当前可见:',n),n?(console.log('[VTT悬浮窗+AI] 隐藏窗口'),t.hide()):(console.log('[VTT悬浮窗+AI] 显示窗口'),t.show())}else console.log('[VTT悬浮窗+AI] 创建新窗口'),function(){console.log('[VTT悬浮窗+AI] 开始创建窗口 DOM 结构...');const t=$('<div>').attr('id','vtt-floating-window').addClass('vtt-floating-window').css({position:'fixed',top:'50%',left:'50%',transform:'translate(-50%, -50%)',width:'80vw',height:'80vh',maxWidth:'1400px',minWidth:'400px',minHeight:'300px',background:'#1a1a1a',border:'2px solid #667eea',borderRadius:'12px',boxShadow:'0 10px 40px rgba(0, 0, 0, 0.5)',zIndex:1e4,display:'flex',flexDirection:'column',overflow:'hidden'}),n=$('<div>').addClass('vtt-title-bar').css({padding:'12px 20px',background:'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',display:'flex',justifyContent:'space-between',alignItems:'center',cursor:'move',userSelect:'none'}),e=$('<div>').addClass('vtt-title').css({display:'flex',alignItems:'center',gap:'10px',color:'white',fontSize:'18px',fontWeight:'600'}).html('\n      <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">\n        <path d="M20.5 3l-.16.03L15 5.1 9 3 3.36 4.9c-.21.07-.36.25-.36.48V20.5c0 .28.22.5.5.5l.16-.03L9 18.9l6 2.1 5.64-1.9c.21-.07.36-.25.36-.48V3.5c0-.28-.22-.5-.5-.5zM15 19l-6-2.11V5l6 2.11V19z"/>\n      </svg>\n      <span>VTT 地图查看器 (AI 增强)</span>\n    '),r=$('<div>').addClass('vtt-controls').css({display:'flex',gap:'8px'}),o={padding:'6px 12px',border:'none',borderRadius:'5px',color:'white',fontSize:'14px',fontWeight:'600',cursor:'pointer',transition:'all 0.2s ease'},a=$('<button>').addClass('vtt-control-btn vtt-minimize-btn').attr('title','最小化').css({...o,background:'#ff9800'}).html('➖').on('click',()=>{const n=t.find('.vtt-content');n.hasClass('minimized')?(n.removeClass('minimized').show(),t.css('height','80vh'),a.html('➖')):(n.addClass('minimized').hide(),t.css('height','auto'),a.html('⬜'))}),s=$('<button>').addClass('vtt-control-btn vtt-fullscreen-btn').attr('title','全屏').css({...o,background:'#2196f3'}).html('⛶').on('click',()=>{t.hasClass('fullscreen')?(t.removeClass('fullscreen'),t.css({top:'50%',left:'50%',transform:'translate(-50%, -50%)',width:'80vw',height:'80vh',borderRadius:'12px'}),s.html('⛶')):(t.addClass('fullscreen'),t.css({top:'0',left:'0',transform:'none',width:'100vw',height:'100vh',borderRadius:'0'}),s.html('🗗'))}),i=$('<button>').addClass('vtt-control-btn vtt-close-btn').attr('title','关闭 (Esc)').css({...o,background:'#f44336'}).html('❌').on('click',()=>{t.hide()});r.append(a,s,i),n.append(e,r);const A=$('<div>').addClass('vtt-content').css({flex:'1',position:'relative',overflow:'hidden',background:'#0a0a0a'}),l=$('<div>').addClass('vtt-loading').css({position:'absolute',top:'0',left:'0',width:'100%',height:'100%',display:'flex',flexDirection:'column',justifyContent:'center',alignItems:'center',gap:'20px',background:'#0a0a0a',color:'white',zIndex:'1'}).html('\n      <div class="spinner" style="width: 50px; height: 50px; border: 4px solid rgba(102, 126, 234, 0.3); border-top-color: #667eea; border-radius: 50%; animation: spin 1s linear infinite;"></div>\n      <p style="margin: 0; font-size: 18px; color: #667eea;">正在加载 VTT 地图...</p>\n    '),c=$('<iframe>').addClass('vtt-iframe').attr('src',w).attr('allow','fullscreen').css({width:'100%',height:'100%',border:'none',background:'white'}).on('load',()=>{l.fadeOut(),toastr.success('🗺️ 地图加载完成')}).on('error',()=>{l.html('\n        <div class="error-icon" style="font-size: 50px;">⚠️</div>\n        <p style="margin: 0; font-size: 18px;">地图加载失败</p>\n        <small style="font-size: 14px; color: #999;">请检查 URL 是否正确</small>\n      '),toastr.error('❌ 地图加载失败')});A.append(l,c),t.append(n,A),console.log('[VTT悬浮窗+AI] 窗口 DOM 结构创建完成，准备添加到页面...'),$('#vtt-spin-animation').length||$('<style>').attr('id','vtt-spin-animation').text('@keyframes spin { to { transform: rotate(360deg); } }').appendTo('head');$('body').append(t),console.log('[VTT悬浮窗+AI] 窗口已添加到页面');const d=$('#vtt-floating-window');console.log('[VTT悬浮窗+AI] 验证窗口存在:',d.length),console.log('[VTT悬浮窗+AI] 窗口可见性:',d.is(':visible')),console.log('[VTT悬浮窗+AI] 窗口 display:',d.css('display')),console.log('[VTT悬浮窗+AI] 窗口 opacity:',d.css('opacity')),function(t,n){let e=!1,r=0,o=0;n.on('mousedown',a=>{if($(a.target).closest('.vtt-control-btn').length>0)return;e=!0;const s=t.offset();r=a.pageX-s.left,o=a.pageY-s.top,n.css('cursor','grabbing'),$('body').addClass('vtt-dragging')}),$(document).on('mousemove.vtt-drag',n=>{if(e&&!t.hasClass('fullscreen')){const e=n.pageX-r,a=n.pageY-o,s=$(window).width()-t.outerWidth(),i=$(window).height()-t.outerHeight();t.css({left:Math.max(0,Math.min(e,s))+'px',top:Math.max(0,Math.min(a,i))+'px',transform:'none'})}}),$(document).on('mouseup.vtt-drag',()=>{e&&(e=!1,n.css('cursor','move'),$('body').removeClass('vtt-dragging'))})}(t,n),function(t){['n','e','s','w','ne','se','sw','nw'].forEach(n=>{const e=$('<div>').addClass(`vtt-resize-handle vtt-resize-${n}`).attr('data-direction',n);t.append(e)});let n=!1,e='',r=0,o=0,a=0,s=0,i=0,A=0;t.find('.vtt-resize-handle').on('mousedown',l=>{t.hasClass('fullscreen')||(n=!0,e=$(l.currentTarget).attr('data-direction'),r=l.pageX,o=l.pageY,a=t.width(),s=t.height(),i=t.offset().left,A=t.offset().top,$('body').addClass('vtt-resizing'),l.preventDefault())}),$(document).on('mousemove.vtt-resize',l=>{if(n){const n=l.pageX-r,c=l.pageY-o;let d=a,p=s,h=i,g=A;e.includes('e')&&(d=a+n),e.includes('w')&&(d=a-n,h=i+n),e.includes('s')&&(p=s+c),e.includes('n')&&(p=s-c,g=A+c),d=Math.max(400,d),p=Math.max(300,p),t.css({width:d+'px',height:p+'px',left:h+'px',top:g+'px'})}}),$(document).on('mouseup.vtt-resize',()=>{n&&(n=!1,$('body').removeClass('vtt-resizing'))})}(t),$(document).on('keydown.vtt-window',n=>{'Escape'===n.key&&t.is(':visible')&&t.hide()}),console.log('[VTT悬浮窗+AI] 开始显示窗口...'),t.show().css({display:'flex',opacity:'1',visibility:'visible'}),console.log('[VTT悬浮窗+AI] ✅ 窗口创建完成！'),setTimeout(()=>{const t=$('#vtt-floating-window'),n=t.is(':visible');console.log('[VTT悬浮窗+AI] 🔍 最终验证:'),console.log('  - 存在:',t.length),console.log('  - 可见:',n),console.log('  - display:',t.css('display')),n||(console.warn('[VTT悬浮窗+AI] ⚠️ 窗口不可见，强制显示...'),t.show().css('display','flex'),toastr.warning('地图窗口已强制显示'));const e=t[0]?.getBoundingClientRect();e&&(console.log('  - 实际尺寸:',e.width,'x',e.height),0!==e.width&&0!==e.height||console.error('[VTT悬浮窗+AI] ❌ 窗口尺寸为0！'))},500)}()}$(window).on('pagehide',()=>{$('#vtt-map-button').remove(),$('#vtt-floating-window').remove(),$('#ai-gm-control-btn').remove(),T&&(T.destroy(),T=null),toastr.info('🗺️ VTT 地图悬浮窗已卸载')}),console.log('[VTT悬浮窗+AI] document.readyState:',document.readyState),'loading'===document.readyState?(console.log('[VTT悬浮窗+AI] DOM 加载中，等待 ready 事件...'),$(k)):(console.log('[VTT悬浮窗+AI] DOM 已就绪，立即初始化'),k())})();
//# sourceMappingURL=index.js.map
